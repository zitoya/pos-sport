<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS POS Sport - Prototype Dark</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"></script>

    <style>
        /* Styles pour le mode Dark */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #2d3748; } /* gray-800 */
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 3px; } /* gray-600 */
        ::-webkit-scrollbar-thumb:hover { background: #718096; } /* gray-500 */
        .no-select { user-select: none; }

        /* Styles d'impression du ticket */
        @media print {
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                background: white;
                color: black;
                width: 80mm;
                margin: 0 auto;
            }

            .print-ticket {
                width: 80mm;
                background: white;
                color: black;
                padding: 5mm;
                font-family: 'Courier New', monospace;
                font-size: 12px;
                line-height: 1.4;
            }

            .print-ticket .ticket-header {
                text-align: center;
                border-bottom: 1px dashed black;
                padding-bottom: 5mm;
                margin-bottom: 5mm;
            }

            .print-ticket .ticket-title {
                font-size: 16px;
                font-weight: bold;
                margin-bottom: 2mm;
            }

            .print-ticket .ticket-line {
                display: flex;
                justify-content: space-between;
                padding: 2mm 0;
                border-bottom: 1px dotted #ccc;
            }

            .print-ticket .ticket-total {
                font-weight: bold;
                font-size: 14px;
                margin-top: 3mm;
                padding-top: 3mm;
                border-top: 1px solid black;
                display: flex;
                justify-content: space-between;
            }

            .print-ticket .ticket-footer {
                text-align: center;
                font-size: 10px;
                margin-top: 5mm;
                padding-top: 5mm;
                border-top: 1px dashed black;
            }

            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-900 h-screen w-screen overflow-hidden text-white">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- INITIALISATION FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCJbnlwr0mawraiMZg5bxhJAGTU50Athk4",
            authDomain: "pos-sport.firebaseapp.com",
            projectId: "pos-sport",
            storageBucket: "pos-sport.firebasestorage.app",
            messagingSenderId: "1097156311402",
            appId: "1:1097156311402:web:46ba58865996e471b70d13",
            measurementId: "G-NVM7ZNZZYB"
        };

        let db = null;
        try {
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore(app);
            console.log('‚úÖ Firebase initialis√© avec succ√®s');
        } catch (error) {
            console.warn('‚ö†Ô∏è Firebase non disponible (mode hors ligne):', error.message);
        }

        // --- FONCTIONS DE SAUVEGARDE FIRESTORE ---
        const saveToFirestore = async (collection, data) => {
            if (!db) {
                console.warn('Firebase non disponible, donn√©es sauvegard√©es localement');
                return;
            }
            try {
                await db.collection(collection).add({
                    ...data,
                    timestamp: new Date()
                });
                console.log(`‚úÖ ${collection} sauvegard√© dans Firestore`);
            } catch (error) {
                console.error(`‚ùå Erreur Firestore ${collection}:`, error);
            }
        };

        const updateFirestore = async (collection, docId, data) => {
            if (!db) return;
            try {
                await db.collection(collection).doc(docId).update(data);
                console.log(`‚úÖ ${collection} mis √† jour`);
            } catch (error) {
                console.error(`‚ùå Erreur mise √† jour ${collection}:`, error);
            }
        };

        // --- COMPOSANT MODALE AJOUT ARTICLE EN VENTE ---
        const AddSaleModal = ({ isOpen, onClose, onAddItem }) => {
            const [name, setName] = useState('');
            const [price, setPrice] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name || !price) {
                    alert('Veuillez remplir tous les champs');
                    return;
                }
                onAddItem(name, price);
                setName('');
                setPrice('');
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                    <div className="bg-gray-800 rounded-xl p-8 w-full max-w-md shadow-2xl border border-gray-700">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">Ajouter Article en Vente</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">‚úï</button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-300 mb-2">Nom de l'article *</label>
                                <input 
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    placeholder="Ex: Bonnet Laine"
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-gray-300 mb-2">Prix (‚Ç¨) *</label>
                                <input 
                                    type="number"
                                    step="0.01"
                                    value={price}
                                    onChange={(e) => setPrice(e.target.value)}
                                    placeholder="Ex: 29.99"
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    required
                                />
                            </div>

                            <div className="flex space-x-4 pt-6 border-t border-gray-700">
                                <button type="submit" className="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                    Ajouter
                                </button>
                                <button type="button" onClick={onClose} className="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">
                                    Annuler
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- COMPOSANT MODALE AJOUT ARTICLE EN LOCATION ---
        const AddRentalModal = ({ isOpen, onClose, onAddItem }) => {
            const [name, setName] = useState('');
            const [priceFullDay, setPriceFullDay] = useState('');
            const [priceHalfDay, setPriceHalfDay] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [rentalType, setRentalType] = useState('fullday'); // 'fullday' ou 'halfday'

            // Calcul du nombre de jours et du prix total
            const calculateDuration = () => {
                if (!startDate || !endDate) return { days: 0, total: 0, display: '' };
                
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let total = 0;
                let display = '';
                
                if (rentalType === 'fullday') {
                    total = diffDays * parseFloat(priceFullDay || 0);
                    display = `${diffDays} jour(s) √ó ${priceFullDay}‚Ç¨ = ${total.toFixed(2)}‚Ç¨`;
                } else {
                    total = diffDays * parseFloat(priceHalfDay || 0);
                    display = `${diffDays} demi-jour(s) √ó ${priceHalfDay}‚Ç¨ = ${total.toFixed(2)}‚Ç¨`;
                }
                
                return { days: diffDays, total, display };
            };

            const duration = calculateDuration();

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name || !priceFullDay || !priceHalfDay || !startDate || !endDate) {
                    alert('Veuillez remplir tous les champs');
                    return;
                }
                if (new Date(startDate) >= new Date(endDate)) {
                    alert('La date de fin doit √™tre apr√®s la date de d√©but');
                    return;
                }
                
                // D√©terminer le prix √† facturer
                const finalPrice = rentalType === 'fullday' ? duration.total : duration.total;
                
                onAddItem(name, finalPrice, startDate, endDate, rentalType, priceFullDay, priceHalfDay);
                setName('');
                setPriceFullDay('');
                setPriceHalfDay('');
                setStartDate('');
                setEndDate('');
                setRentalType('fullday');
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                    <div className="bg-gray-800 rounded-xl p-8 w-full max-w-lg shadow-2xl border border-gray-700 max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">Ajouter Article en Location</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">‚úï</button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {/* Nom de l'article */}
                            <div>
                                <label className="block text-sm font-semibold text-gray-300 mb-2">Nom de l'article *</label>
                                <input 
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    placeholder="Ex: Location Skis Rossignol"
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    required
                                />
                            </div>

                            {/* Prix Journ√©e Compl√®te */}
                            <div>
                                <label className="block text-sm font-semibold text-gray-300 mb-2">Prix Journ√©e Compl√®te (‚Ç¨) *</label>
                                <input 
                                    type="number"
                                    step="0.01"
                                    value={priceFullDay}
                                    onChange={(e) => setPriceFullDay(e.target.value)}
                                    placeholder="Ex: 35.00"
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    required
                                />
                            </div>

                            {/* Prix Demi-Journ√©e */}
                            <div>
                                <label className="block text-sm font-semibold text-gray-300 mb-2">Prix Demi-Journ√©e (‚Ç¨) *</label>
                                <input 
                                    type="number"
                                    step="0.01"
                                    value={priceHalfDay}
                                    onChange={(e) => setPriceHalfDay(e.target.value)}
                                    placeholder="Ex: 20.00"
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    required
                                />
                            </div>

                            {/* Dates */}
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">Date de d√©but *</label>
                                    <input 
                                        type="date"
                                        value={startDate}
                                        onChange={(e) => setStartDate(e.target.value)}
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-green-500 focus:outline-none"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">Date de fin *</label>
                                    <input 
                                        type="date"
                                        value={endDate}
                                        onChange={(e) => setEndDate(e.target.value)}
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-green-500 focus:outline-none"
                                        required
                                    />
                                </div>
                            </div>

                            {/* Type de location */}
                            <div>
                                <label className="block text-sm font-semibold text-gray-300 mb-2">Type de location *</label>
                                <div className="flex space-x-3">
                                    <button
                                        type="button"
                                        onClick={() => setRentalType('fullday')}
                                        className={`flex-1 py-2 px-4 rounded-lg font-semibold transition ${
                                            rentalType === 'fullday'
                                                ? 'bg-green-600 text-white'
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >
                                        Journ√©e Compl√®te
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setRentalType('halfday')}
                                        className={`flex-1 py-2 px-4 rounded-lg font-semibold transition ${
                                            rentalType === 'halfday'
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >
                                        Demi-Journ√©e
                                    </button>
                                </div>
                            </div>

                            {/* Calcul du total */}
                            {startDate && endDate && (
                                <div className="p-3 bg-gray-900 rounded border border-gray-700">
                                    <div className="text-sm text-gray-400 mb-2">Calcul du total :</div>
                                    <div className="text-lg font-bold text-green-400">{duration.display}</div>
                                </div>
                            )}

                            <div className="text-xs text-gray-400 bg-gray-900 p-2 rounded">
                                ‚ÑπÔ∏è Les d√©tails de location seront li√©s au client s√©lectionn√©
                            </div>

                            <div className="flex space-x-4 pt-6 border-t border-gray-700">
                                <button type="submit" className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                    Ajouter
                                </button>
                                <button type="button" onClick={onClose} className="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">
                                    Annuler
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- COMPOSANT MODALE CLIENT (S√âPAR√â) ---
        const ClientManagementModal = ({
            isOpen, 
            onClose, 
            clients, 
            onAddClient, 
            onSelectClient, 
            generateClientNumber 
        }) => {
            const [formData, setFormData] = useState({
                nom: '',
                prenom: '',
                adresse: '',
                dateNaissance: '',
                ville: ''
            });

            const handleFormChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (!formData.nom || !formData.prenom || !formData.adresse || !formData.dateNaissance || !formData.ville) {
                    alert('Veuillez remplir tous les champs');
                    return;
                }

                const newClient = {
                    id: `C${String(clients.length + 1).padStart(3, '0')}`,
                    num: generateClientNumber(),
                    nom: formData.nom,
                    prenom: formData.prenom,
                    adresse: formData.adresse,
                    dateNaissance: formData.dateNaissance,
                    ville: formData.ville,
                    loyaltyPoints: 0
                };

                onAddClient(newClient);
                setFormData({ nom: '', prenom: '', adresse: '', dateNaissance: '', ville: '' });
                alert(`Client cr√©√© avec succ√®s ! Num√©ro: ${newClient.num}`);
            };

            const handleClose = () => {
                setFormData({ nom: '', prenom: '', adresse: '', dateNaissance: '', ville: '' });
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                    <div className="bg-gray-800 rounded-xl p-8 w-full max-w-2xl shadow-2xl border border-gray-700 max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">Gestion des Clients</h2>
                            <button 
                                onClick={handleClose}
                                className="text-gray-400 hover:text-white text-2xl"
                            >
                                ‚úï
                            </button>
                        </div>

                        {/* Onglets */}
                        <div className="flex space-x-4 mb-6 border-b border-gray-700">
                            <button className="px-4 py-2 text-green-400 border-b-2 border-green-400 font-semibold">
                                Cr√©er Client
                            </button>
                            <button className="px-4 py-2 text-gray-400 hover:text-white">
                                Consulter
                            </button>
                        </div>

                        {/* Formulaire Cr√©ation Client */}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                {/* Num√©ro de Client (Lecture Seule) */}
                                <div className="col-span-2">
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">
                                        Num√©ro de Client
                                    </label>
                                    <input 
                                        type="text"
                                        readOnly
                                        value={generateClientNumber()}
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white font-mono cursor-not-allowed opacity-75"
                                    />
                                </div>

                                {/* Pr√©nom */}
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">
                                        Pr√©nom *
                                    </label>
                                    <input 
                                        type="text"
                                        name="prenom"
                                        placeholder="Jean"
                                        value={formData.prenom}
                                        onChange={handleFormChange}
                                        required
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>

                                {/* Nom */}
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">
                                        Nom *
                                    </label>
                                    <input 
                                        type="text"
                                        name="nom"
                                        placeholder="Dupont"
                                        value={formData.nom}
                                        onChange={handleFormChange}
                                        required
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>

                                {/* Adresse */}
                                <div className="col-span-2">
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">
                                        Adresse *
                                    </label>
                                    <input 
                                        type="text"
                                        name="adresse"
                                        placeholder="123 Rue de la Paix"
                                        value={formData.adresse}
                                        onChange={handleFormChange}
                                        required
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>

                                {/* Date de Naissance */}
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">
                                        Date de Naissance *
                                    </label>
                                    <input 
                                        type="date"
                                        name="dateNaissance"
                                        value={formData.dateNaissance}
                                        onChange={handleFormChange}
                                        required
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>

                                {/* Ville */}
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">
                                        Ville *
                                    </label>
                                    <input 
                                        type="text"
                                        name="ville"
                                        placeholder="Chamonix"
                                        value={formData.ville}
                                        onChange={handleFormChange}
                                        required
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>
                            </div>

                            {/* Boutons */}
                            <div className="flex space-x-4 pt-6 border-t border-gray-700">
                                <button 
                                    type="submit"
                                    className="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition"
                                >
                                    Cr√©er Client
                                </button>
                                <button 
                                    type="button"
                                    onClick={handleClose}
                                    className="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition"
                                >
                                    Annuler
                                </button>
                            </div>
                        </form>

                        {/* Liste des Clients Existants */}
                        {clients.length > 0 && (
                            <div className="mt-8 pt-8 border-t border-gray-700">
                                <h3 className="text-lg font-bold text-white mb-4">Clients Existants</h3>
                                <div className="space-y-2 max-h-64 overflow-y-auto">
                                    {clients.map((client) => (
                                        <div 
                                            key={client.id}
                                            onClick={() => {
                                                onSelectClient(client);
                                                handleClose();
                                            }}
                                            className="p-3 bg-gray-700 hover:bg-gray-600 rounded-lg cursor-pointer transition border border-gray-600"
                                        >
                                            <div className="flex justify-between items-center">
                                                <div>
                                                    <div className="font-bold text-white">{client.prenom} {client.nom}</div>
                                                    <div className="text-xs text-gray-400">{client.adresse} - {client.ville}</div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="font-mono text-green-400 font-bold">{client.num}</div>
                                                    <div className="text-xs text-gray-400">{client.loyaltyPoints} points</div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        // --- DONN√âES SIMUL√âES (Adapt√©es Sport & Location) ---
        const MOCK_CLIENTS = [
            { id: 'C001', num: 'CLI-001', nom: 'Dupont', prenom: 'Jean', adresse: '123 Rue de la Paix', dateNaissance: '1990-05-15', ville: 'Chamonix', loyaltyPoints: 450 },
            { id: 'C002', num: 'CLI-002', nom: 'Martin', prenom: 'Sophie', adresse: '456 Avenue des Pistes', dateNaissance: '1985-08-20', ville: 'Annecy', loyaltyPoints: 120 },
        ];

        const MOCK_PRODUCTS = [
            { id: 101, name: 'Pack Ski Alpin - Expert', price: 35.00, isRentable: true, category: 'Location', color: 'bg-green-600/30', text: 'text-green-300', barcode: '3701234567891' },
            { id: 102, name: 'Location VTT Adulte (Jour)', price: 25.00, isRentable: true, category: 'Location', color: 'bg-green-600/30', text: 'text-green-300', barcode: '3701234567892' },
            { id: 201, name: 'Gants de Ski Imperm√©ables', price: 49.99, isRentable: false, category: 'Vente', color: 'bg-indigo-600/30', text: 'text-indigo-300', barcode: '3701234567893' },
            { id: 202, name: 'Casquette Technique', price: 19.99, isRentable: false, category: 'Vente', color: 'bg-indigo-600/30', text: 'text-indigo-300', barcode: '3701234567894' },
            { id: 301, name: 'Forfait Saison VTT', price: 299.00, isRentable: false, category: 'Services', color: 'bg-yellow-600/30', text: 'text-yellow-300', barcode: '3701234567895' },
            { id: 302, name: 'R√©paration Ski (Atelier)', price: 45.00, isRentable: false, category: 'Services', color: 'bg-yellow-600/30', text: 'text-yellow-300', barcode: '3701234567896' },
        ];

        // Structure d'un article dans le panier (avec d√©tails de location)
        const initialRentalItem = { 
            id: 900, 
            name: 'Location Ski Alpin Elite - 3 Jours', 
            price: 90.00, 
            qty: 1, 
            isRentable: true,
            details: {
                startDate: '2025-08-16',
                endDate: '2025-08-18',
                caution: 250.00,
                client: 'Jean Dupont (ID: C097)'
            } 
        };

        const POS = () => {
            const [cart, setCart] = useState([initialRentalItem]); // Panier pr√©-rempli pour la d√©mo
            const [searchQuery, setSearchQuery] = useState('');
            const [serviceTab, setServiceTab] = useState('Vente'); // 'Vente', 'Location', 'Atelier'
            const [clients, setClients] = useState(MOCK_CLIENTS);
            const [selectedClient, setSelectedClient] = useState(null);
            const [isClientModalOpen, setIsClientModalOpen] = useState(false);
            const [selectedPaymentMethod, setSelectedPaymentMethod] = useState(null);
            const [barcodeInput, setBarcodeInput] = useState('');
            const [scanMessage, setScanMessage] = useState('');
            const [scanMessageType, setScanMessageType] = useState(''); // 'success', 'error', 'info'
            const [isAddSaleModalOpen, setIsAddSaleModalOpen] = useState(false);
            const [isAddRentalModalOpen, setIsAddRentalModalOpen] = useState(false);
            const [transactions, setTransactions] = useState(() => {
                // Charger les transactions depuis localStorage
                const saved = localStorage.getItem('posTransactions');
                return saved ? JSON.parse(saved) : [];
            });
            const [isHistoryOpen, setIsHistoryOpen] = useState(false);
            const [historyFilter, setHistoryFilter] = useState('jour'); // 'jour', 'mois', 'annee'
            const [isBackOfficeOpen, setIsBackOfficeOpen] = useState(false);
            const [backOfficeTab, setBackOfficeTab] = useState('dashboard'); // 'dashboard', 'suppliers', 'articles', 'stock', 'finances', 'clients', 'reports'
            const [suppliers, setSuppliers] = useState(() => {
                const saved = localStorage.getItem('posSuppliers');
                return saved ? JSON.parse(saved) : [
                    { id: 'SUP001', name: 'Rossignol Ski', email: 'contact@rossignol.com', phone: '04 50 00 00 00', country: 'France' },
                    { id: 'SUP002', name: 'Salomon Sports', email: 'info@salomon.com', phone: '04 50 11 11 11', country: 'France' },
                ];
            });
            const paymentMethods = [
                { id: 'especes', label: 'Esp√®ces', icon: 'üíµ', color: 'bg-green-600' },
                { id: 'carte', label: 'Carte Bancaire', icon: 'üí≥', color: 'bg-blue-600' },
                { id: 'cleu', label: 'Cl√©-U', icon: 'üîë', color: 'bg-purple-600' },
                { id: 'cheque', label: 'Ch√®que Cadeau', icon: 'üéÅ', color: 'bg-pink-600' },
                { id: 'globalpos', label: 'GlobalPos', icon: 'üì±', color: 'bg-indigo-600' },
            ];

            // √âtats pour la gestion avanc√©e
            const [productSuppliers, setProductSuppliers] = useState(() => {
                const saved = localStorage.getItem('posProductSuppliers');
                return saved ? JSON.parse(saved) : {};
            });
            const [productStock, setProductStock] = useState(() => {
                const saved = localStorage.getItem('posProductStock');
                return saved ? JSON.parse(saved) : {};
            });
            const [productCosts, setProductCosts] = useState(() => {
                const saved = localStorage.getItem('posProductCosts');
                return saved ? JSON.parse(saved) : {};
            });
            const [expenses, setExpenses] = useState(() => {
                const saved = localStorage.getItem('posExpenses');
                return saved ? JSON.parse(saved) : [];
            });
            const [stockMovements, setStockMovements] = useState(() => {
                const saved = localStorage.getItem('posStockMovements');
                return saved ? JSON.parse(saved) : [];
            });
            const [stockAlerts, setStockAlerts] = useState(() => {
                const saved = localStorage.getItem('posStockAlerts');
                return saved ? JSON.parse(saved) : {};
            });

            // Fonction pour enregistrer un mouvement de stock
            const recordStockMovement = (productId, quantity, type, reason = '') => {
                const movement = {
                    id: `MOV${Date.now()}`,
                    productId,
                    productName: MOCK_PRODUCTS.find(p => p.id === productId)?.name || 'Unknown',
                    quantity,
                    type, // 'entr√©e' ou 'sortie'
                    reason,
                    date: new Date().toISOString(),
                    timestamp: Date.now()
                };
                
                const updated = [...stockMovements, movement];
                setStockMovements(updated);
                localStorage.setItem('posStockMovements', JSON.stringify(updated));
                return movement;
            };

            // Fonction pour ajouter une d√©pense
            const addExpense = (category, amount, description = '') => {
                const expense = {
                    id: `EXP${Date.now()}`,
                    category,
                    amount,
                    description,
                    date: new Date().toISOString(),
                    timestamp: Date.now()
                };
                const updated = [...expenses, expense];
                setExpenses(updated);
                localStorage.setItem('posExpenses', JSON.stringify(updated));
                saveToFirestore('expenses', expense);
                return expense;
            };

            // Fonction pour calculer les statistiques financi√®res
            const getFinancialStats = (startDate, endDate) => {
                const filteredTransactions = transactions.filter(t => {
                    if (!t.date) return false;
                    const tDate = new Date(t.date);
                    return tDate >= startDate && tDate <= endDate;
                });

                const totalRevenue = filteredTransactions.reduce((sum, t) => sum + (t.total || 0), 0);
                const totalTransactions = filteredTransactions.length;
                
                // Calcul du co√ªt total (bas√© sur les co√ªts d'achat des produits)
                const totalCost = filteredTransactions.reduce((sum, t) => {
                    if (t.items && Array.isArray(t.items)) {
                        return sum + t.items.reduce((itemSum, item) => {
                            const cost = productCosts[item.id] || 0;
                            return itemSum + (cost * (item.qty || item.quantity || 1));
                        }, 0);
                    }
                    return sum;
                }, 0);

                // D√©penses dans la p√©riode
                const periodExpenses = expenses.filter(e => {
                    const eDate = new Date(e.date);
                    return eDate >= startDate && eDate <= endDate;
                });
                const totalExpenses = periodExpenses.reduce((sum, e) => sum + e.amount, 0);

                const grossProfit = totalRevenue - totalCost;
                const netProfit = grossProfit - totalExpenses;
                const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100).toFixed(2) : 0;

                return {
                    totalRevenue,
                    totalCost,
                    totalExpenses,
                    grossProfit,
                    netProfit,
                    profitMargin,
                    totalTransactions,
                    periodExpenses
                };
            };

            // Fonction pour calculer les points de fid√©lit√©
            const calculateLoyaltyPoints = (clientId) => {
                const clientTransactions = transactions.filter(t => t.client === clientId);
                const totalSpent = clientTransactions.reduce((sum, t) => sum + (t.total || 0), 0);
                // 1 point pour 1‚Ç¨ d√©pens√©
                return Math.floor(totalSpent);
            };

            // Fonction pour obtenir le segment client
            const getClientSegment = (clientId) => {
                const clientTransactions = transactions.filter(t => t.client === clientId);
                const totalSpent = clientTransactions.reduce((sum, t) => sum + (t.total || 0), 0);
                const transactionCount = clientTransactions.length;

                if (totalSpent >= 5000 || transactionCount >= 50) {
                    return { name: 'VIP', color: 'gold', icon: 'üëë' };
                } else if (totalSpent >= 2000 || transactionCount >= 20) {
                    return { name: 'Premium', color: 'purple', icon: 'üíé' };
                } else if (totalSpent >= 500 || transactionCount >= 5) {
                    return { name: 'Fid√®le', color: 'blue', icon: '‚≠ê' };
                } else if (totalSpent > 0 || transactionCount > 0) {
                    return { name: 'R√©gulier', color: 'green', icon: '‚úì' };
                } else {
                    return { name: 'Nouveau', color: 'gray', icon: 'üÜï' };
                }
            };

            // Fonction pour obtenir l'historique d'achats d'un client
            const getClientPurchaseHistory = (clientId) => {
                return transactions.filter(t => t.client === clientId).sort((a, b) => {
                    const dateA = new Date(a.date || 0).getTime();
                    const dateB = new Date(b.date || 0).getTime();
                    return dateB - dateA;
                });
            };

            // Fonction pour ajouter des points de fid√©lit√©
            const addLoyaltyPoints = (clientId, points) => {
                setClients(prev => prev.map(c => 
                    c.num === clientId 
                        ? { ...c, loyaltyPoints: (c.loyaltyPoints || 0) + points }
                        : c
                ));
            };

            const generateClientNumber = () => {
                const maxNum = clients.length > 0 
                    ? Math.max(...clients.map(c => parseInt(c.num.split('-')[1])))
                    : 0;
                return `CLI-${String(maxNum + 1).padStart(3, '0')}`;
            };

            const handleAddClient = (newClient) => {
                setClients(prev => [...prev, newClient]);
                setSelectedClient(newClient);
                // üî• Sauvegarder dans Firebase
                saveToFirestore('clients', newClient);
            };

            const handleSelectClient = (client) => {
                setSelectedClient(client);
            };

            const addToCart = (product) => {
                setCart((prevCart) => {
                    // Si c'est un produit de vente, on incr√©mente la quantit√©
                    if (!product.isRentable) {
                        const existingItem = prevCart.find((item) => item.id === product.id && !item.isRentable);
                        if (existingItem) {
                            return prevCart.map((item) =>
                                item.id === product.id ? { ...item, qty: item.qty + 1 } : item
                            );
                        }
                    }
                    
                    // Pour les locations, on ajoute une nouvelle ligne (chaque location est unique)
                    return [...prevCart, { ...product, qty: 1 }];
                });
            };

            const updateQty = (id, delta) => {
                setCart((prevCart) => {
                    return prevCart.map((item) => {
                        if (item.id === id) return { ...item, qty: Math.max(0, item.qty + delta) };
                        return item;
                    }).filter(item => item.qty > 0);
                });
            };

            const clearCart = () => {
                if(window.confirm('Voulez-vous annuler ce ticket ?')) {
                    setCart([]);
                }
            };

            const handlePay = () => {
                saveTransaction();
                handlePrintTicket();
            };

            const handleBarcodeScan = (e) => {
                e.preventDefault();
                
                if (!barcodeInput.trim()) {
                    setScanMessage('Veuillez scanner un code-barre');
                    setScanMessageType('info');
                    return;
                }

                // Rechercher le produit par code-barre
                const scannedProduct = MOCK_PRODUCTS.find(p => p.barcode === barcodeInput);
                
                if (scannedProduct) {
                    // Ajouter le produit au panier
                    addToCart(scannedProduct);
                    setScanMessage(`‚úì ${scannedProduct.name} ajout√© au panier`);
                    setScanMessageType('success');
                } else {
                    setScanMessage(`‚úó Article non trouv√© (Code: ${barcodeInput})`);
                    setScanMessageType('error');
                }

                // R√©initialiser le champ et afficher le message pendant 2 secondes
                setBarcodeInput('');
                setTimeout(() => setScanMessage(''), 2000);
            };

            // Handlers pour l'ajout d'articles en vente et location
            const handleAddSaleItem = (name, price) => {
                // G√©n√©rer un code-barre unique
                const newBarcode = '37' + Math.random().toString().slice(2, 13);
                
                // Cr√©er le nouveau produit
                const newProduct = {
                    id: Math.max(...MOCK_PRODUCTS.map(p => p.id), 0) + 1,
                    name: name,
                    price: parseFloat(price),
                    isRentable: false,
                    category: 'Vente',
                    color: 'bg-indigo-600/30',
                    text: 'text-indigo-300',
                    barcode: newBarcode
                };
                
                // Ajouter au catalogue
                MOCK_PRODUCTS.push(newProduct);
                // üî• Sauvegarder dans Firebase
                saveToFirestore('products', newProduct);
                
                // Cr√©er l'article pour le panier
                const newItem = {
                    id: Math.random(),
                    name: name,
                    price: parseFloat(price),
                    qty: 1,
                    isRentable: false,
                    category: 'Vente',
                    details: { variant: 'Custom' }
                };
                
                // Ajouter au panier
                addToCart(newItem);
                setIsAddSaleModalOpen(false);
            };
            
            const handleAddRentalItem = (name, price, startDate, endDate, rentalType, priceFullDay, priceHalfDay) => {
                // G√©n√©rer un code-barre unique
                const newBarcode = '37' + Math.random().toString().slice(2, 13);
                
                // Cr√©er le nouveau produit
                const newProduct = {
                    id: Math.max(...MOCK_PRODUCTS.map(p => p.id), 0) + 1,
                    name: name,
                    price: parseFloat(price),
                    isRentable: true,
                    category: 'Location',
                    color: 'bg-green-600/30',
                    text: 'text-green-300',
                    barcode: newBarcode
                };
                
                // Ajouter au catalogue
                MOCK_PRODUCTS.push(newProduct);
                // üî• Sauvegarder dans Firebase
                saveToFirestore('products', newProduct);
                
                // Cr√©er l'article pour le panier
                const newItem = {
                    id: Math.random(),
                    name: name,
                    price: parseFloat(price),
                    qty: 1,
                    isRentable: true,
                    category: 'Location',
                    details: {
                        startDate: startDate,
                        endDate: endDate,
                        rentalType: rentalType,
                        priceFullDay: parseFloat(priceFullDay),
                        priceHalfDay: parseFloat(priceHalfDay),
                        caution: 0,
                        client: selectedClient ? `${selectedClient.prenom} ${selectedClient.nom}` : 'Client non s√©lectionn√©'
                    }
                };
                
                // Ajouter au panier
                addToCart(newItem);
                setIsAddRentalModalOpen(false);
            };

            // Fonction pour enregistrer une transaction
            const saveTransaction = () => {
                if (cart.length === 0) {
                    alert('Panier vide! Ajoutez des articles avant de valider.');
                    return;
                }

                if (!selectedPaymentMethod) {
                    alert('Veuillez s√©lectionner un mode de paiement!');
                    return;
                }

                const total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
                const paymentLabel = paymentMethods.find(m => m.id === selectedPaymentMethod)?.label || 'Non sp√©cifi√©';
                
                const newTransaction = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    client: selectedClient ? `${selectedClient.prenom} ${selectedClient.nom}` : 'Client non s√©lectionn√©',
                    clientNum: selectedClient?.num || 'N/A',
                    items: cart.map(item => ({
                        name: item.name,
                        qty: item.qty,
                        price: item.price,
                        subtotal: item.price * item.qty
                    })),
                    total: total,
                    paymentMethod: paymentLabel,
                    notes: ''
                };

                // Ajouter √† l'√©tat et sauvegarder dans localStorage
                const updatedTransactions = [...transactions, newTransaction];
                setTransactions(updatedTransactions);
                localStorage.setItem('posTransactions', JSON.stringify(updatedTransactions));

                // üî• Sauvegarder dans Firebase
                saveToFirestore('transactions', newTransaction);

                // Vider le panier et r√©initialiser
                setCart([]);
                setSelectedPaymentMethod(null);
                setSelectedClient(null);

                alert('‚úÖ Transaction enregistr√©e avec succ√®s! (Sauvegard√©e localement + Cloud)');
            };

            // Filtrer les transactions par date
            const getFilteredTransactions = () => {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const yearStart = new Date(now.getFullYear(), 0, 1);

                return transactions.filter(tx => {
                    const txDate = new Date(tx.date);
                    const txDateOnly = new Date(txDate.getFullYear(), txDate.getMonth(), txDate.getDate());

                    if (historyFilter === 'jour') {
                        return txDateOnly.getTime() === today.getTime();
                    } else if (historyFilter === 'mois') {
                        return txDate.getFullYear() === now.getFullYear() && txDate.getMonth() === now.getMonth();
                    } else if (historyFilter === 'annee') {
                        return txDate.getFullYear() === now.getFullYear();
                    }
                    return true;
                });
            };

            // Calcul des statistiques
            const getStats = () => {
                const filtered = getFilteredTransactions();
                const totalRevenue = filtered.reduce((acc, tx) => acc + tx.total, 0);
                const totalTransactions = filtered.length;
                const totalItems = filtered.reduce((acc, tx) => acc + tx.items.reduce((sum, item) => sum + item.qty, 0), 0);

                return { totalRevenue, totalTransactions, totalItems };
            };

            const handlePrintTicket = () => {
                // Cr√©er un √©l√©ment invisible pour l'impression
                const printWindow = window.open('', '', 'height=400,width=300');
                const ticketHTML = generateTicketHTML();
                
                printWindow.document.write(ticketHTML);
                printWindow.document.close();
                
                // Attendre que le document soit charg√© avant d'imprimer
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            };

            const generateTicketHTML = () => {
                const now = new Date();
                const dateStr = now.toLocaleDateString('fr-FR', { year: 'numeric', month: '2-digit', day: '2-digit' });
                const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                
                const ticketItems = cart.map(item => `
                    <div style="display: flex; justify-content: space-between; padding: 2mm 0; border-bottom: 1px dotted #ccc;">
                        <div style="flex: 1;">
                            <div>${item.name.substring(0, 20)}</div>
                            <div style="font-size: 10px; color: #666;">${item.qty}x ${formatPrice(item.price)}</div>
                        </div>
                        <div style="text-align: right; font-weight: bold;">
                            ${formatPrice(item.price * item.qty)}
                        </div>
                    </div>
                `).join('');

                const selectedPaymentLabel = selectedPaymentMethod 
                    ? paymentMethods.find(m => m.id === selectedPaymentMethod)?.label 
                    : 'Non sp√©cifi√©';

                return `
                    <!DOCTYPE html>
                    <html lang="fr">
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body {
                                margin: 0;
                                padding: 5mm;
                                width: 80mm;
                                background: white;
                                color: black;
                                font-family: 'Courier New', monospace;
                                font-size: 12px;
                                line-height: 1.4;
                            }
                            .ticket-header {
                                text-align: center;
                                border-bottom: 2px solid black;
                                padding-bottom: 5mm;
                                margin-bottom: 5mm;
                            }
                            .ticket-title {
                                font-size: 18px;
                                font-weight: bold;
                                margin-bottom: 2mm;
                            }
                            .ticket-line {
                                display: flex;
                                justify-content: space-between;
                                padding: 2mm 0;
                            }
                            .ticket-item {
                                padding: 2mm 0;
                                border-bottom: 1px dotted #ccc;
                            }
                            .ticket-total {
                                font-weight: bold;
                                font-size: 14px;
                                margin-top: 3mm;
                                padding-top: 3mm;
                                border-top: 2px solid black;
                                display: flex;
                                justify-content: space-between;
                            }
                            .ticket-footer {
                                text-align: center;
                                font-size: 10px;
                                margin-top: 5mm;
                                padding-top: 5mm;
                                border-top: 1px dashed black;
                            }
                            .info-row {
                                display: flex;
                                justify-content: space-between;
                                font-size: 11px;
                                margin: 1mm 0;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="ticket-header">
                            <div class="ticket-title">POS SPORT üéø</div>
                            <div style="font-size: 11px; margin-top: 2mm;">Ticket de Caisse</div>
                        </div>

                        <div style="font-size: 10px; margin-bottom: 5mm;">
                            <div class="info-row">
                                <span>Date:</span>
                                <span>${dateStr} ${timeStr}</span>
                            </div>
                            ${selectedClient ? `
                                <div class="info-row">
                                    <span>Client:</span>
                                    <span>${selectedClient.prenom} ${selectedClient.nom}</span>
                                </div>
                                <div class="info-row">
                                    <span>N¬∞ Client:</span>
                                    <span>${selectedClient.num}</span>
                                </div>
                            ` : ''}
                        </div>

                        <div style="margin-bottom: 5mm;">
                            ${ticketItems}
                        </div>

                        <div class="ticket-total">
                            <span>TOTAL TTC:</span>
                            <span>${formatPrice(total)}</span>
                        </div>

                        <div style="margin-top: 3mm; padding: 2mm; background: #f0f0f0; border: 1px solid #ccc;">
                            <div style="text-align: center; font-weight: bold; margin-bottom: 1mm;">Mode de Paiement</div>
                            <div style="text-align: center; font-size: 13px; font-weight: bold;">
                                ${selectedPaymentLabel}
                            </div>
                        </div>

                        <div class="ticket-footer">
                            <div style="margin: 3mm 0;">Merci pour votre achat!</div>
                            <div>POS Sport ¬© 2025</div>
                        </div>
                    </body>
                    </html>
                `;
            };

            // Calcul du total TTC (Exclut la caution pour le moment)
            const total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            const formatPrice = (price) => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(price);

            const filteredProducts = MOCK_PRODUCTS.filter(p => 
                p.category === serviceTab && p.name.toLowerCase().includes(searchQuery.toLowerCase())
            );

            const tabs = ['Vente', 'Location', 'Services'];

            return (
                <div className="flex h-screen font-sans bg-gray-900">
                    
                    {/* --- GAUCHE : TICKET (25%) --- */}
                    <div className="w-1/4 flex flex-col bg-gray-800 border-r border-gray-700 shadow-2xl z-10 relative">
                        <div className="p-4 bg-gray-900 text-white flex justify-between items-center shadow-md">
                            <h1 className="font-extrabold text-2xl text-green-400">POS Sport üéø</h1>
                            <div className="flex items-center space-x-3">
                                <button 
                                    onClick={() => setIsBackOfficeOpen(true)}
                                    className="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs font-semibold rounded transition"
                                    title="Acc√©der au back office"
                                >
                                    ‚öôÔ∏è Back Office
                                </button>
                                <div className="text-xs text-gray-400">Ticket #2024-88</div>
                            </div>
                        </div>

                        {/* Champ de Scan Code-Barre */}
                        <form onSubmit={handleBarcodeScan} className="p-3 bg-gray-800 border-b border-gray-700">
                            <label className="text-xs text-gray-400 mb-1 block font-semibold">Scanner un article</label>
                            <div className="flex items-center space-x-2">
                                <input 
                                    type="text"
                                    value={barcodeInput}
                                    onChange={(e) => setBarcodeInput(e.target.value)}
                                    placeholder="Code-barre..."
                                    className="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none placeholder-gray-500"
                                    autoFocus
                                />
                                <button 
                                    type="submit"
                                    className="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition text-sm"
                                >
                                    üì±
                                </button>
                            </div>
                            
                            {/* Message de Scan */}
                            {scanMessage && (
                                <div className={`mt-2 p-2 rounded text-xs font-semibold text-center ${
                                    scanMessageType === 'success' ? 'bg-green-900/50 text-green-300 border border-green-600' :
                                    scanMessageType === 'error' ? 'bg-red-900/50 text-red-300 border border-red-600' :
                                    'bg-blue-900/50 text-blue-300 border border-blue-600'
                                }`}>
                                    {scanMessage}
                                </div>
                            )}
                        </form>

                        {/* Liste Panier */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-2">
                            {cart.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-gray-500 select-none">
                                    <svg className="w-16 h-16 mb-4 opacity-20" fill="currentColor" viewBox="0 0 20 20"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path></svg>
                                    <span className="italic">Ajoutez des articles ou des locations...</span>
                                </div>
                            ) : (
                                cart.map((item, index) => (
                                    <div key={index} className="flex flex-col p-3 bg-gray-700 rounded-lg shadow-lg border border-gray-600 transition">
                                        
                                        {/* Ligne principale (Nom / Qty / Prix) */}
                                        <div className="flex justify-between items-center pb-2">
                                            <div className="flex-1">
                                                <div className="font-bold text-gray-200">{item.name}</div>
                                                <div className="text-xs text-gray-400">{formatPrice(item.price)} / unit√©</div>
                                            </div>
                                            
                                            {/* Contr√¥les Quantit√© */}
                                            <div className="flex items-center space-x-2 bg-gray-900 rounded-full p-0.5">
                                                <button onClick={() => updateQty(item.id, -1)} className="w-6 h-6 rounded-full bg-gray-600 text-red-400 hover:bg-red-900 font-bold">-</button>
                                                <span className="font-bold w-4 text-center text-sm">{item.qty}</span>
                                                <button onClick={() => updateQty(item.id, 1)} className="w-6 h-6 rounded-full bg-gray-600 text-green-400 hover:bg-green-900 font-bold">+</button>
                                            </div>
                                            
                                            <div className="w-20 text-right font-bold text-lg text-green-300">
                                                {formatPrice(item.price * item.qty)}
                                            </div>
                                        </div>

                                        {/* D√©tails de Location (Si applicable) */}
                                        {item.isRentable && item.details && (
                                            <div className="text-xs p-2 mt-2 bg-gray-900 rounded border border-gray-700 space-y-1">
                                                <div className="font-semibold text-blue-400">D√©tails de Location:</div>
                                                <div className="flex justify-between text-gray-400"><span>P√©riode:</span> <span>{item.details.startDate} ‚Üí {item.details.endDate}</span></div>
                                                <div className="flex justify-between text-gray-400"><span>Type:</span> <span className="font-semibold text-blue-300">{item.details.rentalType === 'fullday' ? 'üìÖ Journ√©e Compl√®te' : '‚è∞ Demi-Journ√©e'}</span></div>
                                                {item.details.priceFullDay && (
                                                    <div className="flex justify-between text-gray-400"><span>Tarifs:</span> <span>{formatPrice(item.details.priceFullDay)}/j - {formatPrice(item.details.priceHalfDay)}/¬Ωj</span></div>
                                                )}
                                                <div className="flex justify-between text-gray-400"><span>Client:</span> <span>{item.details.client}</span></div>
                                                {item.details.caution > 0 && (
                                                    <div className="flex justify-between text-gray-300 font-bold"><span>Caution:</span> <span className="text-yellow-400">{formatPrice(item.details.caution)}</span></div>
                                                )}
                                            </div>
                                        )}

                                    </div>
                                ))
                            )}
                        </div>                        {/* Aide - Codes-barres Disponibles (Collapsible) */}
                        <details className="p-3 bg-gray-800 border-t border-gray-700 text-xs">
                            <summary className="cursor-pointer font-semibold text-gray-300 hover:text-white">üìã Codes-barres disponibles</summary>
                            <div className="mt-2 space-y-1 text-gray-400 text-xs">
                                {MOCK_PRODUCTS.map(product => (
                                    <div key={product.id} className="p-1 bg-gray-900 rounded border border-gray-700">
                                        <div className="font-mono text-blue-300">{product.barcode}</div>
                                        <div className="truncate">{product.name}</div>
                                    </div>
                                ))}
                            </div>
                        </details>

                        {/* Bloc Client S√©lectionn√© */}
                        <div className="p-4 bg-gray-800 border-t border-gray-700">
                            {selectedClient ? (
                                <div className="p-3 bg-green-900/30 border border-green-600 rounded-lg">
                                    <div className="text-xs text-gray-400 mb-1">Client S√©lectionn√©</div>
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <div className="font-bold text-white">{selectedClient.prenom} {selectedClient.nom}</div>
                                            <div className="text-xs text-gray-400 mt-1">{selectedClient.num}</div>
                                        </div>
                                        <button 
                                            onClick={() => setIsClientModalOpen(true)}
                                            className="text-blue-400 hover:text-blue-300 text-xs font-semibold"
                                        >
                                            Changer
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <button 
                                    onClick={() => setIsClientModalOpen(true)}
                                    className="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition text-sm"
                                >
                                    + S√©lectionner/Cr√©er un Client
                                </button>
                            )}
                        </div>

                        {/* Totaux & Paiement */}
                        <div className="p-4 bg-gray-900 border-t border-gray-700 shadow-[0_-5px_15px_rgba(0,0,0,0.4)]">
                            <div className="flex justify-between items-center mb-4">
                                <span className="text-2xl font-bold text-gray-200">Total TTC</span>
                                <span className="text-4xl font-extrabold text-green-400">{formatPrice(total)}</span>
                            </div>
                            
                            <div className="space-y-2">
                                <button 
                                    onClick={() => {
                                        saveTransaction();
                                        handlePrintTicket();
                                    }}
                                    disabled={cart.length === 0 || !selectedPaymentMethod}
                                    className={`w-full py-4 rounded-xl text-white text-xl font-bold shadow-lg transform transition active:scale-95 flex items-center justify-center space-x-2
                                        ${cart.length === 0 || !selectedPaymentMethod ? 'bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 hover:shadow-green-700/50'}`}
                                >
                                    <span>VALIDER & ENCAISSER</span>
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2m0 0l4-4m-4 4H7a2 2 0 000 4h10a2 2 0 100-4H9z"></path></svg>
                                </button>

                                <button 
                                    onClick={() => setIsHistoryOpen(true)}
                                    className="w-full py-3 rounded-lg text-white font-semibold shadow-lg transform transition active:scale-95 flex items-center justify-center space-x-2 bg-purple-600 hover:bg-purple-700 hover:shadow-purple-700/50"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                    <span>HISTORIQUE</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* --- CENTRE : CATALOGUE (55%) --- */}
                    <div className="w-1/2 flex flex-col h-full bg-gray-900 border-r border-gray-700">
                        
                        {/* Onglets Services & Recherche */}
                        <div className="p-4 bg-gray-800 shadow-lg sticky top-0 z-20">
                            <div className="flex mb-4 border-b border-gray-700">
                                {tabs.map(tab => (
                                    <button 
                                        key={tab}
                                        onClick={() => { setServiceTab(tab); setSearchQuery(''); }}
                                        className={`px-6 py-3 text-sm font-semibold transition duration-200 
                                            ${serviceTab === tab ? 'text-green-400 border-b-2 border-green-400' : 'text-gray-400 hover:text-white'}`}
                                    >
                                        {tab}
                                    </button>
                                ))}
                            </div>

                            <div className="relative flex items-center space-x-2">
                                <span className="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                </span>
                                <input 
                                    type="text" 
                                    placeholder={`Rechercher un article ou une ${serviceTab.toLowerCase()}...`} 
                                    className="flex-1 py-3 pl-10 pr-4 rounded-lg bg-gray-700 border border-gray-600 focus:bg-gray-800 focus:ring-2 focus:ring-blue-500 focus:outline-none text-white transition"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                />
                                
                                {/* Boutons d'ajout d'articles */}
                                <button 
                                    onClick={() => setIsAddSaleModalOpen(true)}
                                    className="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition text-sm whitespace-nowrap"
                                    title="Ajouter article en vente"
                                >
                                    + Vente
                                </button>
                                <button 
                                    onClick={() => setIsAddRentalModalOpen(true)}
                                    className="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition text-sm whitespace-nowrap"
                                    title="Ajouter article en location"
                                >
                                    + Location
                                </button>
                            </div>
                        </div>

                        {/* Grille Produits */}
                        <div className="flex-1 p-6 overflow-y-auto">
                            {filteredProducts.length === 0 ? (
                                <div className="text-center text-gray-500 mt-10">
                                    Aucun article trouv√© dans l'onglet "{serviceTab}".
                                </div>
                            ) : (
                                <div className="grid grid-cols-3 xl:grid-cols-4 gap-4">
                                    {filteredProducts.map((product) => (
                                        <div 
                                            key={product.id}
                                            onClick={() => addToCart(product)}
                                            className={`
                                                cursor-pointer relative h-40 rounded-xl shadow-lg border border-gray-700 
                                                hover:shadow-xl hover:border-blue-500 transition-all duration-200 
                                                flex flex-col items-center justify-center p-4 text-center no-select bg-gray-800
                                                active:scale-95 group overflow-hidden
                                            `}
                                        >
                                            {/* Banni√®re de Cat√©gorie/Couleur */}
                                            <div className={`absolute top-0 left-0 w-full h-1.5 ${product.color.replace('/30', '')}`}></div>
                                            
                                            {/* Ic√¥ne (simul√©e) */}
                                            <div className={`w-14 h-14 rounded-full mb-3 ${product.color} ${product.text} flex items-center justify-center text-xl font-bold`}>
                                                {product.name.charAt(0)}
                                            </div>
                                            
                                            <div className="font-bold text-gray-100 leading-tight mb-1">{product.name}</div>
                                            <div className="text-sm font-semibold text-green-400 bg-green-900/40 px-2 py-1 rounded-full">{formatPrice(product.price)}</div>

                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* --- MODES DE PAIEMENT --- */}
                    </div>

                    {/* --- DROITE : MODES DE PAIEMENT (20%) --- */}
                    <div className="w-1/5 flex flex-col bg-gray-800 border-l border-gray-700 shadow-lg">
                        <div className="p-4 bg-gray-900 text-white shadow-md sticky top-0 z-20">
                            <h3 className="text-sm font-bold text-gray-300">Mode de Paiement</h3>
                        </div>
                        
                        <div className="flex-1 flex flex-col p-4 overflow-y-auto space-y-3">
                            <div className="grid grid-cols-1 gap-3">
                                {paymentMethods.map((method) => (
                                    <button
                                        key={method.id}
                                        onClick={() => setSelectedPaymentMethod(method.id)}
                                        className={`
                                            py-3 px-3 rounded-lg text-sm font-semibold transition-all duration-200
                                            flex flex-col items-center justify-center space-y-2
                                            ${selectedPaymentMethod === method.id 
                                                ? `${method.color} text-white shadow-lg ring-2 ring-white scale-105` 
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                            }
                                        `}
                                    >
                                        <span className="text-2xl">{method.icon}</span>
                                        <span className="text-xs text-center leading-tight font-bold">{method.label}</span>
                                    </button>
                                ))}
                            </div>

                            {/* Affichage du mode s√©lectionn√© */}
                            {selectedPaymentMethod && (
                                <div className="mt-4 p-3 bg-gray-900 rounded border border-gray-700 text-center text-xs text-gray-300 sticky bottom-0">
                                    <div className="font-semibold text-gray-400 mb-1">S√©lectionn√©:</div>
                                    <div className="font-bold text-green-400">{paymentMethods.find(m => m.id === selectedPaymentMethod)?.label}</div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* --- MODES DE PAIEMENT FIN --- */}

                    {/* Modales Ajout d'Articles */}
                    <AddSaleModal 
                        isOpen={isAddSaleModalOpen}
                        onClose={() => setIsAddSaleModalOpen(false)}
                        onAddItem={handleAddSaleItem}
                    />
                    
                    <AddRentalModal 
                        isOpen={isAddRentalModalOpen}
                        onClose={() => setIsAddRentalModalOpen(false)}
                        onAddItem={handleAddRentalItem}
                    />

                    {/* Modale Gestion Clients */}
                    <ClientManagementModal 
                        isOpen={isClientModalOpen}
                        onClose={() => setIsClientModalOpen(false)}
                        clients={clients}
                        onAddClient={handleAddClient}
                        onSelectClient={handleSelectClient}
                        generateClientNumber={generateClientNumber}
                    />

                    {/* --- MODALE HISTORIQUE & RAPPORTS --- */}
                    {isHistoryOpen && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                            <div className="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-6xl max-h-[85vh] overflow-hidden flex flex-col">
                                {/* Header */}
                                <div className="p-4 bg-gray-900 border-b border-gray-700 flex justify-between items-center">
                                    <h2 className="text-xl font-bold text-white">üìä Historique & Rapports</h2>
                                    <button 
                                        onClick={() => setIsHistoryOpen(false)}
                                        className="text-gray-400 hover:text-white text-2xl font-bold"
                                    >√ó</button>
                                </div>

                                {/* Filtres */}
                                <div className="p-4 bg-gray-850 border-b border-gray-700 flex gap-3">
                                    <button 
                                        onClick={() => setHistoryFilter('jour')}
                                        className={`px-4 py-2 rounded-lg font-semibold transition ${
                                            historyFilter === 'jour' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >üìÖ Jour</button>
                                    <button 
                                        onClick={() => setHistoryFilter('mois')}
                                        className={`px-4 py-2 rounded-lg font-semibold transition ${
                                            historyFilter === 'mois' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >üìÜ Mois</button>
                                    <button 
                                        onClick={() => setHistoryFilter('annee')}
                                        className={`px-4 py-2 rounded-lg font-semibold transition ${
                                            historyFilter === 'annee' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >üìä Ann√©e</button>
                                </div>

                                {/* Statistiques */}
                                {(() => {
                                    const stats = getStats();
                                    return (
                                        <div className="p-4 bg-gray-800 border-b border-gray-700 grid grid-cols-3 gap-4">
                                            <div className="bg-green-900/30 p-3 rounded-lg border border-green-700">
                                                <div className="text-xs text-gray-400">Revenu Total</div>
                                                <div className="text-2xl font-bold text-green-400">{formatPrice(stats.totalRevenue)}</div>
                                            </div>
                                            <div className="bg-blue-900/30 p-3 rounded-lg border border-blue-700">
                                                <div className="text-xs text-gray-400">Transactions</div>
                                                <div className="text-2xl font-bold text-blue-400">{stats.totalTransactions}</div>
                                            </div>
                                            <div className="bg-purple-900/30 p-3 rounded-lg border border-purple-700">
                                                <div className="text-xs text-gray-400">Articles Vendus</div>
                                                <div className="text-2xl font-bold text-purple-400">{stats.totalItems}</div>
                                            </div>
                                        </div>
                                    );
                                })()}

                                {/* Liste des Transactions */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {getFilteredTransactions().length === 0 ? (
                                        <div className="text-center text-gray-500 py-8">
                                            Aucune transaction pour cette p√©riode
                                        </div>
                                    ) : (
                                        getFilteredTransactions().map(tx => (
                                            <div key={tx.id} className="bg-gray-700 p-3 rounded-lg border border-gray-600 text-sm">
                                                <div className="flex justify-between items-start mb-2">
                                                    <div>
                                                        <div className="font-bold text-white">{tx.client} ({tx.clientNum})</div>
                                                        <div className="text-xs text-gray-400">{new Date(tx.date).toLocaleString('fr-FR')}</div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="font-bold text-green-400">{formatPrice(tx.total)}</div>
                                                        <div className="text-xs text-gray-400">{tx.paymentMethod}</div>
                                                    </div>
                                                </div>
                                                <div className="text-xs text-gray-300 ml-2">
                                                    {tx.items.map((item, i) => (
                                                        <div key={i}>{item.qty}x {item.name}</div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>

                                {/* Footer */}
                                <div className="p-4 bg-gray-900 border-t border-gray-700 flex justify-end gap-2">
                                    <button 
                                        onClick={() => setIsHistoryOpen(false)}
                                        className="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-semibold transition"
                                    >Fermer</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODALE BACK OFFICE --- */}
                    {isBackOfficeOpen && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-2">
                            <div className="bg-gray-800 rounded-2xl shadow-2xl w-full h-full max-w-full max-h-full overflow-hidden flex flex-col">
                                {/* Header */}
                                <div className="p-4 bg-gray-900 border-b border-gray-700 flex justify-between items-center">
                                    <h2 className="text-2xl font-bold text-white">‚öôÔ∏è Back Office</h2>
                                    <button 
                                        onClick={() => setIsBackOfficeOpen(false)}
                                        className="text-gray-400 hover:text-white text-2xl font-bold"
                                    >√ó</button>
                                </div>

                                {/* Onglets */}
                                <div className="flex border-b border-gray-700 bg-gray-850 overflow-x-auto">
                                    <button 
                                        onClick={() => setBackOfficeTab('dashboard')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'dashboard' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >üìä Tableau de Bord</button>
                                    <button 
                                        onClick={() => setBackOfficeTab('suppliers')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'suppliers' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >üì¶ Fournisseurs</button>
                                    <button 
                                        onClick={() => setBackOfficeTab('articles')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'articles' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >üè∑Ô∏è Articles + Co√ªts</button>
                                    <button 
                                        onClick={() => setBackOfficeTab('stock')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'stock' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >üì¶ Stock</button>
                                    <button 
                                        onClick={() => setBackOfficeTab('finances')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'finances' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >üí∞ Finances</button>
                                    <button 
                                        onClick={() => setBackOfficeTab('clients')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'clients' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >üë• CRM Clients</button>
                                    <button 
                                        onClick={() => setBackOfficeTab('reports')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'reports' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >üìà Rapports</button>
                                </div>

                                {/* Contenu */}
                                <div className="flex-1 overflow-y-auto p-6">
                                    {/* --- ONGLET DASHBOARD --- */}
                                    {backOfficeTab === 'dashboard' && (
                                        <div className="space-y-6">
                                            <h2 className="text-3xl font-bold text-white mb-6">üìä Tableau de Bord Analytics</h2>
                                            
                                            {/* M√©triques cl√©s */}
                                            <div className="grid grid-cols-4 gap-4">
                                                <div className="bg-gradient-to-br from-blue-600 to-blue-800 p-4 rounded-lg border border-blue-500">
                                                    <div className="text-gray-300 text-sm font-semibold">Chiffre d'affaires total</div>
                                                    <div className="text-3xl font-bold text-white mt-2">
                                                        {transactions.reduce((sum, t) => sum + (t.total || 0), 0).toFixed(2)}‚Ç¨
                                                    </div>
                                                </div>
                                                <div className="bg-gradient-to-br from-green-600 to-green-800 p-4 rounded-lg border border-green-500">
                                                    <div className="text-gray-300 text-sm font-semibold">Nombre de transactions</div>
                                                    <div className="text-3xl font-bold text-white mt-2">{transactions.length}</div>
                                                </div>
                                                <div className="bg-gradient-to-br from-purple-600 to-purple-800 p-4 rounded-lg border border-purple-500">
                                                    <div className="text-gray-300 text-sm font-semibold">Ticket moyen</div>
                                                    <div className="text-3xl font-bold text-white mt-2">
                                                        {transactions.length > 0 
                                                            ? (transactions.reduce((sum, t) => sum + (t.total || 0), 0) / transactions.length).toFixed(2)
                                                            : '0.00'}‚Ç¨
                                                    </div>
                                                </div>
                                                <div className="bg-gradient-to-br from-orange-600 to-orange-800 p-4 rounded-lg border border-orange-500">
                                                    <div className="text-gray-300 text-sm font-semibold">Articles vendus</div>
                                                    <div className="text-3xl font-bold text-white mt-2">
                                                        {transactions.reduce((sum, t) => sum + (t.items?.length || 0), 0)}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Revenu par mode de paiement */}
                                            <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                <h3 className="text-xl font-bold text-white mb-4">üí≥ Revenu par mode de paiement</h3>
                                                <div className="space-y-3">
                                                    {(() => {
                                                        const paymentBreakdown = {
                                                            'especes': { total: 0, color: 'bg-green-600', label: 'üíµ Esp√®ces' },
                                                            'carte': { total: 0, color: 'bg-blue-600', label: 'üí≥ Carte' },
                                                            'cle-u': { total: 0, color: 'bg-purple-600', label: 'üîë Cl√©-U' },
                                                            'cheque': { total: 0, color: 'bg-yellow-600', label: 'üìã Ch√®que' },
                                                            'globalpos': { total: 0, color: 'bg-red-600', label: 'üåê GlobalPOS' }
                                                        };
                                                        
                                                        transactions.forEach(t => {
                                                            if (paymentBreakdown[t.paymentMethod]) {
                                                                paymentBreakdown[t.paymentMethod].total += t.total || 0;
                                                            }
                                                        });

                                                        const totalRevenue = Object.values(paymentBreakdown).reduce((sum, p) => sum + p.total, 0);
                                                        
                                                        return Object.entries(paymentBreakdown).map(([method, data]) => {
                                                            const percentage = totalRevenue > 0 ? (data.total / totalRevenue * 100).toFixed(1) : 0;
                                                            return (
                                                                <div key={method} className="space-y-2">
                                                                    <div className="flex justify-between items-center">
                                                                        <span className="text-gray-300">{data.label}</span>
                                                                        <span className="font-bold text-white">{data.total.toFixed(2)}‚Ç¨</span>
                                                                    </div>
                                                                    <div className="w-full bg-gray-700 rounded-full h-2">
                                                                        <div 
                                                                            className={`h-2 rounded-full ${data.color}`}
                                                                            style={{width: `${percentage}%`}}
                                                                        ></div>
                                                                    </div>
                                                                    <div className="text-right text-gray-400 text-sm">{percentage}%</div>
                                                                </div>
                                                            );
                                                        });
                                                    })()}
                                                </div>
                                            </div>

                                            {/* Top 5 Produits */}
                                            <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                <h3 className="text-xl font-bold text-white mb-4">üèÜ Top 5 Produits vendus</h3>
                                                <div className="space-y-4">
                                                    {(() => {
                                                        const productCounts = {};
                                                        
                                                        transactions.forEach(t => {
                                                            if (t.items && Array.isArray(t.items)) {
                                                                t.items.forEach(item => {
                                                                    const name = item.name || item.article || 'Sans nom';
                                                                    productCounts[name] = (productCounts[name] || 0) + (item.quantity || 1);
                                                                });
                                                            }
                                                        });
                                                        
                                                        const sortedProducts = Object.entries(productCounts)
                                                            .sort((a, b) => b[1] - a[1])
                                                            .slice(0, 5);

                                                        return sortedProducts.length > 0 ? (
                                                            sortedProducts.map((product, index) => (
                                                                <div key={product[0]} className="flex items-center space-x-4">
                                                                    <div className="bg-blue-600 rounded-full w-8 h-8 flex items-center justify-center font-bold text-white text-sm">
                                                                        {index + 1}
                                                                    </div>
                                                                    <div className="flex-1">
                                                                        <div className="font-semibold text-white">{product[0]}</div>
                                                                        <div className="w-full bg-gray-700 rounded-full h-2 mt-2">
                                                                            <div 
                                                                                className="bg-gradient-to-r from-blue-400 to-blue-600 h-2 rounded-full"
                                                                                style={{width: `${(product[1] / (sortedProducts[0]?.[1] || 1) * 100).toFixed(0)}%`}}
                                                                            ></div>
                                                                        </div>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <div className="font-bold text-white">{product[1]}</div>
                                                                        <div className="text-gray-400 text-sm">unit√©s</div>
                                                                    </div>
                                                                </div>
                                                            ))
                                                        ) : (
                                                            <div className="text-center text-gray-400 py-8">
                                                                Aucune transaction enregistr√©e
                                                            </div>
                                                        );
                                                    })()}
                                                </div>
                                            </div>

                                            {/* Activit√© par jour/mois/ann√©e */}
                                            <div className="grid grid-cols-3 gap-4">
                                                <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                    <h3 className="text-lg font-bold text-white mb-4">üìÖ Aujourd'hui</h3>
                                                    {(() => {
                                                        const today = new Date().toISOString().split('T')[0];
                                                        const todayTransactions = transactions.filter(t => 
                                                            t.date && t.date.startsWith(today)
                                                        );
                                                        return (
                                                            <div className="space-y-2">
                                                                <div className="text-2xl font-bold text-green-400">
                                                                    {todayTransactions.reduce((sum, t) => sum + (t.total || 0), 0).toFixed(2)}‚Ç¨
                                                                </div>
                                                                <div className="text-gray-400 text-sm">{todayTransactions.length} transactions</div>
                                                            </div>
                                                        );
                                                    })()}
                                                </div>
                                                <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                    <h3 className="text-lg font-bold text-white mb-4">üìÜ Ce mois</h3>
                                                    {(() => {
                                                        const now = new Date();
                                                        const monthTransactions = transactions.filter(t => {
                                                            if (!t.date) return false;
                                                            const tDate = new Date(t.date);
                                                            return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
                                                        });
                                                        return (
                                                            <div className="space-y-2">
                                                                <div className="text-2xl font-bold text-blue-400">
                                                                    {monthTransactions.reduce((sum, t) => sum + (t.total || 0), 0).toFixed(2)}‚Ç¨
                                                                </div>
                                                                <div className="text-gray-400 text-sm">{monthTransactions.length} transactions</div>
                                                            </div>
                                                        );
                                                    })()}
                                                </div>
                                                <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                    <h3 className="text-lg font-bold text-white mb-4">üìä Cette ann√©e</h3>
                                                    {(() => {
                                                        const now = new Date();
                                                        const yearTransactions = transactions.filter(t => {
                                                            if (!t.date) return false;
                                                            const tDate = new Date(t.date);
                                                            return tDate.getFullYear() === now.getFullYear();
                                                        });
                                                        return (
                                                            <div className="space-y-2">
                                                                <div className="text-2xl font-bold text-purple-400">
                                                                    {yearTransactions.reduce((sum, t) => sum + (t.total || 0), 0).toFixed(2)}‚Ç¨
                                                                </div>
                                                                <div className="text-gray-400 text-sm">{yearTransactions.length} transactions</div>
                                                            </div>
                                                        );
                                                    })()}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* --- ONGLET FOURNISSEURS --- */}
                                    {backOfficeTab === 'suppliers' && (
                                        <div className="space-y-4">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-lg font-bold text-white">Gestion des Fournisseurs</h3>
                                                <button 
                                                    onClick={() => {
                                                        const newSupplier = {
                                                            id: `SUP${String(suppliers.length + 1).padStart(3, '0')}`,
                                                            name: prompt('Nom du fournisseur:') || 'Nouveau Fournisseur',
                                                            email: prompt('Email:') || '',
                                                            phone: prompt('T√©l√©phone:') || '',
                                                            country: prompt('Pays:') || 'France'
                                                        };
                                                        const updated = [...suppliers, newSupplier];
                                                        setSuppliers(updated);
                                                        localStorage.setItem('posSuppliers', JSON.stringify(updated));
                                                        // üî• Sauvegarder dans Firebase
                                                        saveToFirestore('suppliers', newSupplier);
                                                    }}
                                                    className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded transition"
                                                >
                                                    + Ajouter Fournisseur
                                                </button>
                                            </div>

                                            <div className="grid grid-cols-1 gap-3">
                                                {suppliers.map(supplier => (
                                                    <div key={supplier.id} className="bg-gray-700 p-4 rounded-lg border border-gray-600 hover:border-blue-500 transition">
                                                        <div className="flex justify-between items-start">
                                                            <div className="flex-1">
                                                                <div className="font-bold text-white text-lg">{supplier.name}</div>
                                                                <div className="text-sm text-gray-400 mt-2 space-y-1">
                                                                    <div>üìß {supplier.email}</div>
                                                                    <div>üìû {supplier.phone}</div>
                                                                    <div>üåç {supplier.country}</div>
                                                                </div>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className="font-mono text-blue-400 font-semibold">{supplier.id}</div>
                                                                <button 
                                                                    onClick={() => {
                                                                        const updated = suppliers.filter(s => s.id !== supplier.id);
                                                                        setSuppliers(updated);
                                                                        localStorage.setItem('posSuppliers', JSON.stringify(updated));
                                                                    }}
                                                                    className="text-xs text-red-400 hover:text-red-300 mt-2"
                                                                >
                                                                    Supprimer
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* --- ONGLET ARTICLES + CO√õTS + FOURNISSEURS --- */}
                                    {backOfficeTab === 'articles' && (
                                        <div className="space-y-6">
                                            <div className="flex justify-between items-center">
                                                <h2 className="text-2xl font-bold text-white">üè∑Ô∏è Gestion des Articles & Fournisseurs</h2>
                                            </div>

                                            {/* Affichage de tous les articles */}
                                            <div className="space-y-4">
                                                <h3 className="text-xl font-bold text-white">üì¶ Catalogue Complet</h3>
                                                <div className="grid grid-cols-1 gap-4">
                                                    {MOCK_PRODUCTS.map(product => {
                                                        const supplier = productSuppliers[product.id];
                                                        const cost = productCosts[product.id] || 0;
                                                        const margin = product.price > 0 && cost > 0 
                                                            ? ((product.price - cost) / product.price * 100).toFixed(1)
                                                            : 0;
                                                        const stock = productStock[product.id] || 0;

                                                        return (
                                                            <div key={product.id} className="bg-gray-800 p-6 rounded-lg border border-gray-700 hover:border-blue-500 transition">
                                                                <div className="grid grid-cols-3 gap-4 mb-4">
                                                                    {/* Infos produit */}
                                                                    <div>
                                                                        <div className="font-bold text-white text-lg">{product.name}</div>
                                                                        <div className="text-xs font-mono text-gray-400 mt-1">Code: {product.barcode}</div>
                                                                        <div className="text-sm text-gray-300 mt-3 space-y-1">
                                                                            <div>üìÇ {product.category}</div>
                                                                            <div>üîÑ {product.isRentable ? 'üìç Location' : 'üõí Vente'}</div>
                                                                        </div>
                                                                    </div>

                                                                    {/* Prix et marge */}
                                                                    <div>
                                                                        <div className="text-sm text-gray-400 font-semibold mb-2">üí∞ Tarification</div>
                                                                        <div className="space-y-2">
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Prix de vente</div>
                                                                                <div className="text-xl font-bold text-green-400">{formatPrice(product.price)}</div>
                                                                            </div>
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Co√ªt d'achat</div>
                                                                                <div className="text-lg font-bold text-yellow-400">{cost.toFixed(2)}‚Ç¨</div>
                                                                            </div>
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Marge</div>
                                                                                <div className={`text-lg font-bold ${margin >= 30 ? 'text-green-400' : margin >= 20 ? 'text-yellow-400' : 'text-red-400'}`}>
                                                                                    {margin}%
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    {/* Fournisseur et stock */}
                                                                    <div>
                                                                        <div className="text-sm text-gray-400 font-semibold mb-2">üì¶ Fournisseur & Stock</div>
                                                                        <div className="space-y-2">
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Fournisseur</div>
                                                                                <select 
                                                                                    value={supplier?.id || ''}
                                                                                    onChange={(e) => {
                                                                                        const suppId = e.target.value;
                                                                                        if (suppId) {
                                                                                            const sup = suppliers.find(s => s.id === suppId);
                                                                                            setProductSuppliers(prev => ({
                                                                                                ...prev,
                                                                                                [product.id]: sup
                                                                                            }));
                                                                                            localStorage.setItem('posProductSuppliers', JSON.stringify({
                                                                                                ...productSuppliers,
                                                                                                [product.id]: sup
                                                                                            }));
                                                                                        }
                                                                                    }}
                                                                                    className="w-full px-2 py-1 bg-gray-700 text-white text-sm rounded border border-gray-600 focus:border-blue-500"
                                                                                >
                                                                                    <option value="">Choisir un fournisseur</option>
                                                                                    {suppliers.map(sup => (
                                                                                        <option key={sup.id} value={sup.id}>{sup.name}</option>
                                                                                    ))}
                                                                                </select>
                                                                                {supplier && <div className="text-xs text-blue-300 mt-1">‚úÖ {supplier.name}</div>}
                                                                            </div>
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Stock actuel</div>
                                                                                <div className="flex items-center space-x-2 mt-1">
                                                                                    <input 
                                                                                        type="number"
                                                                                        min="0"
                                                                                        value={stock}
                                                                                        onChange={(e) => {
                                                                                            const newStock = parseInt(e.target.value) || 0;
                                                                                            setProductStock(prev => ({
                                                                                                ...prev,
                                                                                                [product.id]: newStock
                                                                                            }));
                                                                                            localStorage.setItem('posProductStock', JSON.stringify({
                                                                                                ...productStock,
                                                                                                [product.id]: newStock
                                                                                            }));
                                                                                        }}
                                                                                        className="w-16 px-2 py-1 bg-gray-700 text-white text-sm rounded border border-gray-600 focus:border-blue-500"
                                                                                    />
                                                                                    <span className="text-sm text-gray-300">unit√©s</span>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                {/* Input pour le co√ªt d'achat */}
                                                                <div className="border-t border-gray-700 pt-4">
                                                                    <label className="block text-sm text-gray-400 font-semibold mb-2">üí≥ Entrer le co√ªt d'achat (‚Ç¨)</label>
                                                                    <div className="flex gap-2">
                                                                        <input 
                                                                            type="number"
                                                                            step="0.01"
                                                                            min="0"
                                                                            value={cost}
                                                                            onChange={(e) => {
                                                                                const newCost = parseFloat(e.target.value) || 0;
                                                                                setProductCosts(prev => ({
                                                                                    ...prev,
                                                                                    [product.id]: newCost
                                                                                }));
                                                                                localStorage.setItem('posProductCosts', JSON.stringify({
                                                                                    ...productCosts,
                                                                                    [product.id]: newCost
                                                                                }));
                                                                            }}
                                                                            className="flex-1 px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-green-500"
                                                                            placeholder="Co√ªt d'achat"
                                                                        />
                                                                        <div className="flex items-center px-3 bg-gray-700 rounded border border-gray-600 text-gray-300">
                                                                            Marge: <span className="ml-2 font-bold text-green-400">{margin}%</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* --- ONGLET STOCK --- */}
                                    {backOfficeTab === 'stock' && (
                                        <div className="space-y-6">
                                            <h2 className="text-2xl font-bold text-white">üì¶ Gestion de Stock</h2>

                                            {/* Vue r√©sum√©e - Alertes stock bas */}
                                            <div className="bg-gradient-to-r from-red-900 to-red-800 rounded-lg border border-red-700 p-6">
                                                <h3 className="text-lg font-bold text-white mb-4">‚ö†Ô∏è Articles en alerte stock</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    {MOCK_PRODUCTS.map(product => {
                                                        const stock = productStock[product.id] || 0;
                                                        const alertLevel = stockAlerts[product.id] || 10;
                                                        
                                                        if (stock <= alertLevel) {
                                                            return (
                                                                <div key={product.id} className="bg-gray-800 p-4 rounded-lg border border-red-600">
                                                                    <div className="flex justify-between items-start mb-2">
                                                                        <div className="font-bold text-white">{product.name}</div>
                                                                        <span className="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded">ALERTE</span>
                                                                    </div>
                                                                    <div className="flex justify-between items-center">
                                                                        <div className="text-sm text-gray-400">Stock actuel: <span className="text-red-400 font-bold text-lg">{stock}</span></div>
                                                                        <div className="text-sm text-gray-400">Seuil: <span className="text-yellow-400 font-bold">{alertLevel}</span></div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        }
                                                        return null;
                                                    })}
                                                    {!MOCK_PRODUCTS.some(p => {
                                                        const stock = productStock[p.id] || 0;
                                                        const alertLevel = stockAlerts[p.id] || 10;
                                                        return stock <= alertLevel;
                                                    }) && (
                                                        <div className="col-span-full text-center text-green-400 py-4">‚úÖ Tous les stocks sont suffisants !</div>
                                                    )}
                                                </div>
                                            </div>

                                            {/* Gestion d√©taill√©e du stock */}
                                            <div className="space-y-4">
                                                <h3 className="text-xl font-bold text-white">üìä Inventaire d√©taill√©</h3>
                                                <div className="grid grid-cols-1 gap-4">
                                                    {MOCK_PRODUCTS.map(product => {
                                                        const stock = productStock[product.id] || 0;
                                                        const alertLevel = stockAlerts[product.id] || 10;
                                                        const status = stock > alertLevel * 2 ? 'OK' : stock > alertLevel ? 'ATTENTION' : 'CRITIQUE';
                                                        const statusColor = status === 'OK' ? 'text-green-400' : status === 'ATTENTION' ? 'text-yellow-400' : 'text-red-400';
                                                        
                                                        return (
                                                            <div key={product.id} className="bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-blue-500 transition">
                                                                <div className="grid grid-cols-4 gap-4 items-center">
                                                                    {/* Infos produit */}
                                                                    <div>
                                                                        <div className="font-bold text-white">{product.name}</div>
                                                                        <div className="text-xs text-gray-400 mt-1">{product.barcode}</div>
                                                                    </div>

                                                                    {/* Stock actuel */}
                                                                    <div>
                                                                        <div className="text-sm text-gray-400">Stock actuel</div>
                                                                        <div className={`text-2xl font-bold ${statusColor}`}>{stock}</div>
                                                                    </div>

                                                                    {/* Seuil d'alerte */}
                                                                    <div>
                                                                        <div className="text-sm text-gray-400">Seuil d'alerte</div>
                                                                        <input 
                                                                            type="number"
                                                                            min="0"
                                                                            value={alertLevel}
                                                                            onChange={(e) => {
                                                                                const newAlert = parseInt(e.target.value) || 0;
                                                                                setStockAlerts(prev => ({
                                                                                    ...prev,
                                                                                    [product.id]: newAlert
                                                                                }));
                                                                                localStorage.setItem('posStockAlerts', JSON.stringify({
                                                                                    ...stockAlerts,
                                                                                    [product.id]: newAlert
                                                                                }));
                                                                            }}
                                                                            className="w-20 px-2 py-1 bg-gray-700 text-white rounded border border-gray-600 focus:border-yellow-500"
                                                                        />
                                                                    </div>

                                                                    {/* Boutons d'ajustement */}
                                                                    <div className="flex gap-2">
                                                                        <button 
                                                                            onClick={() => {
                                                                                const newStock = stock + 1;
                                                                                setProductStock(prev => ({...prev, [product.id]: newStock}));
                                                                                localStorage.setItem('posProductStock', JSON.stringify({...productStock, [product.id]: newStock}));
                                                                                recordStockMovement(product.id, 1, 'entr√©e', 'Ajustement manuel');
                                                                            }}
                                                                            className="px-2 py-1 bg-green-600 hover:bg-green-700 text-white text-sm rounded transition"
                                                                        >+1</button>
                                                                        <button 
                                                                            onClick={() => {
                                                                                if (stock > 0) {
                                                                                    const newStock = stock - 1;
                                                                                    setProductStock(prev => ({...prev, [product.id]: newStock}));
                                                                                    localStorage.setItem('posProductStock', JSON.stringify({...productStock, [product.id]: newStock}));
                                                                                    recordStockMovement(product.id, 1, 'sortie', 'Ajustement manuel');
                                                                                }
                                                                            }}
                                                                            className="px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition disabled:opacity-50"
                                                                            disabled={stock === 0}
                                                                        >-1</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>

                                            {/* Historique des mouvements */}
                                            <div className="space-y-4">
                                                <h3 className="text-xl font-bold text-white">üìú Historique des mouvements</h3>
                                                <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
                                                    {stockMovements.length > 0 ? (
                                                        <div className="space-y-2 max-h-96 overflow-y-auto">
                                                            {[...stockMovements].reverse().slice(0, 50).map(movement => (
                                                                <div key={movement.id} className={`p-3 rounded border-l-4 flex justify-between items-center ${
                                                                    movement.type === 'entr√©e' 
                                                                        ? 'bg-green-900/20 border-green-600' 
                                                                        : 'bg-red-900/20 border-red-600'
                                                                }`}>
                                                                    <div className="flex-1">
                                                                        <div className="font-semibold text-white">{movement.productName}</div>
                                                                        <div className="text-sm text-gray-400">
                                                                            {movement.reason} ¬∑ {new Date(movement.date).toLocaleString('fr-FR')}
                                                                        </div>
                                                                    </div>
                                                                    <div className={`text-lg font-bold ${movement.type === 'entr√©e' ? 'text-green-400' : 'text-red-400'}`}>
                                                                        {movement.type === 'entr√©e' ? '+' : '-'}{movement.quantity}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <div className="text-center text-gray-400 py-8">Aucun mouvement enregistr√©</div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* --- ONGLET FINANCES --- */}
                                    {backOfficeTab === 'finances' && (
                                        <div className="space-y-6">
                                            <h2 className="text-2xl font-bold text-white">üí∞ Gestion Financi√®re</h2>

                                            {(() => {
                                                // Bilan du jour
                                                const today = new Date();
                                                today.setHours(0, 0, 0, 0);
                                                const tomorrowStart = new Date(today);
                                                tomorrowStart.setDate(tomorrowStart.getDate() + 1);

                                                // Bilan du mois
                                                const monthStart = new Date(today);
                                                monthStart.setDate(1);
                                                const monthEnd = new Date(today);
                                                monthEnd.setDate(monthEnd.getDate() + 1);

                                                // Bilan de l'ann√©e
                                                const yearStart = new Date(today);
                                                yearStart.setMonth(0, 1);
                                                const yearEnd = new Date(today);
                                                yearEnd.setDate(yearEnd.getDate() + 1);

                                                const dailyStats = getFinancialStats(today, tomorrowStart);
                                                const monthlyStats = getFinancialStats(monthStart, monthEnd);
                                                const yearlyStats = getFinancialStats(yearStart, yearEnd);

                                                return (
                                                    <>
                                                        {/* Bilans rapides */}
                                                        <div className="grid grid-cols-3 gap-4">
                                                            {/* Bilan du jour */}
                                                            <div className="bg-gradient-to-br from-blue-900 to-blue-800 rounded-lg border border-blue-600 p-6">
                                                                <h3 className="text-lg font-bold text-white mb-4">üìÖ Bilan du jour</h3>
                                                                <div className="space-y-3">
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Chiffre d'affaires</div>
                                                                        <div className="text-2xl font-bold text-green-400">{dailyStats.totalRevenue.toFixed(2)}‚Ç¨</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Co√ªts produits</div>
                                                                        <div className="text-lg text-yellow-400">{dailyStats.totalCost.toFixed(2)}‚Ç¨</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">D√©penses</div>
                                                                        <div className="text-lg text-red-400">{dailyStats.totalExpenses.toFixed(2)}‚Ç¨</div>
                                                                    </div>
                                                                    <div className="border-t border-blue-700 pt-3">
                                                                        <div className="text-xs text-gray-300">B√©n√©fice net</div>
                                                                        <div className={`text-2xl font-bold ${dailyStats.netProfit >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                                            {dailyStats.netProfit.toFixed(2)}‚Ç¨
                                                                        </div>
                                                                        <div className="text-xs text-gray-400 mt-1">Marge: {dailyStats.profitMargin}%</div>
                                                                    </div>
                                                                    <div className="text-xs text-gray-400 mt-2">{dailyStats.totalTransactions} transactions</div>
                                                                </div>
                                                            </div>

                                                            {/* Bilan du mois */}
                                                            <div className="bg-gradient-to-br from-purple-900 to-purple-800 rounded-lg border border-purple-600 p-6">
                                                                <h3 className="text-lg font-bold text-white mb-4">üìÜ Bilan du mois</h3>
                                                                <div className="space-y-3">
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Chiffre d'affaires</div>
                                                                        <div className="text-2xl font-bold text-green-400">{monthlyStats.totalRevenue.toFixed(2)}‚Ç¨</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Co√ªts produits</div>
                                                                        <div className="text-lg text-yellow-400">{monthlyStats.totalCost.toFixed(2)}‚Ç¨</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">D√©penses</div>
                                                                        <div className="text-lg text-red-400">{monthlyStats.totalExpenses.toFixed(2)}‚Ç¨</div>
                                                                    </div>
                                                                    <div className="border-t border-purple-700 pt-3">
                                                                        <div className="text-xs text-gray-300">B√©n√©fice net</div>
                                                                        <div className={`text-2xl font-bold ${monthlyStats.netProfit >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                                            {monthlyStats.netProfit.toFixed(2)}‚Ç¨
                                                                        </div>
                                                                        <div className="text-xs text-gray-400 mt-1">Marge: {monthlyStats.profitMargin}%</div>
                                                                    </div>
                                                                    <div className="text-xs text-gray-400 mt-2">{monthlyStats.totalTransactions} transactions</div>
                                                                </div>
                                                            </div>

                                                            {/* Bilan de l'ann√©e */}
                                                            <div className="bg-gradient-to-br from-orange-900 to-orange-800 rounded-lg border border-orange-600 p-6">
                                                                <h3 className="text-lg font-bold text-white mb-4">üìä Bilan de l'ann√©e</h3>
                                                                <div className="space-y-3">
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Chiffre d'affaires</div>
                                                                        <div className="text-2xl font-bold text-green-400">{yearlyStats.totalRevenue.toFixed(2)}‚Ç¨</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Co√ªts produits</div>
                                                                        <div className="text-lg text-yellow-400">{yearlyStats.totalCost.toFixed(2)}‚Ç¨</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">D√©penses</div>
                                                                        <div className="text-lg text-red-400">{yearlyStats.totalExpenses.toFixed(2)}‚Ç¨</div>
                                                                    </div>
                                                                    <div className="border-t border-orange-700 pt-3">
                                                                        <div className="text-xs text-gray-300">B√©n√©fice net</div>
                                                                        <div className={`text-2xl font-bold ${yearlyStats.netProfit >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                                            {yearlyStats.netProfit.toFixed(2)}‚Ç¨
                                                                        </div>
                                                                        <div className="text-xs text-gray-400 mt-1">Marge: {yearlyStats.profitMargin}%</div>
                                                                    </div>
                                                                    <div className="text-xs text-gray-400 mt-2">{yearlyStats.totalTransactions} transactions</div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Gestion des d√©penses */}
                                                        <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                            <h3 className="text-xl font-bold text-white mb-4">üìã Enregistrer une d√©pense</h3>
                                                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                                                <select 
                                                                    id="expenseCategory"
                                                                    defaultValue="autre"
                                                                    className="px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500"
                                                                >
                                                                    <option value="salaires">üë• Salaires & Charges</option>
                                                                    <option value="loyer">üè† Loyer</option>
                                                                    <option value="fournitures">üì¶ Fournitures</option>
                                                                    <option value="maintenance">üîß Maintenance & R√©parations</option>
                                                                    <option value="transport">üöö Transport & Logistique</option>
                                                                    <option value="utilities">üí° √âlectricit√© & Eau</option>
                                                                    <option value="assurance">üõ°Ô∏è Assurance</option>
                                                                    <option value="marketing">üì¢ Marketing & Publicit√©</option>
                                                                    <option value="autre">üìå Autre</option>
                                                                </select>
                                                                <input 
                                                                    type="number"
                                                                    id="expenseAmount"
                                                                    placeholder="Montant (‚Ç¨)"
                                                                    step="0.01"
                                                                    min="0"
                                                                    className="px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500"
                                                                />
                                                                <input 
                                                                    type="text"
                                                                    id="expenseDescription"
                                                                    placeholder="Description (optionnel)"
                                                                    className="px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500"
                                                                />
                                                                <button 
                                                                    onClick={() => {
                                                                        const category = document.getElementById('expenseCategory').value;
                                                                        const amount = parseFloat(document.getElementById('expenseAmount').value);
                                                                        const description = document.getElementById('expenseDescription').value;
                                                                        
                                                                        if (amount > 0) {
                                                                            addExpense(category, amount, description);
                                                                            document.getElementById('expenseAmount').value = '';
                                                                            document.getElementById('expenseDescription').value = '';
                                                                            alert('D√©pense enregistr√©e !');
                                                                        }
                                                                    }}
                                                                    className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded transition"
                                                                >
                                                                    ‚úì Ajouter
                                                                </button>
                                                            </div>
                                                        </div>

                                                        {/* Historique des d√©penses */}
                                                        <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                            <h3 className="text-xl font-bold text-white mb-4">üìú Historique des d√©penses</h3>
                                                            <div className="space-y-2 max-h-64 overflow-y-auto">
                                                                {expenses.length > 0 ? (
                                                                    [...expenses].reverse().map(expense => (
                                                                        <div key={expense.id} className="bg-gray-700 p-3 rounded border-l-4 border-red-600 flex justify-between items-center hover:bg-gray-650 transition">
                                                                            <div className="flex-1">
                                                                                <div className="font-semibold text-white">{expense.category}</div>
                                                                                <div className="text-sm text-gray-400">{expense.description || 'Aucune description'}</div>
                                                                                <div className="text-xs text-gray-500">{new Date(expense.date).toLocaleString('fr-FR')}</div>
                                                                            </div>
                                                                            <div className="text-lg font-bold text-red-400">-{expense.amount.toFixed(2)}‚Ç¨</div>
                                                                        </div>
                                                                    ))
                                                                ) : (
                                                                    <div className="text-center text-gray-400 py-8">Aucune d√©pense enregistr√©e</div>
                                                                )}
                                                            </div>
                                                        </div>

                                                        {/* Rapports TVA */}
                                                        <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                            <h3 className="text-xl font-bold text-white mb-4">üßæ Rapports TVA</h3>
                                                            <div className="grid grid-cols-3 gap-4">
                                                                <div>
                                                                    <div className="text-sm text-gray-400 font-semibold mb-3">Taux TVA standard: 20%</div>
                                                                    <div className="space-y-2">
                                                                        <div className="flex justify-between">
                                                                            <span className="text-gray-300">CA journalier TTC:</span>
                                                                            <span className="text-white font-bold">{dailyStats.totalRevenue.toFixed(2)}‚Ç¨</span>
                                                                        </div>
                                                                        <div className="flex justify-between bg-gray-700 p-2 rounded">
                                                                            <span className="text-gray-300">CA HT:</span>
                                                                            <span className="text-green-400 font-bold">{(dailyStats.totalRevenue / 1.20).toFixed(2)}‚Ç¨</span>
                                                                        </div>
                                                                        <div className="flex justify-between bg-blue-900/30 p-2 rounded border border-blue-700">
                                                                            <span className="text-gray-300">TVA due:</span>
                                                                            <span className="text-blue-400 font-bold">{(dailyStats.totalRevenue - dailyStats.totalRevenue / 1.20).toFixed(2)}‚Ç¨</span>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div>
                                                                    <div className="text-sm text-gray-400 font-semibold mb-3">Mensuel</div>
                                                                    <div className="space-y-2">
                                                                        <div className="flex justify-between">
                                                                            <span className="text-gray-300">CA mensuel TTC:</span>
                                                                            <span className="text-white font-bold">{monthlyStats.totalRevenue.toFixed(2)}‚Ç¨</span>
                                                                        </div>
                                                                        <div className="flex justify-between bg-gray-700 p-2 rounded">
                                                                            <span className="text-gray-300">CA HT:</span>
                                                                            <span className="text-green-400 font-bold">{(monthlyStats.totalRevenue / 1.20).toFixed(2)}‚Ç¨</span>
                                                                        </div>
                                                                        <div className="flex justify-between bg-blue-900/30 p-2 rounded border border-blue-700">
                                                                            <span className="text-gray-300">TVA due:</span>
                                                                            <span className="text-blue-400 font-bold">{(monthlyStats.totalRevenue - monthlyStats.totalRevenue / 1.20).toFixed(2)}‚Ç¨</span>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div>
                                                                    <div className="text-sm text-gray-400 font-semibold mb-3">Annuel</div>
                                                                    <div className="space-y-2">
                                                                        <div className="flex justify-between">
                                                                            <span className="text-gray-300">CA annuel TTC:</span>
                                                                            <span className="text-white font-bold">{yearlyStats.totalRevenue.toFixed(2)}‚Ç¨</span>
                                                                        </div>
                                                                        <div className="flex justify-between bg-gray-700 p-2 rounded">
                                                                            <span className="text-gray-300">CA HT:</span>
                                                                            <span className="text-green-400 font-bold">{(yearlyStats.totalRevenue / 1.20).toFixed(2)}‚Ç¨</span>
                                                                        </div>
                                                                        <div className="flex justify-between bg-blue-900/30 p-2 rounded border border-blue-700">
                                                                            <span className="text-gray-300">TVA due:</span>
                                                                            <span className="text-blue-400 font-bold">{(yearlyStats.totalRevenue - yearlyStats.totalRevenue / 1.20).toFixed(2)}‚Ç¨</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </>
                                                );
                                            })()}
                                        </div>
                                    )}

                                    {/* --- ONGLET CRM CLIENTS --- */}
                                    {backOfficeTab === 'clients' && (
                                        <div className="space-y-6">
                                            <h2 className="text-2xl font-bold text-white">üë• Gestion CRM Clients</h2>

                                            {/* Vue d'ensemble clients par segment */}
                                            <div className="grid grid-cols-5 gap-4">
                                                {(() => {
                                                    const segments = {
                                                        'VIP': { icon: 'üëë', color: 'from-yellow-900 to-yellow-800', border: 'border-yellow-600', count: 0 },
                                                        'Premium': { icon: 'üíé', color: 'from-purple-900 to-purple-800', border: 'border-purple-600', count: 0 },
                                                        'Fid√®le': { icon: '‚≠ê', color: 'from-blue-900 to-blue-800', border: 'border-blue-600', count: 0 },
                                                        'R√©gulier': { icon: '‚úì', color: 'from-green-900 to-green-800', border: 'border-green-600', count: 0 },
                                                        'Nouveau': { icon: 'üÜï', color: 'from-gray-700 to-gray-800', border: 'border-gray-600', count: 0 }
                                                    };

                                                    clients.forEach(client => {
                                                        const segment = getClientSegment(client.num);
                                                        segments[segment.name].count++;
                                                    });

                                                    return Object.entries(segments).map(([name, data]) => (
                                                        <div key={name} className={`bg-gradient-to-br ${data.color} rounded-lg border ${data.border} p-4`}>
                                                            <div className="text-2xl mb-2">{data.icon}</div>
                                                            <div className="text-sm text-gray-300">{name}</div>
                                                            <div className="text-3xl font-bold text-white mt-2">{data.count}</div>
                                                        </div>
                                                    ));
                                                })()}
                                            </div>

                                            {/* Liste d√©taill√©e des clients */}
                                            <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                <h3 className="text-xl font-bold text-white mb-4">üìã D√©tail des clients</h3>
                                                <div className="space-y-3">
                                                    {clients.map(client => {
                                                        const segment = getClientSegment(client.num);
                                                        const loyaltyPoints = calculateLoyaltyPoints(client.num);
                                                        const purchaseHistory = getClientPurchaseHistory(client.num);
                                                        const totalSpent = purchaseHistory.reduce((sum, t) => sum + (t.total || 0), 0);

                                                        return (
                                                            <details key={client.num} className="bg-gray-700 rounded-lg border border-gray-600 hover:border-blue-500 transition cursor-pointer group">
                                                                <summary className="p-4 font-semibold text-white flex justify-between items-center">
                                                                    <div className="flex items-center gap-4 flex-1">
                                                                        <div className="text-2xl">{segment.icon}</div>
                                                                        <div>
                                                                            <div className="font-bold text-lg">{client.name}</div>
                                                                            <div className="text-sm text-gray-400">{client.num} ‚Ä¢ üìß {client.email}</div>
                                                                        </div>
                                                                    </div>
                                                                    <div className="flex items-center gap-6 mr-4">
                                                                        <div className="text-right">
                                                                            <div className="text-xs text-gray-400">Segment</div>
                                                                            <div className="font-bold text-amber-400">{segment.name}</div>
                                                                        </div>
                                                                        <div className="text-right">
                                                                            <div className="text-xs text-gray-400">Points fid√©lit√©</div>
                                                                            <div className="font-bold text-green-400">{loyaltyPoints} pts</div>
                                                                        </div>
                                                                    </div>
                                                                </summary>
                                                                <div className="px-4 pb-4 border-t border-gray-600 pt-4 space-y-4">
                                                                    {/* Info client */}
                                                                    <div className="grid grid-cols-3 gap-4">
                                                                        <div>
                                                                            <div className="text-xs text-gray-400 font-semibold">üìû T√©l√©phone</div>
                                                                            <div className="text-white mt-1">{client.phone || 'Non renseign√©'}</div>
                                                                        </div>
                                                                        <div>
                                                                            <div className="text-xs text-gray-400 font-semibold">üè† Adresse</div>
                                                                            <div className="text-white mt-1">{client.address || 'Non renseign√©e'}</div>
                                                                        </div>
                                                                        <div>
                                                                            <div className="text-xs text-gray-400 font-semibold">üìÖ Depuis</div>
                                                                            <div className="text-white mt-1">{client.joinDate || 'Non renseign√©'}</div>
                                                                        </div>
                                                                    </div>

                                                                    {/* Statistiques */}
                                                                    <div className="bg-gray-800 rounded-lg p-4 border border-gray-600">
                                                                        <div className="text-sm font-semibold text-gray-300 mb-3">üìä Statistiques d'achat</div>
                                                                        <div className="grid grid-cols-4 gap-4">
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Total d√©pens√©</div>
                                                                                <div className="text-xl font-bold text-green-400">{totalSpent.toFixed(2)}‚Ç¨</div>
                                                                            </div>
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Nb transactions</div>
                                                                                <div className="text-xl font-bold text-blue-400">{purchaseHistory.length}</div>
                                                                            </div>
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Ticket moyen</div>
                                                                                <div className="text-xl font-bold text-purple-400">
                                                                                    {purchaseHistory.length > 0 
                                                                                        ? (totalSpent / purchaseHistory.length).toFixed(2)
                                                                                        : 0}‚Ç¨
                                                                                </div>
                                                                            </div>
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Fid√©lit√©</div>
                                                                                <div className="text-xl font-bold text-amber-400">{loyaltyPoints} pts</div>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    {/* Historique d'achats */}
                                                                    <div>
                                                                        <div className="text-sm font-semibold text-gray-300 mb-3">üìú Historique d'achats</div>
                                                                        <div className="space-y-2 max-h-48 overflow-y-auto">
                                                                            {purchaseHistory.length > 0 ? (
                                                                                purchaseHistory.map((transaction, idx) => (
                                                                                    <div key={idx} className="bg-gray-800 p-3 rounded border-l-4 border-blue-600 flex justify-between items-center text-sm">
                                                                                        <div>
                                                                                            <div className="text-gray-300">
                                                                                                {transaction.items?.length || 0} article(s) ‚Ä¢ 
                                                                                                <span className="text-gray-500 ml-2">{new Date(transaction.date).toLocaleString('fr-FR')}</span>
                                                                                            </div>
                                                                                            <div className="text-xs text-gray-500 mt-1">
                                                                                                {transaction.items?.map(i => i.name || i.article).join(', ')}
                                                                                            </div>
                                                                                        </div>
                                                                                        <div className="text-right">
                                                                                            <div className="font-bold text-green-400">{(transaction.total || 0).toFixed(2)}‚Ç¨</div>
                                                                                            <div className="text-xs text-gray-500">{transaction.paymentMethod}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                ))
                                                                            ) : (
                                                                                <div className="text-center text-gray-400 py-4">Aucune transaction</div>
                                                                            )}
                                                                        </div>
                                                                    </div>

                                                                    {/* Actions */}
                                                                    <div className="flex gap-2 pt-4 border-t border-gray-600">
                                                                        <button 
                                                                            onClick={() => {
                                                                                const points = prompt(`Ajouter des points de fid√©lit√© (actuel: ${loyaltyPoints}):`);
                                                                                if (points && !isNaN(points)) {
                                                                                    addLoyaltyPoints(client.num, parseInt(points));
                                                                                }
                                                                            }}
                                                                            className="px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded transition"
                                                                        >
                                                                            ‚ûï Points
                                                                        </button>
                                                                        <button 
                                                                            onClick={() => {
                                                                                const newEmail = prompt('Nouvelle adresse email:', client.email);
                                                                                if (newEmail) {
                                                                                    setClients(prev => prev.map(c => 
                                                                                        c.num === client.num ? { ...c, email: newEmail } : c
                                                                                    ));
                                                                                }
                                                                            }}
                                                                            className="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded transition"
                                                                        >
                                                                            ‚úèÔ∏è Modifier
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </details>
                                                        );
                                                    })}
                                                </div>
                                            </div>

                                            {/* Vue Segmentation */}
                                            <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                <h3 className="text-xl font-bold text-white mb-4">üéØ Analyse de Segmentation</h3>
                                                <div className="space-y-4">
                                                    {(() => {
                                                        const segmentDetails = {
                                                            'VIP': { clients: [], description: 'Top clients (CA ‚â• 5000‚Ç¨ ou ‚â• 50 transactions)' },
                                                            'Premium': { clients: [], description: 'Gros clients (CA ‚â• 2000‚Ç¨ ou ‚â• 20 transactions)' },
                                                            'Fid√®le': { clients: [], description: 'Clients r√©guliers (CA ‚â• 500‚Ç¨ ou ‚â• 5 transactions)' },
                                                            'R√©gulier': { clients: [], description: 'Clients avec achat (CA > 0)' },
                                                            'Nouveau': { clients: [], description: 'Pas encore achet√©' }
                                                        };

                                                        clients.forEach(client => {
                                                            const segment = getClientSegment(client.num);
                                                            segmentDetails[segment.name].clients.push(client);
                                                        });

                                                        return Object.entries(segmentDetails).map(([name, data]) => {
                                                            const avgValue = data.clients.length > 0
                                                                ? data.clients.reduce((sum, c) => {
                                                                    const transactions = getClientPurchaseHistory(c.num);
                                                                    return sum + transactions.reduce((s, t) => s + (t.total || 0), 0);
                                                                }, 0) / data.clients.length
                                                                : 0;

                                                            return (
                                                                <div key={name} className="bg-gray-700 p-4 rounded-lg border border-gray-600">
                                                                    <div className="flex justify-between items-start mb-2">
                                                                        <div>
                                                                            <div className="font-bold text-white text-lg">{name}</div>
                                                                            <div className="text-sm text-gray-400">{data.description}</div>
                                                                        </div>
                                                                        <div className="text-right">
                                                                            <div className="text-2xl font-bold text-blue-400">{data.clients.length}</div>
                                                                            <div className="text-xs text-gray-400">clients</div>
                                                                        </div>
                                                                    </div>
                                                                    <div className="flex items-center justify-between pt-2 border-t border-gray-600">
                                                                        <span className="text-sm text-gray-400">Valeur moyenne par client</span>
                                                                        <span className="text-lg font-bold text-green-400">{avgValue.toFixed(2)}‚Ç¨</span>
                                                                    </div>
                                                                </div>
                                                            );
                                                        });
                                                    })()}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* --- ONGLET RAPPORTS --- */}
                                    {backOfficeTab === 'reports' && (
                                        <div className="space-y-4">
                                            <h3 className="text-lg font-bold text-white">Rapports de Vente</h3>
                                            <div className="grid grid-cols-3 gap-4">
                                                <div className="bg-green-900/30 p-4 rounded-lg border border-green-700">
                                                    <div className="text-sm text-gray-400">Total Articles</div>
                                                    <div className="text-3xl font-bold text-green-400">{MOCK_PRODUCTS.length}</div>
                                                </div>
                                                <div className="bg-blue-900/30 p-4 rounded-lg border border-blue-700">
                                                    <div className="text-sm text-gray-400">Fournisseurs</div>
                                                    <div className="text-3xl font-bold text-blue-400">{suppliers.length}</div>
                                                </div>
                                                <div className="bg-purple-900/30 p-4 rounded-lg border border-purple-700">
                                                    <div className="text-sm text-gray-400">Clients</div>
                                                    <div className="text-3xl font-bold text-purple-400">{clients.length}</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Footer */}
                                <div className="p-4 bg-gray-900 border-t border-gray-700 flex justify-end">
                                    <button 
                                        onClick={() => setIsBackOfficeOpen(false)}
                                        className="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-semibold transition"
                                    >Fermer</button>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<POS />);
    </script>
</body>
</html>
