<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS POS Sport - Prototype Dark</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- SheetJS pour lire les fichiers Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- JsBarcode pour générer les codes-barres -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <!-- html2pdf pour exporter en PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Firebase v9+ via CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        /* Styles pour le mode Dark */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #2d3748; } /* gray-800 */
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 3px; } /* gray-600 */
        ::-webkit-scrollbar-thumb:hover { background: #718096; } /* gray-500 */
        .no-select { user-select: none; }

        /* Styles d'impression du ticket */
        @media print {
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                background: white;
                color: black;
                width: 80mm;
                margin: 0 auto;
            }

            .print-ticket {
                width: 80mm;
                background: white;
                color: black;
                padding: 5mm;
                font-family: 'Courier New', monospace;
                font-size: 12px;
                line-height: 1.4;
            }

            .print-ticket .ticket-header {
                text-align: center;
                border-bottom: 1px dashed black;
                padding-bottom: 5mm;
                margin-bottom: 5mm;
            }

            .print-ticket .ticket-title {
                font-size: 16px;
                font-weight: bold;
                margin-bottom: 2mm;
            }

            .print-ticket .ticket-line {
                display: flex;
                justify-content: space-between;
                padding: 2mm 0;
                border-bottom: 1px dotted #ccc;
            }

            .print-ticket .ticket-total {
                font-weight: bold;
                font-size: 14px;
                margin-top: 3mm;
                padding-top: 3mm;
                border-top: 1px solid black;
                display: flex;
                justify-content: space-between;
            }

            .print-ticket .ticket-footer {
                text-align: center;
                font-size: 10px;
                margin-top: 5mm;
                padding-top: 5mm;
                border-top: 1px dashed black;
            }

            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-900 h-screen w-screen overflow-hidden text-white">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- INITIALISATION FIREBASE ---
        let db = null;
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyCJbnlwr0mawraiMZg5bxhJAGTU50Athk4",
                authDomain: "pos-sport.firebaseapp.com",
                projectId: "pos-sport",
                storageBucket: "pos-sport.firebasestorage.app",
                messagingSenderId: "1097156311402",
                appId: "1:1097156311402:web:46ba58865996e471b70d13",
                measurementId: "G-NVM7ZNZZYB"
            };

            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('✅ Firebase Firestore connecté');
        } catch (error) {
            console.warn('⚠️ Firebase non disponible:', error.message);
        }

        // --- FONCTIONS DE SAUVEGARDE FIRESTORE ---
        const saveToFirestore = async (collectionName, data) => {
            if (!db) {
                console.warn('Firebase non disponible, données sauvegardées localement');
                return;
            }
            try {
                await db.collection(collectionName).add({
                    ...data,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log(`✅ ${collectionName} sauvegardé dans Firestore`);
            } catch (error) {
                console.error(`❌ Erreur Firestore ${collectionName}:`, error.message);
            }
        };

        const updateFirestore = async (collectionName, docId, data) => {
            if (!db) return;
            try {
                await db.collection(collectionName).doc(docId).update(data);
                console.log(`✅ ${collectionName} mis à jour`);
            } catch (error) {
                console.error(`❌ Erreur mise à jour ${collectionName}:`, error.message);
            }
        };

        // --- SYNCHRONISATION PERMISSIONS AVEC FIRESTORE ---
        const savePermissionsToFirebase = async (permsData) => {
            if (!db) {
                console.warn('Firebase non disponible, permissions sauvegardées localement');
                return;
            }
            try {
                await db.collection('settings').doc('permissions').set(permsData, { merge: true });
                console.log('✅ Permissions sauvegardées dans Firestore');
            } catch (error) {
                console.error('❌ Erreur sauvegarde permissions:', error.message);
            }
        };

        const loadPermissionsFromFirebase = async () => {
            if (!db) {
                console.warn('Firebase non disponible');
                return null;
            }
            try {
                const docSnap = await db.collection('settings').doc('permissions').get();
                if (docSnap.exists) {
                    console.log('✅ Permissions chargées depuis Firestore');
                    return docSnap.data();
                }
                return null;
            } catch (error) {
                console.error('❌ Erreur chargement permissions:', error.message);
                return null;
            }
        };

        // --- SYNCHRONISATION UTILISATEURS AVEC FIRESTORE ---
        const saveUsersToFirebase = async (usersData) => {
            if (!db) return;
            try {
                await db.collection('settings').doc('users').set({ users: usersData }, { merge: true });
                console.log('✅ Utilisateurs sauvegardés dans Firestore');
            } catch (error) {
                console.error('❌ Erreur sauvegarde utilisateurs:', error.message);
            }
        };

        const loadUsersFromFirebase = async () => {
            if (!db) return null;
            try {
                const docSnap = await db.collection('settings').doc('users').get();
                if (docSnap.exists && docSnap.data().users) {
                    console.log('✅ Utilisateurs chargés depuis Firestore');
                    return docSnap.data().users;
                }
                return null;
            } catch (error) {
                console.error('❌ Erreur chargement utilisateurs:', error.message);
                return null;
            }
        };

        // --- COMPOSANT MODALE AJOUT ARTICLE EN VENTE ---
        const AddSaleModal = ({ isOpen, onClose, onAddItem }) => {
            const [name, setName] = useState('');
            const [price, setPrice] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name || !price) {
                    alert('Veuillez remplir tous les champs');
                    return;
                }
                onAddItem(name, price);
                setName('');
                setPrice('');
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                    <div className="bg-gray-800 rounded-xl p-8 w-full max-w-md shadow-2xl border border-gray-700">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">Ajouter Article en Vente</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">✕</button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-300 mb-2">Nom de l'article *</label>
                                <input 
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    placeholder="Ex: Bonnet Laine"
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-gray-300 mb-2">Prix (€) *</label>
                                <input 
                                    type="number"
                                    step="0.01"
                                    value={price}
                                    onChange={(e) => setPrice(e.target.value)}
                                    placeholder="Ex: 29.99"
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    required
                                />
                            </div>

                            <div className="flex space-x-4 pt-6 border-t border-gray-700">
                                <button type="submit" className="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                    Ajouter
                                </button>
                                <button type="button" onClick={onClose} className="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">
                                    Annuler
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- COMPOSANT MODALE AJOUT ARTICLE EN LOCATION ---
        const AddRentalModal = ({ isOpen, onClose, onAddItem }) => {
            const [name, setName] = useState('');
            const [priceFullDay, setPriceFullDay] = useState('');
            const [priceHalfDay, setPriceHalfDay] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [rentalType, setRentalType] = useState('fullday'); // 'fullday' ou 'halfday'

            // Calcul du nombre de jours et du prix total
            const calculateDuration = () => {
                if (!startDate || !endDate) return { days: 0, total: 0, display: '' };
                
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let total = 0;
                let display = '';
                
                if (rentalType === 'fullday') {
                    total = diffDays * parseFloat(priceFullDay || 0);
                    display = `${diffDays} jour(s) × ${priceFullDay}€ = ${total.toFixed(2)}€`;
                } else {
                    total = diffDays * parseFloat(priceHalfDay || 0);
                    display = `${diffDays} demi-jour(s) × ${priceHalfDay}€ = ${total.toFixed(2)}€`;
                }
                
                return { days: diffDays, total, display };
            };

            const duration = calculateDuration();

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name || !priceFullDay || !priceHalfDay || !startDate || !endDate) {
                    alert('Veuillez remplir tous les champs');
                    return;
                }
                if (new Date(startDate) >= new Date(endDate)) {
                    alert('La date de fin doit être après la date de début');
                    return;
                }
                
                // Déterminer le prix à facturer
                const finalPrice = rentalType === 'fullday' ? duration.total : duration.total;
                
                onAddItem(name, finalPrice, startDate, endDate, rentalType, priceFullDay, priceHalfDay);
                setName('');
                setPriceFullDay('');
                setPriceHalfDay('');
                setStartDate('');
                setEndDate('');
                setRentalType('fullday');
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                    <div className="bg-gray-800 rounded-xl p-8 w-full max-w-lg shadow-2xl border border-gray-700 max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">Ajouter Article en Location</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">✕</button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {/* Nom de l'article */}
                            <div>
                                <label className="block text-sm font-semibold text-gray-300 mb-2">Nom de l'article *</label>
                                <input 
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    placeholder="Ex: Location Skis Rossignol"
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    required
                                />
                            </div>

                            {/* Prix Journée Complète */}
                            <div>
                                <label className="block text-sm font-semibold text-gray-300 mb-2">Prix Journée Complète (€) *</label>
                                <input 
                                    type="number"
                                    step="0.01"
                                    value={priceFullDay}
                                    onChange={(e) => setPriceFullDay(e.target.value)}
                                    placeholder="Ex: 35.00"
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    required
                                />
                            </div>

                            {/* Prix Demi-Journée */}
                            <div>
                                <label className="block text-sm font-semibold text-gray-300 mb-2">Prix Demi-Journée (€) *</label>
                                <input 
                                    type="number"
                                    step="0.01"
                                    value={priceHalfDay}
                                    onChange={(e) => setPriceHalfDay(e.target.value)}
                                    placeholder="Ex: 20.00"
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    required
                                />
                            </div>

                            {/* Dates */}
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">Date de début *</label>
                                    <input 
                                        type="date"
                                        value={startDate}
                                        onChange={(e) => setStartDate(e.target.value)}
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-green-500 focus:outline-none"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">Date de fin *</label>
                                    <input 
                                        type="date"
                                        value={endDate}
                                        onChange={(e) => setEndDate(e.target.value)}
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-green-500 focus:outline-none"
                                        required
                                    />
                                </div>
                            </div>

                            {/* Type de location */}
                            <div>
                                <label className="block text-sm font-semibold text-gray-300 mb-2">Type de location *</label>
                                <div className="flex space-x-3">
                                    <button
                                        type="button"
                                        onClick={() => setRentalType('fullday')}
                                        className={`flex-1 py-2 px-4 rounded-lg font-semibold transition ${
                                            rentalType === 'fullday'
                                                ? 'bg-green-600 text-white'
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >
                                        Journée Complète
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setRentalType('halfday')}
                                        className={`flex-1 py-2 px-4 rounded-lg font-semibold transition ${
                                            rentalType === 'halfday'
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >
                                        Demi-Journée
                                    </button>
                                </div>
                            </div>

                            {/* Calcul du total */}
                            {startDate && endDate && (
                                <div className="p-3 bg-gray-900 rounded border border-gray-700">
                                    <div className="text-sm text-gray-400 mb-2">Calcul du total :</div>
                                    <div className="text-lg font-bold text-green-400">{duration.display}</div>
                                </div>
                            )}

                            <div className="text-xs text-gray-400 bg-gray-900 p-2 rounded">
                                ℹ️ Les détails de location seront liés au client sélectionné
                            </div>

                            <div className="flex space-x-4 pt-6 border-t border-gray-700">
                                <button type="submit" className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                    Ajouter
                                </button>
                                <button type="button" onClick={onClose} className="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">
                                    Annuler
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- COMPOSANT MODALE CLIENT (SÉPARÉ) ---
        const ClientManagementModal = ({
            isOpen, 
            onClose, 
            clients, 
            onAddClient, 
            onSelectClient, 
            generateClientNumber 
        }) => {
            const [formData, setFormData] = useState({
                nom: '',
                prenom: '',
                adresse: '',
                dateNaissance: '',
                ville: ''
            });

            const handleFormChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (!formData.nom || !formData.prenom || !formData.adresse || !formData.dateNaissance || !formData.ville) {
                    alert('Veuillez remplir tous les champs');
                    return;
                }

                const newClient = {
                    id: `C${String(clients.length + 1).padStart(3, '0')}`,
                    num: generateClientNumber(),
                    nom: formData.nom,
                    prenom: formData.prenom,
                    adresse: formData.adresse,
                    dateNaissance: formData.dateNaissance,
                    ville: formData.ville,
                    loyaltyPoints: 0
                };

                onAddClient(newClient);
                setFormData({ nom: '', prenom: '', adresse: '', dateNaissance: '', ville: '' });
                alert(`Client créé avec succès ! Numéro: ${newClient.num}`);
            };

            const handleClose = () => {
                setFormData({ nom: '', prenom: '', adresse: '', dateNaissance: '', ville: '' });
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                    <div className="bg-gray-800 rounded-xl p-8 w-full max-w-2xl shadow-2xl border border-gray-700 max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">Gestion des Clients</h2>
                            <button 
                                onClick={handleClose}
                                className="text-gray-400 hover:text-white text-2xl"
                            >
                                ✕
                            </button>
                        </div>

                        {/* Onglets */}
                        <div className="flex space-x-4 mb-6 border-b border-gray-700">
                            <button className="px-4 py-2 text-green-400 border-b-2 border-green-400 font-semibold">
                                Créer Client
                            </button>
                            <button className="px-4 py-2 text-gray-400 hover:text-white">
                                Consulter
                            </button>
                        </div>

                        {/* Formulaire Création Client */}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                {/* Numéro de Client (Lecture Seule) */}
                                <div className="col-span-2">
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">
                                        Numéro de Client
                                    </label>
                                    <input 
                                        type="text"
                                        readOnly
                                        value={generateClientNumber()}
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white font-mono cursor-not-allowed opacity-75"
                                    />
                                </div>

                                {/* Prénom */}
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">
                                        Prénom *
                                    </label>
                                    <input 
                                        type="text"
                                        name="prenom"
                                        placeholder="Jean"
                                        value={formData.prenom}
                                        onChange={handleFormChange}
                                        required
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>

                                {/* Nom */}
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">
                                        Nom *
                                    </label>
                                    <input 
                                        type="text"
                                        name="nom"
                                        placeholder="Dupont"
                                        value={formData.nom}
                                        onChange={handleFormChange}
                                        required
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>

                                {/* Adresse */}
                                <div className="col-span-2">
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">
                                        Adresse *
                                    </label>
                                    <input 
                                        type="text"
                                        name="adresse"
                                        placeholder="123 Rue de la Paix"
                                        value={formData.adresse}
                                        onChange={handleFormChange}
                                        required
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>

                                {/* Date de Naissance */}
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">
                                        Date de Naissance *
                                    </label>
                                    <input 
                                        type="date"
                                        name="dateNaissance"
                                        value={formData.dateNaissance}
                                        onChange={handleFormChange}
                                        required
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>

                                {/* Ville */}
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">
                                        Ville *
                                    </label>
                                    <input 
                                        type="text"
                                        name="ville"
                                        placeholder="Chamonix"
                                        value={formData.ville}
                                        onChange={handleFormChange}
                                        required
                                        className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>
                            </div>

                            {/* Boutons */}
                            <div className="flex space-x-4 pt-6 border-t border-gray-700">
                                <button 
                                    type="submit"
                                    className="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition"
                                >
                                    Créer Client
                                </button>
                                <button 
                                    type="button"
                                    onClick={handleClose}
                                    className="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition"
                                >
                                    Annuler
                                </button>
                            </div>
                        </form>

                        {/* Liste des Clients Existants */}
                        {clients.length > 0 && (
                            <div className="mt-8 pt-8 border-t border-gray-700">
                                <h3 className="text-lg font-bold text-white mb-4">Clients Existants</h3>
                                <div className="space-y-2 max-h-64 overflow-y-auto">
                                    {clients.map((client) => (
                                        <div 
                                            key={client.id}
                                            onClick={() => {
                                                onSelectClient(client);
                                                handleClose();
                                            }}
                                            className="p-3 bg-gray-700 hover:bg-gray-600 rounded-lg cursor-pointer transition border border-gray-600"
                                        >
                                            <div className="flex justify-between items-center">
                                                <div>
                                                    <div className="font-bold text-white">{client.prenom} {client.nom}</div>
                                                    <div className="text-xs text-gray-400">{client.adresse} - {client.ville}</div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="font-mono text-green-400 font-bold">{client.num}</div>
                                                    <div className="text-xs text-gray-400">{client.loyaltyPoints} points</div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        // --- DONNÉES SIMULÉES (Adaptées Sport & Location) ---
        
        // Base de données utilisateurs
        // Liste des sociétés/entreprises clientes (clients de la plateforme)
        const MOCK_COMPANIES = [
            { 
                id: 'COMPANY001', 
                name: 'Sport Plus France',
                siret: '123 456 789 00012',
                address: '1 Avenue Principale, Paris',
                email: 'contact@sportplus.fr',
                phone: '01 23 45 67 89',
                createdDate: '2024-01-15',
                status: 'active',
                subscriptionPlan: 'premium'
            },
            { 
                id: 'COMPANY002', 
                name: 'Montagne & Loisirs',
                siret: '987 654 321 00023',
                address: '50 Rue de Genève, Annecy',
                email: 'info@montagne-loisirs.fr',
                phone: '04 50 12 34 56',
                createdDate: '2024-02-20',
                status: 'active',
                subscriptionPlan: 'standard'
            }
        ];

        // Liste des entités (sociétés/enseignes - liées à une company)
        const MOCK_ENTITIES = [
            { id: 'ENT001', name: 'Sport Plus France', siret: '123 456 789 00012', address: '1 Avenue Principale, Paris', contactEmail: 'contact@sportplus.fr', contactPhone: '01 23 45 67 89', companyId: 'COMPANY001' },
            { id: 'ENT002', name: 'Montagne & Loisirs', siret: '987 654 321 00023', address: '50 Rue de Genève, Annecy', contactEmail: 'info@montagne-loisirs.fr', contactPhone: '04 50 12 34 56', companyId: 'COMPANY002' },
        ];

        // Liste des magasins (liés à une entité)
        const MOCK_STORES = [
            { id: 'STORE001', name: 'Chamonix Centre', address: '123 Rue de la Paix, 74400 Chamonix', phone: '04 50 53 00 00', entityId: 'ENT001' },
            { id: 'STORE002', name: 'Megève Sport', address: '456 Avenue des Alpages, 74120 Megève', phone: '04 50 21 00 00', entityId: 'ENT001' },
            { id: 'STORE003', name: 'Annecy Lac', address: '789 Boulevard du Lac, 74000 Annecy', phone: '04 50 45 00 00', entityId: 'ENT002' },
        ];

        const MOCK_USERS = [
            { id: 'U001', username: 'admin1', password: 'admin123', fullName: 'Administrateur Principal', role: 'admin', email: 'admin@caisse2.fr', storeId: 'STORE001', entityId: 'ENT001', companyId: 'COMPANY001' },
            { id: 'U002', username: 'admin2', password: 'admin123', fullName: 'Administrateur Secondaire', role: 'admin', email: 'admin2@caisse2.fr', storeId: 'STORE002', entityId: 'ENT001', companyId: 'COMPANY001' },
            { id: 'U003', username: 'vendeur', password: 'vendeur123', fullName: 'Jean Vendeur', role: 'employee', email: 'vendeur@caisse2.fr', storeId: 'STORE001', entityId: 'ENT001', companyId: 'COMPANY001' },
            { id: 'U004', username: 'superadmin', password: 'superadmin123', fullName: 'Super Administrateur', role: 'superadmin', email: 'superadmin@caisse2.fr', storeId: null, entityId: null, companyId: null },
        ];

        // Système de permissions par défaut
        const DEFAULT_PERMISSIONS = {
            superadmin: {
                backoffice: { view: true, edit: true },
                suppliers: { view: true, edit: true },
                articles: { view: true, edit: true },
                stock: { view: true, edit: true },
                finances: { view: true, edit: true },
                clients: { view: true, edit: true },
                reports: { view: true, edit: true },
                users: { view: true, edit: true },
                companies: { view: true, edit: true },
                entities: { view: true, edit: true },
                stores: { view: true, edit: true },
            },
            admin: {
                backoffice: { view: true, edit: true },
                suppliers: { view: true, edit: true },
                articles: { view: true, edit: true },
                stock: { view: true, edit: true },
                finances: { view: true, edit: true },
                clients: { view: true, edit: true },
                reports: { view: true, edit: true },
                users: { view: true, edit: true },
            },
            employee: {
                backoffice: { view: true, edit: false },
                suppliers: { view: true, edit: false },
                articles: { view: true, edit: false },
                stock: { view: true, edit: false },
                finances: { view: false, edit: false },
                clients: { view: true, edit: true },
                reports: { view: true, edit: false },
                users: { view: false, edit: false },
            },
        };

        const MOCK_CLIENTS = [
            { id: 'C001', num: 'CLI-001', nom: 'Dupont', prenom: 'Jean', adresse: '123 Rue de la Paix', dateNaissance: '1990-05-15', ville: 'Chamonix', loyaltyPoints: 450 },
            { id: 'C002', num: 'CLI-002', nom: 'Martin', prenom: 'Sophie', adresse: '456 Avenue des Pistes', dateNaissance: '1985-08-20', ville: 'Annecy', loyaltyPoints: 120 },
        ];

        const MOCK_PRODUCTS = [
            { id: 101, name: 'Pack Ski Alpin - Expert', price: 35.00, isRentable: true, category: 'Location', color: 'bg-green-600/30', text: 'text-green-300', barcode: '3701234567891' },
            { id: 102, name: 'Location VTT Adulte (Jour)', price: 25.00, isRentable: true, category: 'Location', color: 'bg-green-600/30', text: 'text-green-300', barcode: '3701234567892' },
            { id: 201, name: 'Gants de Ski Imperméables', price: 49.99, isRentable: false, category: 'Vente', color: 'bg-indigo-600/30', text: 'text-indigo-300', barcode: '3701234567893' },
            { id: 202, name: 'Casquette Technique', price: 19.99, isRentable: false, category: 'Vente', color: 'bg-indigo-600/30', text: 'text-indigo-300', barcode: '3701234567894' },
            { id: 301, name: 'Forfait Saison VTT', price: 299.00, isRentable: false, category: 'Services', color: 'bg-yellow-600/30', text: 'text-yellow-300', barcode: '3701234567895' },
            { id: 302, name: 'Réparation Ski (Atelier)', price: 45.00, isRentable: false, category: 'Services', color: 'bg-yellow-600/30', text: 'text-yellow-300', barcode: '3701234567896' },
        ];

        // Structure d'un article dans le panier (avec détails de location)
        const initialRentalItem = { 
            id: 900, 
            name: 'Location Ski Alpin Elite - 3 Jours', 
            price: 90.00, 
            qty: 1, 
            isRentable: true,
            details: {
                startDate: '2025-08-16',
                endDate: '2025-08-18',
                caution: 250.00,
                client: 'Jean Dupont (ID: C097)'
            } 
        };

        const POS = () => {
            // --- AUTHENTIFICATION ---
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [selectedCompanyId, setSelectedCompanyId] = useState(null); // Pour les super-admins
            const [loginUsername, setLoginUsername] = useState('');
            const [loginPassword, setLoginPassword] = useState('');
            const [loginError, setLoginError] = useState('');

            // Sociétés (companies) - données multi-tenant
            const [companies, setCompanies] = useState(() => {
                const saved = localStorage.getItem('posCompanies');
                return saved ? JSON.parse(saved) : MOCK_COMPANIES;
            });

            // Permissions modifiables (localStorage + Firebase)
            const [permissions, setPermissions] = useState(() => {
                const saved = localStorage.getItem('posPermissions');
                return saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULT_PERMISSIONS));
            });

            // Utilisateurs modifiables (localStorage + Firebase)
            const [users, setUsers] = useState(() => {
                const saved = localStorage.getItem('posUsers');
                const loadedUsers = saved ? JSON.parse(saved) : MOCK_USERS;
                
                // Assurer que le superadmin existe toujours
                const hasSuperAdmin = loadedUsers.some(u => u.username === 'superadmin');
                if (!hasSuperAdmin) {
                    const superAdminUser = { id: 'U004', username: 'superadmin', password: 'superadmin123', fullName: 'Super Administrateur', role: 'superadmin', email: 'superadmin@caisse2.fr', storeId: null, entityId: null, companyId: null };
                    loadedUsers.push(superAdminUser);
                }
                
                return loadedUsers;
            });

            // Sauvegarder automatiquement permissions (localStorage + Firebase)
            useEffect(() => {
                localStorage.setItem('posPermissions', JSON.stringify(permissions));
                savePermissionsToFirebase(permissions);
            }, [permissions]);

            // Sauvegarder automatiquement utilisateurs (localStorage + Firebase)
            useEffect(() => {
                localStorage.setItem('posUsers', JSON.stringify(users));
                saveUsersToFirebase(users);
            }, [users]);

            // Sauvegarder automatiquement sociétés (localStorage + Firebase)
            useEffect(() => {
                localStorage.setItem('posCompanies', JSON.stringify(companies));
                saveToFirestore('companies', companies);
            }, [companies]);

            // Charger données depuis Firebase au démarrage
            useEffect(() => {
                const initializeData = async () => {
                    const fbPermissions = await loadPermissionsFromFirebase();
                    const fbUsers = await loadUsersFromFirebase();
                    
                    if (fbPermissions) {
                        setPermissions(fbPermissions);
                    }
                    if (fbUsers) {
                        setUsers(fbUsers);
                    }
                };
                initializeData();
            }, []);

            // Vérifier session au chargement
            useEffect(() => {
                const savedUser = localStorage.getItem('posCurrentUser');
                if (savedUser) {
                    const user = JSON.parse(savedUser);
                    setCurrentUser(user);
                    setIsLoggedIn(true);
                }
            }, []);

            // Sauvegarder automatiquement l'historique d'étiquettes
            useEffect(() => {
                localStorage.setItem('posLabelHistory', JSON.stringify(labelHistory));
            }, [labelHistory]);

            // Fonctions d'authentification
            const handleLogin = (e) => {
                e.preventDefault();
                const user = users.find(u => u.username === loginUsername && u.password === loginPassword);
                if (user) {
                    setCurrentUser(user);
                    setIsLoggedIn(true);
                    setLoginError('');
                    localStorage.setItem('posCurrentUser', JSON.stringify(user));
                } else {
                    setLoginError('Identifiants incorrects');
                }
            };

            const handleLogout = () => {
                setIsLoggedIn(false);
                setCurrentUser(null);
                setSelectedCompanyId(null);
                setLoginUsername('');
                setLoginPassword('');
                localStorage.removeItem('posCurrentUser');
            };

            // Fonctions de vérification des permissions
            const canAccess = (section) => {
                if (!currentUser) return false;
                return permissions[currentUser.role]?.[section]?.view ?? false;
            };

            const canEdit = (section) => {
                if (!currentUser) return false;
                return permissions[currentUser.role]?.[section]?.edit ?? false;
            };

            const isAdmin = () => currentUser?.role === 'admin';

            // Entités (sociétés/enseignes)
            const [entities, setEntities] = useState(() => {
                const saved = localStorage.getItem('posEntities');
                return saved ? JSON.parse(saved) : MOCK_ENTITIES;
            });

            // Magasins
            const [stores, setStores] = useState(() => {
                const saved = localStorage.getItem('posStores');
                return saved ? JSON.parse(saved) : MOCK_STORES;
            });

            // État pour sélectionner le magasin actif
            const [selectedStoreId, setSelectedStoreId] = useState(null);
            
            // État pour afficher/masquer la gestion des utilisateurs d'une société
            const [expandedCompanyId, setExpandedCompanyId] = useState(null);
            const [companyManagementTab, setCompanyManagementTab] = useState('users');
            
            // États pour l'impression d'étiquettes
            const [selectedProductsForLabels, setSelectedProductsForLabels] = useState([]);
            const [labelQuantities, setLabelQuantities] = useState({}); // Quantités par produit {productId: number}
            const [labelFormat, setLabelFormat] = useState('100x150'); // Format d'étiquette
            const [customLabelWidth, setCustomLabelWidth] = useState(100);
            const [customLabelHeight, setCustomLabelHeight] = useState(150);
            const [showCustomFormat, setShowCustomFormat] = useState(false);
            const [labelShowPrice, setLabelShowPrice] = useState(true);
            const [labelShowBarcode, setLabelShowBarcode] = useState(true);
            const [labelShowProductId, setLabelShowProductId] = useState(true);
            const [labelShowCategory, setLabelShowCategory] = useState(false);
            const [labelHistory, setLabelHistory] = useState(() => {
                const saved = localStorage.getItem('posLabelHistory');
                return saved ? JSON.parse(saved) : [];
            });

            // Obtenir l'entité et le magasin actuel
            // D'abord, utiliser le magasin sélectionné, sinon le magasin de l'utilisateur
            const currentStore = currentUser ? stores.find(s => s.id === (selectedStoreId || currentUser.storeId)) : null;
            const currentEntity = currentUser ? entities.find(e => e.id === currentUser.entityId) : null;
            
            // Les magasins accessibles : tous les magasins de l'utilisateur (ou tous si admin)
            const accessibleStores = currentUser ? 
                (currentUser.role === 'admin' ? stores : stores.filter(s => s.entityId === currentUser.entityId)) : [];

            // Sauvegarder les entités dans localStorage
            useEffect(() => {
                localStorage.setItem('posEntities', JSON.stringify(entities));
            }, [entities]);

            // Sauvegarder les magasins dans localStorage
            useEffect(() => {
                localStorage.setItem('posStores', JSON.stringify(stores));
            }, [stores]);

            // Initialiser le magasin sélectionné au premier accès
            useEffect(() => {
                if (currentUser && !selectedStoreId) {
                    setSelectedStoreId(currentUser.storeId);
                }
            }, [currentUser, selectedStoreId]);

            const [cart, setCart] = useState([initialRentalItem]); // Panier pré-rempli pour la démo
            const [searchQuery, setSearchQuery] = useState('');
            const [serviceTab, setServiceTab] = useState('Vente'); // 'Vente', 'Location', 'Atelier'
            const [clients, setClients] = useState(MOCK_CLIENTS);
            const [selectedClient, setSelectedClient] = useState(null);
            const [isClientModalOpen, setIsClientModalOpen] = useState(false);
            const [selectedPaymentMethod, setSelectedPaymentMethod] = useState(null);
            const [barcodeInput, setBarcodeInput] = useState('');
            const [scanMessage, setScanMessage] = useState('');
            const [scanMessageType, setScanMessageType] = useState(''); // 'success', 'error', 'info'
            const [isAddSaleModalOpen, setIsAddSaleModalOpen] = useState(false);
            const [isAddRentalModalOpen, setIsAddRentalModalOpen] = useState(false);
            const [transactions, setTransactions] = useState(() => {
                // Charger les transactions depuis localStorage
                const saved = localStorage.getItem('posTransactions');
                return saved ? JSON.parse(saved) : [];
            });
            const [isHistoryOpen, setIsHistoryOpen] = useState(false);
            const [historyFilter, setHistoryFilter] = useState('jour'); // 'jour', 'mois', 'annee'
            const [isBackOfficeOpen, setIsBackOfficeOpen] = useState(false);
            const [backOfficeTab, setBackOfficeTab] = useState('dashboard'); // 'dashboard', 'suppliers', 'articles', 'stock', 'finances', 'clients', 'reports'
            const [suppliers, setSuppliers] = useState(() => {
                const saved = localStorage.getItem('posSuppliers');
                return saved ? JSON.parse(saved) : [
                    { id: 'SUP001', name: 'Rossignol Ski', email: 'contact@rossignol.com', phone: '04 50 00 00 00', country: 'France' },
                    { id: 'SUP002', name: 'Salomon Sports', email: 'info@salomon.com', phone: '04 50 11 11 11', country: 'France' },
                ];
            });
            const paymentMethods = [
                { id: 'especes', label: 'Espèces', icon: '💵', color: 'bg-green-600' },
                { id: 'carte', label: 'Carte Bancaire', icon: '💳', color: 'bg-blue-600' },
                { id: 'cleu', label: 'Clé-U', icon: '🔑', color: 'bg-purple-600' },
                { id: 'cheque', label: 'Chèque Cadeau', icon: '🎁', color: 'bg-pink-600' },
                { id: 'globalpos', label: 'GlobalPos', icon: '📱', color: 'bg-indigo-600' },
            ];

            // États pour la gestion avancée
            const [productSuppliers, setProductSuppliers] = useState(() => {
                const saved = localStorage.getItem('posProductSuppliers');
                return saved ? JSON.parse(saved) : {};
            });
            const [productStock, setProductStock] = useState(() => {
                const saved = localStorage.getItem('posProductStock');
                return saved ? JSON.parse(saved) : {};
            });
            const [productCosts, setProductCosts] = useState(() => {
                const saved = localStorage.getItem('posProductCosts');
                return saved ? JSON.parse(saved) : {};
            });
            const [expenses, setExpenses] = useState(() => {
                const saved = localStorage.getItem('posExpenses');
                return saved ? JSON.parse(saved) : [];
            });
            const [stockMovements, setStockMovements] = useState(() => {
                const saved = localStorage.getItem('posStockMovements');
                return saved ? JSON.parse(saved) : [];
            });
            const [stockAlerts, setStockAlerts] = useState(() => {
                const saved = localStorage.getItem('posStockAlerts');
                return saved ? JSON.parse(saved) : {};
            });

            // Produits dynamiques (peuvent être importés depuis Excel)
            const [products, setProducts] = useState(() => {
                const saved = localStorage.getItem('posProducts');
                return saved ? JSON.parse(saved) : MOCK_PRODUCTS;
            });

            // Sauvegarder les produits dans localStorage
            useEffect(() => {
                localStorage.setItem('posProducts', JSON.stringify(products));
            }, [products]);

            // Fonction pour importer des articles depuis Excel
            const handleExcelImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        // Convertir les données Excel en format produit
                        const newProducts = jsonData.map((row, index) => {
                            const id = row.id || row.ID || (Math.max(...products.map(p => p.id), 0) + index + 1);
                            const name = row.nom || row.name || row.Nom || row.Name || 'Produit sans nom';
                            const price = parseFloat(row.prix || row.price || row.Prix || row.Price || 0);
                            const category = row.categorie || row.category || row.Catégorie || row.Category || 'Vente';
                            const barcode = row.barcode || row.code || row.Barcode || row.Code || `370${Date.now()}${index}`;
                            const isRentable = (row.location || row.rentable || row.Location || row.Rentable || '').toString().toLowerCase() === 'oui' || 
                                               (row.location || row.rentable || row.Location || row.Rentable || '').toString().toLowerCase() === 'true';

                            return {
                                id,
                                name,
                                price,
                                isRentable,
                                category,
                                color: category === 'Location' ? 'bg-green-600/30' : category === 'Services' ? 'bg-yellow-600/30' : 'bg-indigo-600/30',
                                text: category === 'Location' ? 'text-green-300' : category === 'Services' ? 'text-yellow-300' : 'text-indigo-300',
                                barcode
                            };
                        });

                        // Fusionner avec les produits existants (éviter les doublons par ID)
                        const existingIds = new Set(products.map(p => p.id));
                        const uniqueNewProducts = newProducts.filter(p => !existingIds.has(p.id));
                        
                        setProducts([...products, ...uniqueNewProducts]);
                        
                        // Sauvegarder chaque nouveau produit dans Firebase
                        uniqueNewProducts.forEach(product => {
                            saveToFirestore('products', product);
                        });
                        
                        alert(`✅ ${uniqueNewProducts.length} article(s) importé(s) avec succès et sauvegardés dans Firebase !`);
                    } catch (error) {
                        console.error('Erreur import Excel:', error);
                        alert('❌ Erreur lors de l\'import du fichier Excel');
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            // Fonction pour importer des fournisseurs depuis Excel
            const handleSuppliersImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        // Convertir les données Excel en format fournisseur
                        const newSuppliers = jsonData.map((row, index) => {
                            const id = row.id || row.ID || `SUP${String(suppliers.length + index + 1).padStart(3, '0')}`;
                            const name = row.nom || row.name || row.Nom || row.Name || 'Fournisseur sans nom';
                            const email = row.email || row.Email || '';
                            const phone = row.telephone || row.phone || row.Téléphone || row.Phone || '';
                            const country = row.pays || row.country || row.Pays || row.Country || 'France';

                            return { id, name, email, phone, country };
                        });

                        // Éviter les doublons par ID
                        const existingIds = new Set(suppliers.map(s => s.id));
                        const uniqueNewSuppliers = newSuppliers.filter(s => !existingIds.has(s.id));
                        
                        setSuppliers([...suppliers, ...uniqueNewSuppliers]);
                        
                        // Sauvegarder chaque nouveau fournisseur dans Firebase
                        uniqueNewSuppliers.forEach(supplier => {
                            saveToFirestore('suppliers', supplier);
                        });
                        
                        alert(`✅ ${uniqueNewSuppliers.length} fournisseur(s) importé(s) avec succès et sauvegardé(s) dans Firebase !`);
                    } catch (error) {
                        console.error('Erreur import fournisseurs:', error);
                        alert('❌ Erreur lors de l\'import du fichier Excel');
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            // Fonction pour importer des clients depuis Excel
            const handleClientsImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        // Convertir les données Excel en format client
                        const newClients = jsonData.map((row, index) => {
                            const id = row.id || row.ID || `C${String(clients.length + index + 1).padStart(3, '0')}`;
                            const num = row.num || row.Num || `CLI-${String(clients.length + index + 1).padStart(3, '0')}`;
                            const nom = row.nom || row.name || row.Nom || row.Name || 'Client';
                            const prenom = row.prenom || row.firstname || row.Prénom || row.FirstName || '';
                            const adresse = row.adresse || row.address || row.Adresse || row.Address || '';
                            const dateNaissance = row.dateNaissance || row.birthDate || row.Date || '';
                            const ville = row.ville || row.city || row.Ville || row.City || '';
                            const loyaltyPoints = parseInt(row.loyaltyPoints || row.points || row.Points || 0);

                            return { id, num, nom, prenom, adresse, dateNaissance, ville, loyaltyPoints };
                        });

                        // Éviter les doublons par ID
                        const existingIds = new Set(clients.map(c => c.id));
                        const uniqueNewClients = newClients.filter(c => !existingIds.has(c.id));
                        
                        setClients([...clients, ...uniqueNewClients]);
                        
                        // Sauvegarder chaque nouveau client dans Firebase
                        uniqueNewClients.forEach(client => {
                            saveToFirestore('clients', client);
                        });
                        
                        alert(`✅ ${uniqueNewClients.length} client(s) importé(s) avec succès et sauvegardé(s) dans Firebase !`);
                    } catch (error) {
                        console.error('Erreur import clients:', error);
                        alert('❌ Erreur lors de l\'import du fichier Excel');
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            // Fonction pour enregistrer un mouvement de stock
            const recordStockMovement = (productId, quantity, type, reason = '') => {
                const movement = {
                    id: `MOV${Date.now()}`,
                    productId,
                    productName: products.find(p => p.id === productId)?.name || 'Unknown',
                    quantity,
                    type, // 'entrée' ou 'sortie'
                    reason,
                    date: new Date().toISOString(),
                    timestamp: Date.now()
                };
                
                const updated = [...stockMovements, movement];
                setStockMovements(updated);
                localStorage.setItem('posStockMovements', JSON.stringify(updated));
                return movement;
            };

            // Fonction pour ajouter une dépense
            const addExpense = (category, amount, description = '') => {
                const expense = {
                    id: `EXP${Date.now()}`,
                    category,
                    amount,
                    description,
                    date: new Date().toISOString(),
                    timestamp: Date.now()
                };
                const updated = [...expenses, expense];
                setExpenses(updated);
                localStorage.setItem('posExpenses', JSON.stringify(updated));
                saveToFirestore('expenses', expense);
                return expense;
            };

            // Fonction pour calculer les statistiques financières
            const getFinancialStats = (startDate, endDate) => {
                const filteredTransactions = transactions.filter(t => {
                    if (!t.date) return false;
                    // Filtrer par magasin sélectionné
                    if (t.storeId !== currentStore?.id) return false;
                    
                    const tDate = new Date(t.date);
                    return tDate >= startDate && tDate <= endDate;
                });

                const totalRevenue = filteredTransactions.reduce((sum, t) => sum + (t.total || 0), 0);
                const totalTransactions = filteredTransactions.length;
                
                // Calcul du coût total (basé sur les coûts d'achat des produits)
                const totalCost = filteredTransactions.reduce((sum, t) => {
                    if (t.items && Array.isArray(t.items)) {
                        return sum + t.items.reduce((itemSum, item) => {
                            const cost = productCosts[item.id] || 0;
                            return itemSum + (cost * (item.qty || item.quantity || 1));
                        }, 0);
                    }
                    return sum;
                }, 0);

                // Dépenses dans la période
                const periodExpenses = expenses.filter(e => {
                    const eDate = new Date(e.date);
                    return eDate >= startDate && eDate <= endDate;
                });
                const totalExpenses = periodExpenses.reduce((sum, e) => sum + e.amount, 0);

                const grossProfit = totalRevenue - totalCost;
                const netProfit = grossProfit - totalExpenses;
                const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100).toFixed(2) : 0;

                return {
                    totalRevenue,
                    totalCost,
                    totalExpenses,
                    grossProfit,
                    netProfit,
                    profitMargin,
                    totalTransactions,
                    periodExpenses
                };
            };

            // Fonction pour dupliquer les produits selon les quantités d'étiquettes
            const expandProductsByQuantity = (products, quantities) => {
                return products.flatMap(product => {
                    const qty = quantities[product.id] || 1;
                    return Array.from({ length: qty }, () => product);
                });
            };

            // Fonction pour générer l'HTML d'une étiquette
            const generateLabelHTML = (product, format, options = {}) => {
                const dimensions = {
                    '50x25': { width: '50mm', height: '25mm', fontSize: '8px' },
                    '100x150': { width: '100mm', height: '150mm', fontSize: '14px' },
                    '4x6': { width: '101.6mm', height: '152.4mm', fontSize: '16px' },
                    'custom': { width: `${customLabelWidth}mm`, height: `${customLabelHeight}mm`, fontSize: '12px' }
                };
                
                const dim = dimensions[format] || dimensions['100x150'];
                const fontSize = format === 'custom' ? '12px' : dim.fontSize;
                
                // Récupérer les options d'affichage
                const showPrice = options.showPrice !== undefined ? options.showPrice : labelShowPrice;
                const showBarcode = options.showBarcode !== undefined ? options.showBarcode : labelShowBarcode;
                const showProductId = options.showProductId !== undefined ? options.showProductId : labelShowProductId;
                const showCategory = options.showCategory !== undefined ? options.showCategory : labelShowCategory;
                
                return `
                    <div style="
                        width: ${dim.width}; 
                        height: ${dim.height}; 
                        padding: 6px; 
                        border: 1px solid #ccc;
                        margin: 5px;
                        display: inline-block;
                        background: white;
                        color: black;
                        font-family: Arial, sans-serif;
                        page-break-inside: avoid;
                        font-size: ${fontSize};
                    ">
                        <div style="font-weight: bold; font-size: 13px; margin-bottom: 3px; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${product.name.substring(0, 20)}
                        </div>
                        ${showCategory ? `<div style="font-size: 9px; text-align: center; color: #666; margin-bottom: 2px;">
                            ${product.categorie || product.category || 'N/A'}
                        </div>` : ''}
                        ${showBarcode ? `<div style="text-align: center; margin-bottom: 4px;">
                            <svg id="barcode-${product.id}" style="max-width: 95%; max-height: 35px;"></svg>
                        </div>` : ''}
                        ${showPrice ? `<div style="text-align: center; font-weight: bold; font-size: 15px; margin-bottom: 2px;">
                            ${product.price}€
                        </div>` : ''}
                        ${showProductId ? `<div style="font-size: 9px; text-align: center; color: #666;">
                            ${product.barcode || product.id}
                        </div>` : ''}
                    </div>
                `;
            };

            // Fonction pour imprimer les étiquettes en PDF
            const printLabelsAsPDF = (productsToprint, format, options = {}) => {
                if (productsToprint.length === 0) {
                    alert('❌ Veuillez sélectionner des produits');
                    return;
                }

                const element = document.createElement('div');
                element.style.padding = '10mm';
                element.innerHTML = productsToprint.map(p => generateLabelHTML(p, format, options)).join('');
                
                // Générer les codes-barres
                productsToprint.forEach(product => {
                    setTimeout(() => {
                        try {
                            if (window.JsBarcode && options.showBarcode !== false) {
                                window.JsBarcode(`#barcode-${product.id}`, product.barcode || product.id, {
                                    format: 'CODE128',
                                    width: 2,
                                    height: 40,
                                    displayValue: false
                                });
                            }
                        } catch (e) {
                            console.log('Code-barre non généré');
                        }
                    }, 100);
                });

                // Créer le PDF
                setTimeout(() => {
                    const opt = {
                        margin: 5,
                        filename: `etiquettes_${new Date().toISOString().split('T')[0]}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };
                    
                    if (window.html2pdf) {
                        window.html2pdf().set(opt).from(element).save();
                    } else {
                        const printWindow = window.open('', '', 'height=600,width=800');
                        printWindow.document.write(element.innerHTML);
                        printWindow.print();
                    }
                }, 500);
            };

            // Fonction pour imprimer directement
            const printLabelsDirectly = (productsToprint, format, options = {}) => {
                if (productsToprint.length === 0) {
                    alert('❌ Veuillez sélectionner des produits');
                    return;
                }

                const printWindow = window.open('', '', 'height=600,width=800');
                const html = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            body { margin: 0; padding: 10mm; font-family: Arial, sans-serif; }
                            @media print { .label { page-break-inside: avoid; } }
                        </style>
                    </head>
                    <body>
                        ${productsToprint.map(p => generateLabelHTML(p, format, options)).join('')}
                    </body>
                    </html>
                `;
                
                printWindow.document.write(html);
                printWindow.document.close();
                
                // Générer les codes-barres avant impression
                setTimeout(() => {
                    productsToprint.forEach(product => {
                        try {
                            if (printWindow.JsBarcode && options.showBarcode !== false) {
                                printWindow.JsBarcode(`#barcode-${product.id}`, product.barcode || product.id, {
                                    format: 'CODE128',
                                    width: 2,
                                    height: 40,
                                    displayValue: false
                                });
                            }
                        } catch (e) {
                            console.log('Code-barre non généré');
                        }
                    });
                    
                    // Ajouter à l'historique
                    const printRecord = {
                        id: Date.now(),
                        date: new Date().toISOString(),
                        productCount: productsToprint.length,
                        format: format,
                        user: currentUser?.fullName || 'Inconnu',
                        store: currentStore?.name || 'Tous'
                    };
                    setLabelHistory([...labelHistory, printRecord]);
                    
                    printWindow.print();
                }, 300);
            };

            // Fonction pour calculer les points de fidélité
            const calculateLoyaltyPoints = (clientId) => {
                const clientTransactions = transactions.filter(t => t.client === clientId);
                const totalSpent = clientTransactions.reduce((sum, t) => sum + (t.total || 0), 0);
                // 1 point pour 1€ dépensé
                return Math.floor(totalSpent);
            };

            // Fonction pour obtenir le segment client
            const getClientSegment = (clientId) => {
                const clientTransactions = transactions.filter(t => t.client === clientId);
                const totalSpent = clientTransactions.reduce((sum, t) => sum + (t.total || 0), 0);
                const transactionCount = clientTransactions.length;

                if (totalSpent >= 5000 || transactionCount >= 50) {
                    return { name: 'VIP', color: 'gold', icon: '👑' };
                } else if (totalSpent >= 2000 || transactionCount >= 20) {
                    return { name: 'Premium', color: 'purple', icon: '💎' };
                } else if (totalSpent >= 500 || transactionCount >= 5) {
                    return { name: 'Fidèle', color: 'blue', icon: '⭐' };
                } else if (totalSpent > 0 || transactionCount > 0) {
                    return { name: 'Régulier', color: 'green', icon: '✓' };
                } else {
                    return { name: 'Nouveau', color: 'gray', icon: '🆕' };
                }
            };

            // Fonction pour obtenir l'historique d'achats d'un client
            const getClientPurchaseHistory = (clientId) => {
                return transactions.filter(t => t.client === clientId).sort((a, b) => {
                    const dateA = new Date(a.date || 0).getTime();
                    const dateB = new Date(b.date || 0).getTime();
                    return dateB - dateA;
                });
            };

            // Fonction pour ajouter des points de fidélité
            const addLoyaltyPoints = (clientId, points) => {
                setClients(prev => prev.map(c => 
                    c.num === clientId 
                        ? { ...c, loyaltyPoints: (c.loyaltyPoints || 0) + points }
                        : c
                ));
            };

            const generateClientNumber = () => {
                const maxNum = clients.length > 0 
                    ? Math.max(...clients.map(c => parseInt(c.num.split('-')[1])))
                    : 0;
                return `CLI-${String(maxNum + 1).padStart(3, '0')}`;
            };

            const handleAddClient = (newClient) => {
                setClients(prev => [...prev, newClient]);
                setSelectedClient(newClient);
                // 🔥 Sauvegarder dans Firebase
                saveToFirestore('clients', newClient);
            };

            const handleSelectClient = (client) => {
                setSelectedClient(client);
            };

            const addToCart = (product) => {
                setCart((prevCart) => {
                    // Si c'est un produit de vente, on incrémente la quantité
                    if (!product.isRentable) {
                        const existingItem = prevCart.find((item) => item.id === product.id && !item.isRentable);
                        if (existingItem) {
                            return prevCart.map((item) =>
                                item.id === product.id ? { ...item, qty: item.qty + 1 } : item
                            );
                        }
                    }
                    
                    // Pour les locations, on ajoute une nouvelle ligne (chaque location est unique)
                    return [...prevCart, { ...product, qty: 1 }];
                });
            };

            const updateQty = (id, delta) => {
                setCart((prevCart) => {
                    return prevCart.map((item) => {
                        if (item.id === id) return { ...item, qty: Math.max(0, item.qty + delta) };
                        return item;
                    }).filter(item => item.qty > 0);
                });
            };

            const clearCart = () => {
                if(window.confirm('Voulez-vous annuler ce ticket ?')) {
                    setCart([]);
                }
            };

            const handlePay = () => {
                saveTransaction();
                handlePrintTicket();
            };

            const handleBarcodeScan = (e) => {
                e.preventDefault();
                
                if (!barcodeInput.trim()) {
                    setScanMessage('Veuillez scanner un code-barre');
                    setScanMessageType('info');
                    return;
                }

                // Rechercher le produit par code-barre
                const scannedProduct = products.find(p => p.barcode === barcodeInput);
                
                if (scannedProduct) {
                    // Ajouter le produit au panier
                    addToCart(scannedProduct);
                    setScanMessage(`✓ ${scannedProduct.name} ajouté au panier`);
                    setScanMessageType('success');
                } else {
                    setScanMessage(`✗ Article non trouvé (Code: ${barcodeInput})`);
                    setScanMessageType('error');
                }

                // Réinitialiser le champ et afficher le message pendant 2 secondes
                setBarcodeInput('');
                setTimeout(() => setScanMessage(''), 2000);
            };

            // Handlers pour l'ajout d'articles en vente et location
            const handleAddSaleItem = (name, price) => {
                // Générer un code-barre unique
                const newBarcode = '37' + Math.random().toString().slice(2, 13);
                
                // Créer le nouveau produit
                const newProduct = {
                    id: Math.max(...MOCK_PRODUCTS.map(p => p.id), 0) + 1,
                    name: name,
                    price: parseFloat(price),
                    isRentable: false,
                    category: 'Vente',
                    color: 'bg-indigo-600/30',
                    text: 'text-indigo-300',
                    barcode: newBarcode
                };
                
                // Ajouter au catalogue
                setProducts([...products, newProduct]);
                // 🔥 Sauvegarder dans Firebase
                saveToFirestore('products', newProduct);
                
                // Créer l'article pour le panier
                const newItem = {
                    id: Math.random(),
                    name: name,
                    price: parseFloat(price),
                    qty: 1,
                    isRentable: false,
                    category: 'Vente',
                    details: { variant: 'Custom' }
                };
                
                // Ajouter au panier
                addToCart(newItem);
                setIsAddSaleModalOpen(false);
            };
            
            const handleAddRentalItem = (name, price, startDate, endDate, rentalType, priceFullDay, priceHalfDay) => {
                // Générer un code-barre unique
                const newBarcode = '37' + Math.random().toString().slice(2, 13);
                
                // Créer le nouveau produit
                const newProduct = {
                    id: Math.max(...MOCK_PRODUCTS.map(p => p.id), 0) + 1,
                    name: name,
                    price: parseFloat(price),
                    isRentable: true,
                    category: 'Location',
                    color: 'bg-green-600/30',
                    text: 'text-green-300',
                    barcode: newBarcode
                };
                
                // Ajouter au catalogue
                setProducts([...products, newProduct]);
                // 🔥 Sauvegarder dans Firebase
                saveToFirestore('products', newProduct);
                
                // Créer l'article pour le panier
                const newItem = {
                    id: Math.random(),
                    name: name,
                    price: parseFloat(price),
                    qty: 1,
                    isRentable: true,
                    category: 'Location',
                    details: {
                        startDate: startDate,
                        endDate: endDate,
                        rentalType: rentalType,
                        priceFullDay: parseFloat(priceFullDay),
                        priceHalfDay: parseFloat(priceHalfDay),
                        caution: 0,
                        client: selectedClient ? `${selectedClient.prenom} ${selectedClient.nom}` : 'Client non sélectionné'
                    }
                };
                
                // Ajouter au panier
                addToCart(newItem);
                setIsAddRentalModalOpen(false);
            };

            // Fonction pour enregistrer une transaction
            const saveTransaction = () => {
                if (cart.length === 0) {
                    alert('Panier vide! Ajoutez des articles avant de valider.');
                    return;
                }

                if (!selectedPaymentMethod) {
                    alert('Veuillez sélectionner un mode de paiement!');
                    return;
                }

                const total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
                const paymentLabel = paymentMethods.find(m => m.id === selectedPaymentMethod)?.label || 'Non spécifié';
                
                const newTransaction = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    client: selectedClient ? `${selectedClient.prenom} ${selectedClient.nom}` : 'Client non sélectionné',
                    clientNum: selectedClient?.num || 'N/A',
                    items: cart.map(item => ({
                        name: item.name,
                        qty: item.qty,
                        price: item.price,
                        originalPrice: item.originalPrice,
                        subtotal: item.price * item.qty
                    })),
                    total: total,
                    paymentMethod: paymentLabel,
                    notes: '',
                    // Informations entité, magasin et utilisateur
                    entityId: currentUser?.entityId || 'UNKNOWN',
                    entityName: currentEntity?.name || 'Entité inconnue',
                    storeId: currentUser?.storeId || 'UNKNOWN',
                    storeName: currentStore?.name || 'Magasin inconnu',
                    userId: currentUser?.id || 'UNKNOWN',
                    userName: currentUser?.fullName || 'Utilisateur inconnu'
                };

                // Ajouter à l'état et sauvegarder dans localStorage
                const updatedTransactions = [...transactions, newTransaction];
                setTransactions(updatedTransactions);
                localStorage.setItem('posTransactions', JSON.stringify(updatedTransactions));

                // 🔥 Sauvegarder dans Firebase
                saveToFirestore('transactions', newTransaction);

                // Vider le panier et réinitialiser
                setCart([]);
                setSelectedPaymentMethod(null);
                setSelectedClient(null);

                alert('✅ Transaction enregistrée avec succès! (Sauvegardée localement + Cloud)');
            };

            // Filtrer les transactions par date
            const getFilteredTransactions = () => {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const yearStart = new Date(now.getFullYear(), 0, 1);

                return transactions.filter(tx => {
                    // Filtrer par magasin sélectionné
                    if (tx.storeId !== currentStore?.id) {
                        return false;
                    }

                    const txDate = new Date(tx.date);
                    const txDateOnly = new Date(txDate.getFullYear(), txDate.getMonth(), txDate.getDate());

                    if (historyFilter === 'jour') {
                        return txDateOnly.getTime() === today.getTime();
                    } else if (historyFilter === 'mois') {
                        return txDate.getFullYear() === now.getFullYear() && txDate.getMonth() === now.getMonth();
                    } else if (historyFilter === 'annee') {
                        return txDate.getFullYear() === now.getFullYear();
                    }
                    return true;
                });
            };

            // Calcul des statistiques
            const getStats = () => {
                const filtered = getFilteredTransactions();
                const totalRevenue = filtered.reduce((acc, tx) => acc + tx.total, 0);
                const totalTransactions = filtered.length;
                const totalItems = filtered.reduce((acc, tx) => acc + tx.items.reduce((sum, item) => sum + item.qty, 0), 0);

                return { totalRevenue, totalTransactions, totalItems };
            };

            const handlePrintTicket = () => {
                // Créer un élément invisible pour l'impression
                const printWindow = window.open('', '', 'height=400,width=300');
                const ticketHTML = generateTicketHTML();
                
                printWindow.document.write(ticketHTML);
                printWindow.document.close();
                
                // Attendre que le document soit chargé avant d'imprimer
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            };

            const generateTicketHTML = () => {
                const now = new Date();
                const dateStr = now.toLocaleDateString('fr-FR', { year: 'numeric', month: '2-digit', day: '2-digit' });
                const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                
                const ticketItems = cart.map(item => `
                    <div style="display: flex; justify-content: space-between; padding: 2mm 0; border-bottom: 1px dotted #ccc;">
                        <div style="flex: 1;">
                            <div>${item.name.substring(0, 20)}</div>
                            <div style="font-size: 10px; color: #666;">${item.qty}x ${formatPrice(item.price)}</div>
                        </div>
                        <div style="text-align: right; font-weight: bold;">
                            ${formatPrice(item.price * item.qty)}
                        </div>
                    </div>
                `).join('');

                const selectedPaymentLabel = selectedPaymentMethod 
                    ? paymentMethods.find(m => m.id === selectedPaymentMethod)?.label 
                    : 'Non spécifié';

                return `
                    <!DOCTYPE html>
                    <html lang="fr">
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body {
                                margin: 0;
                                padding: 5mm;
                                width: 80mm;
                                background: white;
                                color: black;
                                font-family: 'Courier New', monospace;
                                font-size: 12px;
                                line-height: 1.4;
                            }
                            .ticket-header {
                                text-align: center;
                                border-bottom: 2px solid black;
                                padding-bottom: 5mm;
                                margin-bottom: 5mm;
                            }
                            .ticket-title {
                                font-size: 18px;
                                font-weight: bold;
                                margin-bottom: 2mm;
                            }
                            .ticket-line {
                                display: flex;
                                justify-content: space-between;
                                padding: 2mm 0;
                            }
                            .ticket-item {
                                padding: 2mm 0;
                                border-bottom: 1px dotted #ccc;
                            }
                            .ticket-total {
                                font-weight: bold;
                                font-size: 14px;
                                margin-top: 3mm;
                                padding-top: 3mm;
                                border-top: 2px solid black;
                                display: flex;
                                justify-content: space-between;
                            }
                            .ticket-footer {
                                text-align: center;
                                font-size: 10px;
                                margin-top: 5mm;
                                padding-top: 5mm;
                                border-top: 1px dashed black;
                            }
                            .info-row {
                                display: flex;
                                justify-content: space-between;
                                font-size: 11px;
                                margin: 1mm 0;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="ticket-header">
                            <div class="ticket-title">POS SPORT 🎿</div>
                            <div style="font-size: 11px; margin-top: 2mm;">Ticket de Caisse</div>
                        </div>

                        <div style="font-size: 10px; margin-bottom: 5mm;">
                            <div class="info-row">
                                <span>Date:</span>
                                <span>${dateStr} ${timeStr}</span>
                            </div>
                            ${selectedClient ? `
                                <div class="info-row">
                                    <span>Client:</span>
                                    <span>${selectedClient.prenom} ${selectedClient.nom}</span>
                                </div>
                                <div class="info-row">
                                    <span>N° Client:</span>
                                    <span>${selectedClient.num}</span>
                                </div>
                            ` : ''}
                        </div>

                        <div style="margin-bottom: 5mm;">
                            ${ticketItems}
                        </div>

                        <div class="ticket-total">
                            <span>TOTAL TTC:</span>
                            <span>${formatPrice(total)}</span>
                        </div>

                        <div style="margin-top: 3mm; padding: 2mm; background: #f0f0f0; border: 1px solid #ccc;">
                            <div style="text-align: center; font-weight: bold; margin-bottom: 1mm;">Mode de Paiement</div>
                            <div style="text-align: center; font-size: 13px; font-weight: bold;">
                                ${selectedPaymentLabel}
                            </div>
                        </div>

                        <div class="ticket-footer">
                            <div style="margin: 3mm 0;">Merci pour votre achat!</div>
                            <div>POS Sport © 2025</div>
                        </div>
                    </body>
                    </html>
                `;
            };

            // Calcul du total TTC (Exclut la caution pour le moment)
            const total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            const formatPrice = (price) => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(price);

            const filteredProducts = products.filter(p => 
                p.category === serviceTab && p.name.toLowerCase().includes(searchQuery.toLowerCase())
            );

            const tabs = ['Vente', 'Location', 'Services'];

            // Écran de connexion
            if (!isLoggedIn) {
                return (
                    <div className="flex h-screen items-center justify-center bg-gradient-to-br from-gray-900 to-gray-800">
                        <div className="bg-gray-800 p-12 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
                            <div className="text-center mb-8">
                                <h1 className="text-4xl font-bold text-green-400 mb-2">🎿 Caisse2</h1>
                                <p className="text-gray-400 text-lg">Système Point de Vente</p>
                                <p className="text-gray-500 text-xs mt-2">Multi-Entreprise | SaaS Ready</p>
                            </div>

                            <form onSubmit={handleLogin} className="space-y-6">
                                <div>
                                    <label className="block text-gray-300 font-semibold mb-2">Utilisateur</label>
                                    <input 
                                        type="text"
                                        value={loginUsername}
                                        onChange={(e) => setLoginUsername(e.target.value)}
                                        placeholder="Entrez votre nom d'utilisateur"
                                        className="w-full bg-gray-700 text-white border border-gray-600 p-3 rounded-lg focus:outline-none focus:border-green-500 transition"
                                        autoFocus
                                    />
                                </div>

                                <div>
                                    <label className="block text-gray-300 font-semibold mb-2">Mot de passe</label>
                                    <input 
                                        type="password"
                                        value={loginPassword}
                                        onChange={(e) => setLoginPassword(e.target.value)}
                                        placeholder="Entrez votre mot de passe"
                                        className="w-full bg-gray-700 text-white border border-gray-600 p-3 rounded-lg focus:outline-none focus:border-green-500 transition"
                                    />
                                </div>

                                {loginError && (
                                    <div className="bg-red-900/30 border border-red-700 text-red-400 p-3 rounded-lg text-sm font-semibold">
                                        ❌ {loginError}
                                    </div>
                                )}

                                <button 
                                    type="submit"
                                    className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition shadow-lg"
                                >
                                    🔓 Se Connecter
                                </button>
                            </form>

                            <div className="mt-8 border-t border-gray-700 pt-6">
                                <p className="text-gray-400 text-sm text-center mb-4">Identifiants de démonstration :</p>
                                <div className="bg-gray-700/50 p-3 rounded-lg space-y-2 text-xs text-gray-300">
                                    <p><span className="font-semibold text-blue-400">Super Admin :</span> superadmin / superadmin123</p>
                                    <p><span className="font-semibold text-purple-400">Admin :</span> admin1 / admin123</p>
                                    <p><span className="font-semibold text-yellow-400">Vendeur :</span> vendeur / vendeur123</p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Écran de sélection de société (pour super-admins)
            if (currentUser?.role === 'superadmin' && !selectedCompanyId) {
                return (
                    <div className="flex h-screen items-center justify-center bg-gradient-to-br from-gray-900 to-gray-800">
                        <div className="bg-gray-800 p-12 rounded-2xl shadow-2xl w-full max-w-2xl border border-gray-700">
                            <div className="text-center mb-8">
                                <h1 className="text-4xl font-bold text-blue-400 mb-2">👨‍💼 Super Administrateur</h1>
                                <p className="text-gray-400">Bienvenue {currentUser.fullName}</p>
                                <p className="text-gray-500 text-sm mt-2">Sélectionnez une société à gérer</p>
                            </div>

                            <div className="grid grid-cols-1 gap-4 max-h-96 overflow-y-auto">
                                {companies.map(company => (
                                    <button
                                        key={company.id}
                                        onClick={() => setSelectedCompanyId(company.id)}
                                        className="p-6 bg-gray-700 hover:bg-gray-600 rounded-lg border border-gray-600 hover:border-blue-500 transition text-left"
                                    >
                                        <div className="flex items-start justify-between">
                                            <div>
                                                <div className="text-xl font-bold text-white">{company.name}</div>
                                                <div className="text-sm text-gray-400 mt-1">SIRET: {company.siret}</div>
                                                <div className="text-sm text-gray-400">📍 {company.address}</div>
                                                <div className="text-sm text-gray-400">📧 {company.email}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className={`text-xs px-2 py-1 rounded ${company.status === 'active' ? 'bg-green-900/50 text-green-400' : 'bg-red-900/50 text-red-400'}`}>
                                                    {company.status === 'active' ? '✅ Active' : '❌ Inactive'}
                                                </div>
                                                <div className="text-xs text-gray-500 mt-2">{company.subscriptionPlan}</div>
                                            </div>
                                        </div>
                                    </button>
                                ))}
                            </div>

                            <div className="mt-6 flex gap-4">
                                <button 
                                    onClick={() => {
                                        setIsLoggedIn(false);
                                        setCurrentUser(null);
                                        setSelectedCompanyId(null);
                                        setLoginUsername('');
                                        setLoginPassword('');
                                    }}
                                    className="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-semibold transition"
                                >
                                    🚪 Déconnexion
                                </button>
                                <button 
                                    onClick={() => {
                                        const name = prompt('Nom de la nouvelle société:');
                                        if (!name) return;
                                        const siret = prompt('SIRET:');
                                        const address = prompt('Adresse:');
                                        const email = prompt('Email:');
                                        const phone = prompt('Téléphone:');
                                        
                                        const newCompany = {
                                            id: `COMPANY${String(companies.length + 1).padStart(3, '0')}`,
                                            name: name,
                                            siret: siret || '',
                                            address: address || '',
                                            email: email || '',
                                            phone: phone || '',
                                            createdDate: new Date().toISOString().split('T')[0],
                                            status: 'active',
                                            subscriptionPlan: 'standard'
                                        };
                                        setCompanies([...companies, newCompany]);
                                        alert(`✅ Société "${name}" créée !`);
                                    }}
                                    className="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition"
                                >
                                    ➕ Ajouter Société
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen font-sans bg-gray-900">
                    
                    {/* --- GAUCHE : TICKET (25%) --- */}
                    <div className="w-1/4 flex flex-col bg-gray-800 border-r border-gray-700 shadow-2xl z-10 relative">
                        <div className="p-4 bg-gray-900 text-white flex justify-between items-center shadow-md">
                            <div>
                                <h1 className="font-extrabold text-2xl text-green-400">POS Sport 🎿</h1>
                                <p className="text-xs text-gray-400 mt-1">
                                    👤 {currentUser?.fullName} <span className="text-yellow-400">({currentUser?.role === 'admin' ? 'Admin' : 'Vendeur'})</span>
                                </p>
                                {currentEntity && (
                                    <p className="text-xs text-purple-400 mt-1">
                                        🏢 {currentEntity.name}
                                    </p>
                                )}
                                {currentStore && (
                                    <p className="text-xs text-blue-400 mt-1">
                                        🏪 {currentStore.name}
                                    </p>
                                )}
                            </div>
                            <div className="flex items-center space-x-2">
                                <button 
                                    onClick={handleLogout}
                                    className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs font-semibold rounded transition"
                                    title="Déconnexion"
                                >
                                    🚪 Déco.
                                </button>
                            </div>
                        </div>
                        <div className="p-4 bg-gray-900 text-white shadow-md space-y-3">
                            {/* Sélecteur de Magasin */}
                            {accessibleStores.length > 1 && (
                                <div>
                                    <label className="text-xs text-gray-400 block mb-1 font-semibold">Sélectionner magasin:</label>
                                    <select 
                                        value={selectedStoreId || ''}
                                        onChange={(e) => setSelectedStoreId(e.target.value)}
                                        className="w-full px-2 py-2 bg-gray-700 text-white border border-gray-600 rounded text-xs focus:outline-none focus:border-blue-500 transition"
                                    >
                                        {accessibleStores.map(store => (
                                            <option key={store.id} value={store.id}>
                                                🏪 {store.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            )}
                            
                            <div className="flex items-center space-x-3 pt-2 border-t border-gray-700">
                                <button 
                                    onClick={() => setIsBackOfficeOpen(true)}
                                    className="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs font-semibold rounded transition"
                                    title="Accéder au back office"
                                >
                                    ⚙️ Back Office
                                </button>
                                <div className="text-xs text-gray-400">Ticket #2024-88</div>
                            </div>
                        </div>

                        {/* Champ de Scan Code-Barre */}
                        <form onSubmit={handleBarcodeScan} className="p-3 bg-gray-800 border-b border-gray-700">
                            <label className="text-xs text-gray-400 mb-1 block font-semibold">Scanner un article</label>
                            <div className="flex items-center space-x-2">
                                <input 
                                    type="text"
                                    value={barcodeInput}
                                    onChange={(e) => setBarcodeInput(e.target.value)}
                                    placeholder="Code-barre..."
                                    className="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none placeholder-gray-500"
                                    autoFocus
                                />
                                <button 
                                    type="submit"
                                    className="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition text-sm"
                                >
                                    📱
                                </button>
                            </div>
                            
                            {/* Message de Scan */}
                            {scanMessage && (
                                <div className={`mt-2 p-2 rounded text-xs font-semibold text-center ${
                                    scanMessageType === 'success' ? 'bg-green-900/50 text-green-300 border border-green-600' :
                                    scanMessageType === 'error' ? 'bg-red-900/50 text-red-300 border border-red-600' :
                                    'bg-blue-900/50 text-blue-300 border border-blue-600'
                                }`}>
                                    {scanMessage}
                                </div>
                            )}
                        </form>

                        {/* Liste Panier */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-2">
                            {cart.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-gray-500 select-none">
                                    <svg className="w-16 h-16 mb-4 opacity-20" fill="currentColor" viewBox="0 0 20 20"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path></svg>
                                    <span className="italic">Ajoutez des articles ou des locations...</span>
                                </div>
                            ) : (
                                cart.map((item, index) => (
                                    <div key={index} className="flex flex-col p-3 bg-gray-700 rounded-lg shadow-lg border border-gray-600 transition">
                                        
                                        {/* Ligne principale (Nom / Qty / Prix) */}
                                        <div className="flex justify-between items-center pb-2">
                                            <div className="flex-1">
                                                <div className="font-bold text-gray-200">{item.name}</div>
                                                <div className="text-xs text-gray-400">
                                                    {item.originalPrice && item.originalPrice !== item.price ? (
                                                        <span>
                                                            <span className="line-through text-red-400">{formatPrice(item.originalPrice)}</span>
                                                            {' → '}
                                                            <span className="text-green-400">{formatPrice(item.price)}</span>
                                                            {' / unité'}
                                                        </span>
                                                    ) : (
                                                        <span>{formatPrice(item.price)} / unité</span>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Contrôles Quantité */}
                                            <div className="flex items-center space-x-2 bg-gray-900 rounded-full p-0.5">
                                                <button onClick={() => updateQty(item.id, -1)} className="w-6 h-6 rounded-full bg-gray-600 text-red-400 hover:bg-red-900 font-bold">-</button>
                                                <span className="font-bold w-4 text-center text-sm">{item.qty}</span>
                                                <button onClick={() => updateQty(item.id, 1)} className="w-6 h-6 rounded-full bg-gray-600 text-green-400 hover:bg-green-900 font-bold">+</button>
                                            </div>
                                            
                                            <div className="w-20 text-right font-bold text-lg text-green-300">
                                                {formatPrice(item.price * item.qty)}
                                            </div>
                                        </div>

                                        {/* Boutons de modification prix et réduction */}
                                        <div className="flex gap-2 mt-2 pt-2 border-t border-gray-600">
                                            <button 
                                                onClick={() => {
                                                    const newPrice = prompt('Nouveau prix unitaire (€):', item.price);
                                                    if (newPrice && !isNaN(newPrice)) {
                                                        setCart(prevCart => prevCart.map(cartItem => 
                                                            cartItem.id === item.id 
                                                                ? { ...cartItem, originalPrice: cartItem.originalPrice || cartItem.price, price: parseFloat(newPrice) }
                                                                : cartItem
                                                        ));
                                                    }
                                                }}
                                                className="flex-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition"
                                            >
                                                💰 Modifier Prix
                                            </button>
                                            <button 
                                                onClick={() => {
                                                    const type = prompt('Type de réduction:\n1 = Pourcentage (%)\n2 = Montant (€)', '1');
                                                    if (type === '1') {
                                                        const percent = prompt('Réduction en % (ex: 10 pour -10%):', '');
                                                        if (percent && !isNaN(percent)) {
                                                            const reduction = parseFloat(percent);
                                                            const originalPrice = item.originalPrice || item.price;
                                                            const newPrice = originalPrice * (1 - reduction / 100);
                                                            setCart(prevCart => prevCart.map(cartItem => 
                                                                cartItem.id === item.id 
                                                                    ? { ...cartItem, originalPrice: originalPrice, price: newPrice }
                                                                    : cartItem
                                                            ));
                                                        }
                                                    } else if (type === '2') {
                                                        const amount = prompt('Réduction en € (ex: 5.00):', '');
                                                        if (amount && !isNaN(amount)) {
                                                            const reduction = parseFloat(amount);
                                                            const originalPrice = item.originalPrice || item.price;
                                                            const newPrice = Math.max(0, originalPrice - reduction);
                                                            setCart(prevCart => prevCart.map(cartItem => 
                                                                cartItem.id === item.id 
                                                                    ? { ...cartItem, originalPrice: originalPrice, price: newPrice }
                                                                    : cartItem
                                                            ));
                                                        }
                                                    }
                                                }}
                                                className="flex-1 px-2 py-1 bg-orange-600 hover:bg-orange-700 text-white text-xs rounded transition"
                                            >
                                                🏷️ Réduction
                                            </button>
                                            {item.originalPrice && item.originalPrice !== item.price && (
                                                <button 
                                                    onClick={() => {
                                                        setCart(prevCart => prevCart.map(cartItem => 
                                                            cartItem.id === item.id 
                                                                ? { ...cartItem, price: cartItem.originalPrice, originalPrice: undefined }
                                                                : cartItem
                                                        ));
                                                    }}
                                                    className="px-2 py-1 bg-gray-600 hover:bg-gray-700 text-white text-xs rounded transition"
                                                    title="Annuler la modification"
                                                >
                                                    ↺
                                                </button>
                                            )}
                                        </div>

                                        {/* Détails de Location (Si applicable) */}
                                        {item.isRentable && item.details && (
                                            <div className="text-xs p-2 mt-2 bg-gray-900 rounded border border-gray-700 space-y-1">
                                                <div className="font-semibold text-blue-400">Détails de Location:</div>
                                                <div className="flex justify-between text-gray-400"><span>Période:</span> <span>{item.details.startDate} → {item.details.endDate}</span></div>
                                                <div className="flex justify-between text-gray-400"><span>Type:</span> <span className="font-semibold text-blue-300">{item.details.rentalType === 'fullday' ? '📅 Journée Complète' : '⏰ Demi-Journée'}</span></div>
                                                {item.details.priceFullDay && (
                                                    <div className="flex justify-between text-gray-400"><span>Tarifs:</span> <span>{formatPrice(item.details.priceFullDay)}/j - {formatPrice(item.details.priceHalfDay)}/½j</span></div>
                                                )}
                                                <div className="flex justify-between text-gray-400"><span>Client:</span> <span>{item.details.client}</span></div>
                                                {item.details.caution > 0 && (
                                                    <div className="flex justify-between text-gray-300 font-bold"><span>Caution:</span> <span className="text-yellow-400">{formatPrice(item.details.caution)}</span></div>
                                                )}
                                            </div>
                                        )}

                                    </div>
                                ))
                            )}
                        </div>                        {/* Aide - Codes-barres Disponibles (Collapsible) */}
                        <details className="p-3 bg-gray-800 border-t border-gray-700 text-xs">
                            <summary className="cursor-pointer font-semibold text-gray-300 hover:text-white">📋 Codes-barres disponibles</summary>
                            <div className="mt-2 space-y-1 text-gray-400 text-xs">
                                {products.map(product => (
                                    <div key={product.id} className="p-1 bg-gray-900 rounded border border-gray-700">
                                        <div className="font-mono text-blue-300">{product.barcode}</div>
                                        <div className="truncate">{product.name}</div>
                                    </div>
                                ))}
                            </div>
                        </details>

                        {/* Bloc Client Sélectionné */}
                        <div className="p-4 bg-gray-800 border-t border-gray-700">
                            {selectedClient ? (
                                <div className="p-3 bg-green-900/30 border border-green-600 rounded-lg">
                                    <div className="text-xs text-gray-400 mb-1">Client Sélectionné</div>
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <div className="font-bold text-white">{selectedClient.prenom} {selectedClient.nom}</div>
                                            <div className="text-xs text-gray-400 mt-1">{selectedClient.num}</div>
                                        </div>
                                        <button 
                                            onClick={() => setIsClientModalOpen(true)}
                                            className="text-blue-400 hover:text-blue-300 text-xs font-semibold"
                                        >
                                            Changer
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <button 
                                    onClick={() => setIsClientModalOpen(true)}
                                    className="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition text-sm"
                                >
                                    + Sélectionner/Créer un Client
                                </button>
                            )}
                        </div>

                        {/* Totaux & Paiement */}
                        <div className="p-4 bg-gray-900 border-t border-gray-700 shadow-[0_-5px_15px_rgba(0,0,0,0.4)]">
                            <div className="flex justify-between items-center mb-4">
                                <span className="text-2xl font-bold text-gray-200">Total TTC</span>
                                <span className="text-4xl font-extrabold text-green-400">{formatPrice(total)}</span>
                            </div>
                            
                            <div className="space-y-2">
                                <button 
                                    onClick={() => {
                                        saveTransaction();
                                        handlePrintTicket();
                                    }}
                                    disabled={cart.length === 0 || !selectedPaymentMethod}
                                    className={`w-full py-4 rounded-xl text-white text-xl font-bold shadow-lg transform transition active:scale-95 flex items-center justify-center space-x-2
                                        ${cart.length === 0 || !selectedPaymentMethod ? 'bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 hover:shadow-green-700/50'}`}
                                >
                                    <span>VALIDER & ENCAISSER</span>
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2m0 0l4-4m-4 4H7a2 2 0 000 4h10a2 2 0 100-4H9z"></path></svg>
                                </button>

                                <button 
                                    onClick={() => setIsHistoryOpen(true)}
                                    className="w-full py-3 rounded-lg text-white font-semibold shadow-lg transform transition active:scale-95 flex items-center justify-center space-x-2 bg-purple-600 hover:bg-purple-700 hover:shadow-purple-700/50"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                    <span>HISTORIQUE</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* --- CENTRE : CATALOGUE (55%) --- */}
                    <div className="w-1/2 flex flex-col h-full bg-gray-900 border-r border-gray-700">
                        
                        {/* Onglets Services & Recherche */}
                        <div className="p-4 bg-gray-800 shadow-lg sticky top-0 z-20">
                            <div className="flex mb-4 border-b border-gray-700">
                                {tabs.map(tab => (
                                    <button 
                                        key={tab}
                                        onClick={() => { setServiceTab(tab); setSearchQuery(''); }}
                                        className={`px-6 py-3 text-sm font-semibold transition duration-200 
                                            ${serviceTab === tab ? 'text-green-400 border-b-2 border-green-400' : 'text-gray-400 hover:text-white'}`}
                                    >
                                        {tab}
                                    </button>
                                ))}
                            </div>

                            <div className="relative flex items-center space-x-2">
                                <span className="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                </span>
                                <input 
                                    type="text" 
                                    placeholder={`Rechercher un article ou une ${serviceTab.toLowerCase()}...`} 
                                    className="flex-1 py-3 pl-10 pr-4 rounded-lg bg-gray-700 border border-gray-600 focus:bg-gray-800 focus:ring-2 focus:ring-blue-500 focus:outline-none text-white transition"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                />
                                
                                {/* Boutons d'ajout d'articles */}
                                <button 
                                    onClick={() => setIsAddSaleModalOpen(true)}
                                    className="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition text-sm whitespace-nowrap"
                                    title="Ajouter article en vente"
                                >
                                    + Vente
                                </button>
                                <button 
                                    onClick={() => setIsAddRentalModalOpen(true)}
                                    className="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition text-sm whitespace-nowrap"
                                    title="Ajouter article en location"
                                >
                                    + Location
                                </button>
                            </div>
                        </div>

                        {/* Grille Produits */}
                        <div className="flex-1 p-6 overflow-y-auto">
                            {filteredProducts.length === 0 ? (
                                <div className="text-center text-gray-500 mt-10">
                                    Aucun article trouvé dans l'onglet "{serviceTab}".
                                </div>
                            ) : (
                                <div className="grid grid-cols-3 xl:grid-cols-4 gap-4">
                                    {filteredProducts.map((product) => (
                                        <div 
                                            key={product.id}
                                            onClick={() => addToCart(product)}
                                            className={`
                                                cursor-pointer relative h-40 rounded-xl shadow-lg border border-gray-700 
                                                hover:shadow-xl hover:border-blue-500 transition-all duration-200 
                                                flex flex-col items-center justify-center p-4 text-center no-select bg-gray-800
                                                active:scale-95 group overflow-hidden
                                            `}
                                        >
                                            {/* Bannière de Catégorie/Couleur */}
                                            <div className={`absolute top-0 left-0 w-full h-1.5 ${product.color.replace('/30', '')}`}></div>
                                            
                                            {/* Icône (simulée) */}
                                            <div className={`w-14 h-14 rounded-full mb-3 ${product.color} ${product.text} flex items-center justify-center text-xl font-bold`}>
                                                {product.name.charAt(0)}
                                            </div>
                                            
                                            <div className="font-bold text-gray-100 leading-tight mb-1">{product.name}</div>
                                            <div className="text-sm font-semibold text-green-400 bg-green-900/40 px-2 py-1 rounded-full">{formatPrice(product.price)}</div>

                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* --- MODES DE PAIEMENT --- */}
                    </div>

                    {/* --- DROITE : MODES DE PAIEMENT (20%) --- */}
                    <div className="w-1/5 flex flex-col bg-gray-800 border-l border-gray-700 shadow-lg">
                        <div className="p-4 bg-gray-900 text-white shadow-md sticky top-0 z-20">
                            <h3 className="text-sm font-bold text-gray-300">Mode de Paiement</h3>
                        </div>
                        
                        <div className="flex-1 flex flex-col p-4 overflow-y-auto space-y-3">
                            <div className="grid grid-cols-1 gap-3">
                                {paymentMethods.map((method) => (
                                    <button
                                        key={method.id}
                                        onClick={() => setSelectedPaymentMethod(method.id)}
                                        className={`
                                            py-3 px-3 rounded-lg text-sm font-semibold transition-all duration-200
                                            flex flex-col items-center justify-center space-y-2
                                            ${selectedPaymentMethod === method.id 
                                                ? `${method.color} text-white shadow-lg ring-2 ring-white scale-105` 
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                            }
                                        `}
                                    >
                                        <span className="text-2xl">{method.icon}</span>
                                        <span className="text-xs text-center leading-tight font-bold">{method.label}</span>
                                    </button>
                                ))}
                            </div>

                            {/* Affichage du mode sélectionné */}
                            {selectedPaymentMethod && (
                                <div className="mt-4 p-3 bg-gray-900 rounded border border-gray-700 text-center text-xs text-gray-300 sticky bottom-0">
                                    <div className="font-semibold text-gray-400 mb-1">Sélectionné:</div>
                                    <div className="font-bold text-green-400">{paymentMethods.find(m => m.id === selectedPaymentMethod)?.label}</div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* --- MODES DE PAIEMENT FIN --- */}

                    {/* Modales Ajout d'Articles */}
                    <AddSaleModal 
                        isOpen={isAddSaleModalOpen}
                        onClose={() => setIsAddSaleModalOpen(false)}
                        onAddItem={handleAddSaleItem}
                    />
                    
                    <AddRentalModal 
                        isOpen={isAddRentalModalOpen}
                        onClose={() => setIsAddRentalModalOpen(false)}
                        onAddItem={handleAddRentalItem}
                    />

                    {/* Modale Gestion Clients */}
                    <ClientManagementModal 
                        isOpen={isClientModalOpen}
                        onClose={() => setIsClientModalOpen(false)}
                        clients={clients}
                        onAddClient={handleAddClient}
                        onSelectClient={handleSelectClient}
                        generateClientNumber={generateClientNumber}
                    />

                    {/* --- MODALE HISTORIQUE & RAPPORTS --- */}
                    {isHistoryOpen && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                            <div className="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-6xl max-h-[85vh] overflow-hidden flex flex-col">
                                {/* Header */}
                                <div className="p-4 bg-gray-900 border-b border-gray-700 flex justify-between items-center">
                                    <div>
                                        <h2 className="text-xl font-bold text-white">📊 Historique & Rapports</h2>
                                        <p className="text-xs text-blue-400 mt-1">🏪 {currentStore?.name || 'Magasin non sélectionné'}</p>
                                    </div>
                                    <button 
                                        onClick={() => setIsHistoryOpen(false)}
                                        className="text-gray-400 hover:text-white text-2xl font-bold"
                                    >×</button>
                                </div>

                                {/* Filtres */}
                                <div className="p-4 bg-gray-850 border-b border-gray-700 flex gap-3">
                                    <button 
                                        onClick={() => setHistoryFilter('jour')}
                                        className={`px-4 py-2 rounded-lg font-semibold transition ${
                                            historyFilter === 'jour' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >📅 Jour</button>
                                    <button 
                                        onClick={() => setHistoryFilter('mois')}
                                        className={`px-4 py-2 rounded-lg font-semibold transition ${
                                            historyFilter === 'mois' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >📆 Mois</button>
                                    <button 
                                        onClick={() => setHistoryFilter('annee')}
                                        className={`px-4 py-2 rounded-lg font-semibold transition ${
                                            historyFilter === 'annee' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >📊 Année</button>
                                </div>

                                {/* Statistiques */}
                                {(() => {
                                    const stats = getStats();
                                    return (
                                        <div className="p-4 bg-gray-800 border-b border-gray-700 grid grid-cols-3 gap-4">
                                            <div className="bg-green-900/30 p-3 rounded-lg border border-green-700">
                                                <div className="text-xs text-gray-400">Revenu Total</div>
                                                <div className="text-2xl font-bold text-green-400">{formatPrice(stats.totalRevenue)}</div>
                                            </div>
                                            <div className="bg-blue-900/30 p-3 rounded-lg border border-blue-700">
                                                <div className="text-xs text-gray-400">Transactions</div>
                                                <div className="text-2xl font-bold text-blue-400">{stats.totalTransactions}</div>
                                            </div>
                                            <div className="bg-purple-900/30 p-3 rounded-lg border border-purple-700">
                                                <div className="text-xs text-gray-400">Articles Vendus</div>
                                                <div className="text-2xl font-bold text-purple-400">{stats.totalItems}</div>
                                            </div>
                                        </div>
                                    );
                                })()}

                                {/* Liste des Transactions */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {getFilteredTransactions().length === 0 ? (
                                        <div className="text-center text-gray-500 py-8">
                                            Aucune transaction pour cette période
                                        </div>
                                    ) : (
                                        getFilteredTransactions().map(tx => (
                                            <div key={tx.id} className="bg-gray-700 p-3 rounded-lg border border-gray-600 text-sm">
                                                <div className="flex justify-between items-start mb-2">
                                                    <div>
                                                        <div className="font-bold text-white">{tx.client} ({tx.clientNum})</div>
                                                        <div className="text-xs text-gray-400">{new Date(tx.date).toLocaleString('fr-FR')}</div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="font-bold text-green-400">{formatPrice(tx.total)}</div>
                                                        <div className="text-xs text-gray-400">{tx.paymentMethod}</div>
                                                    </div>
                                                </div>
                                                <div className="text-xs text-gray-300 ml-2">
                                                    {tx.items.map((item, i) => (
                                                        <div key={i}>{item.qty}x {item.name}</div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>

                                {/* Footer */}
                                <div className="p-4 bg-gray-900 border-t border-gray-700 flex justify-end gap-2">
                                    <button 
                                        onClick={() => setIsHistoryOpen(false)}
                                        className="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-semibold transition"
                                    >Fermer</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODALE BACK OFFICE --- */}
                    {isBackOfficeOpen && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-2">
                            <div className="bg-gray-800 rounded-2xl shadow-2xl w-full h-full max-w-full max-h-full overflow-hidden flex flex-col">
                                {/* Header */}
                                <div className="p-4 bg-gray-900 border-b border-gray-700 flex justify-between items-center">
                                    <h2 className="text-2xl font-bold text-white">⚙️ Back Office</h2>
                                    <button 
                                        onClick={() => setIsBackOfficeOpen(false)}
                                        className="text-gray-400 hover:text-white text-2xl font-bold"
                                    >×</button>
                                </div>

                                {/* Onglets */}
                                <div className="flex border-b border-gray-700 bg-gray-850 overflow-x-auto">
                                    <button 
                                        onClick={() => setBackOfficeTab('dashboard')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'dashboard' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >📊 Tableau de Bord</button>
                                    <button 
                                        onClick={() => setBackOfficeTab('suppliers')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'suppliers' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >📦 Fournisseurs</button>
                                    <button 
                                        onClick={() => setBackOfficeTab('articles')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'articles' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >🏷️ Articles + Coûts</button>
                                    <button 
                                        onClick={() => setBackOfficeTab('stock')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'stock' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >📦 Stock</button>
                                    <button 
                                        onClick={() => setBackOfficeTab('finances')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'finances' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >💰 Finances</button>
                                    <button 
                                        onClick={() => setBackOfficeTab('clients')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'clients' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >👥 CRM Clients</button>
                                    <button 
                                        onClick={() => setBackOfficeTab('mentions')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'mentions' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >⚖️ Mentions Légales</button>
                                    <button 
                                        onClick={() => setBackOfficeTab('labels')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'labels' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >📌 Étiquettes</button>
                                    <button 
                                        onClick={() => setBackOfficeTab('reports')}
                                        className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                            backOfficeTab === 'reports' 
                                                ? 'text-blue-400 border-b-2 border-blue-400' 
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >📈 Rapports</button>
                                    {currentUser?.role === 'superadmin' && (
                                        <button 
                                            onClick={() => setBackOfficeTab('companies')}
                                            className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                                backOfficeTab === 'companies' 
                                                    ? 'text-blue-400 border-b-2 border-blue-400' 
                                                    : 'text-gray-400 hover:text-white'
                                            }`}
                                        >🏢 Gestion Sociétés</button>
                                    )}
                                    {isAdmin() && (
                                        <>
                                            <button 
                                                onClick={() => setBackOfficeTab('entities')}
                                                className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                                    backOfficeTab === 'entities' 
                                                        ? 'text-blue-400 border-b-2 border-blue-400' 
                                                        : 'text-gray-400 hover:text-white'
                                                }`}
                                            >🏢 Entités</button>
                                            <button 
                                                onClick={() => setBackOfficeTab('stores')}
                                                className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                                    backOfficeTab === 'stores' 
                                                        ? 'text-blue-400 border-b-2 border-blue-400' 
                                                        : 'text-gray-400 hover:text-white'
                                                }`}
                                            >🏪 Magasins</button>
                                            <button 
                                                onClick={() => setBackOfficeTab('users')}
                                                className={`px-4 py-3 font-semibold transition whitespace-nowrap ${
                                                    backOfficeTab === 'users' 
                                                        ? 'text-blue-400 border-b-2 border-blue-400' 
                                                        : 'text-gray-400 hover:text-white'
                                                }`}
                                            >👨‍💼 Utilisateurs</button>
                                        </>
                                    )}
                                </div>

                                {/* Contenu */}
                                <div className="flex-1 overflow-y-auto p-6">
                                    {/* --- ONGLET DASHBOARD --- */}
                                    {backOfficeTab === 'dashboard' && (
                                        <div className="space-y-6">
                                            <h2 className="text-3xl font-bold text-white mb-6">📊 Tableau de Bord Analytics</h2>
                                            
                                            {/* Métriques clés */}
                                            <div className="grid grid-cols-4 gap-4">
                                                <div className="bg-gradient-to-br from-blue-600 to-blue-800 p-4 rounded-lg border border-blue-500">
                                                    <div className="text-gray-300 text-sm font-semibold">Chiffre d'affaires total</div>
                                                    <div className="text-3xl font-bold text-white mt-2">
                                                        {transactions.reduce((sum, t) => sum + (t.total || 0), 0).toFixed(2)}€
                                                    </div>
                                                </div>
                                                <div className="bg-gradient-to-br from-green-600 to-green-800 p-4 rounded-lg border border-green-500">
                                                    <div className="text-gray-300 text-sm font-semibold">Nombre de transactions</div>
                                                    <div className="text-3xl font-bold text-white mt-2">{transactions.length}</div>
                                                </div>
                                                <div className="bg-gradient-to-br from-purple-600 to-purple-800 p-4 rounded-lg border border-purple-500">
                                                    <div className="text-gray-300 text-sm font-semibold">Ticket moyen</div>
                                                    <div className="text-3xl font-bold text-white mt-2">
                                                        {transactions.length > 0 
                                                            ? (transactions.reduce((sum, t) => sum + (t.total || 0), 0) / transactions.length).toFixed(2)
                                                            : '0.00'}€
                                                    </div>
                                                </div>
                                                <div className="bg-gradient-to-br from-orange-600 to-orange-800 p-4 rounded-lg border border-orange-500">
                                                    <div className="text-gray-300 text-sm font-semibold">Articles vendus</div>
                                                    <div className="text-3xl font-bold text-white mt-2">
                                                        {transactions.reduce((sum, t) => sum + (t.items?.length || 0), 0)}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Revenu par mode de paiement */}
                                            <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                <h3 className="text-xl font-bold text-white mb-4">💳 Revenu par mode de paiement</h3>
                                                <div className="space-y-3">
                                                    {(() => {
                                                        const paymentBreakdown = {
                                                            'especes': { total: 0, color: 'bg-green-600', label: '💵 Espèces' },
                                                            'carte': { total: 0, color: 'bg-blue-600', label: '💳 Carte' },
                                                            'cle-u': { total: 0, color: 'bg-purple-600', label: '🔑 Clé-U' },
                                                            'cheque': { total: 0, color: 'bg-yellow-600', label: '📋 Chèque' },
                                                            'globalpos': { total: 0, color: 'bg-red-600', label: '🌐 GlobalPOS' }
                                                        };
                                                        
                                                        transactions.forEach(t => {
                                                            if (paymentBreakdown[t.paymentMethod]) {
                                                                paymentBreakdown[t.paymentMethod].total += t.total || 0;
                                                            }
                                                        });

                                                        const totalRevenue = Object.values(paymentBreakdown).reduce((sum, p) => sum + p.total, 0);
                                                        
                                                        return Object.entries(paymentBreakdown).map(([method, data]) => {
                                                            const percentage = totalRevenue > 0 ? (data.total / totalRevenue * 100).toFixed(1) : 0;
                                                            return (
                                                                <div key={method} className="space-y-2">
                                                                    <div className="flex justify-between items-center">
                                                                        <span className="text-gray-300">{data.label}</span>
                                                                        <span className="font-bold text-white">{data.total.toFixed(2)}€</span>
                                                                    </div>
                                                                    <div className="w-full bg-gray-700 rounded-full h-2">
                                                                        <div 
                                                                            className={`h-2 rounded-full ${data.color}`}
                                                                            style={{width: `${percentage}%`}}
                                                                        ></div>
                                                                    </div>
                                                                    <div className="text-right text-gray-400 text-sm">{percentage}%</div>
                                                                </div>
                                                            );
                                                        });
                                                    })()}
                                                </div>
                                            </div>

                                            {/* Top 5 Produits */}
                                            <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                <h3 className="text-xl font-bold text-white mb-4">🏆 Top 5 Produits vendus</h3>
                                                <div className="space-y-4">
                                                    {(() => {
                                                        const productCounts = {};
                                                        
                                                        transactions.forEach(t => {
                                                            if (t.items && Array.isArray(t.items)) {
                                                                t.items.forEach(item => {
                                                                    const name = item.name || item.article || 'Sans nom';
                                                                    productCounts[name] = (productCounts[name] || 0) + (item.quantity || 1);
                                                                });
                                                            }
                                                        });
                                                        
                                                        const sortedProducts = Object.entries(productCounts)
                                                            .sort((a, b) => b[1] - a[1])
                                                            .slice(0, 5);

                                                        return sortedProducts.length > 0 ? (
                                                            sortedProducts.map((product, index) => (
                                                                <div key={product[0]} className="flex items-center space-x-4">
                                                                    <div className="bg-blue-600 rounded-full w-8 h-8 flex items-center justify-center font-bold text-white text-sm">
                                                                        {index + 1}
                                                                    </div>
                                                                    <div className="flex-1">
                                                                        <div className="font-semibold text-white">{product[0]}</div>
                                                                        <div className="w-full bg-gray-700 rounded-full h-2 mt-2">
                                                                            <div 
                                                                                className="bg-gradient-to-r from-blue-400 to-blue-600 h-2 rounded-full"
                                                                                style={{width: `${(product[1] / (sortedProducts[0]?.[1] || 1) * 100).toFixed(0)}%`}}
                                                                            ></div>
                                                                        </div>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <div className="font-bold text-white">{product[1]}</div>
                                                                        <div className="text-gray-400 text-sm">unités</div>
                                                                    </div>
                                                                </div>
                                                            ))
                                                        ) : (
                                                            <div className="text-center text-gray-400 py-8">
                                                                Aucune transaction enregistrée
                                                            </div>
                                                        );
                                                    })()}
                                                </div>
                                            </div>

                                            {/* Activité par jour/mois/année */}
                                            <div className="grid grid-cols-3 gap-4">
                                                <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                    <h3 className="text-lg font-bold text-white mb-4">📅 Aujourd'hui</h3>
                                                    {(() => {
                                                        const today = new Date().toISOString().split('T')[0];
                                                        const todayTransactions = transactions.filter(t => 
                                                            t.date && t.date.startsWith(today)
                                                        );
                                                        return (
                                                            <div className="space-y-2">
                                                                <div className="text-2xl font-bold text-green-400">
                                                                    {todayTransactions.reduce((sum, t) => sum + (t.total || 0), 0).toFixed(2)}€
                                                                </div>
                                                                <div className="text-gray-400 text-sm">{todayTransactions.length} transactions</div>
                                                            </div>
                                                        );
                                                    })()}
                                                </div>
                                                <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                    <h3 className="text-lg font-bold text-white mb-4">📆 Ce mois</h3>
                                                    {(() => {
                                                        const now = new Date();
                                                        const monthTransactions = transactions.filter(t => {
                                                            if (!t.date) return false;
                                                            const tDate = new Date(t.date);
                                                            return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
                                                        });
                                                        return (
                                                            <div className="space-y-2">
                                                                <div className="text-2xl font-bold text-blue-400">
                                                                    {monthTransactions.reduce((sum, t) => sum + (t.total || 0), 0).toFixed(2)}€
                                                                </div>
                                                                <div className="text-gray-400 text-sm">{monthTransactions.length} transactions</div>
                                                            </div>
                                                        );
                                                    })()}
                                                </div>
                                                <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                    <h3 className="text-lg font-bold text-white mb-4">📊 Cette année</h3>
                                                    {(() => {
                                                        const now = new Date();
                                                        const yearTransactions = transactions.filter(t => {
                                                            if (!t.date) return false;
                                                            const tDate = new Date(t.date);
                                                            return tDate.getFullYear() === now.getFullYear();
                                                        });
                                                        return (
                                                            <div className="space-y-2">
                                                                <div className="text-2xl font-bold text-purple-400">
                                                                    {yearTransactions.reduce((sum, t) => sum + (t.total || 0), 0).toFixed(2)}€
                                                                </div>
                                                                <div className="text-gray-400 text-sm">{yearTransactions.length} transactions</div>
                                                            </div>
                                                        );
                                                    })()}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* --- ONGLET FOURNISSEURS --- */}
                                    {backOfficeTab === 'suppliers' && (
                                        <div className="space-y-4">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-lg font-bold text-white">🏭 Gestion des Fournisseurs</h3>
                                                <div className="flex gap-2">
                                                    <label className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded transition cursor-pointer flex items-center gap-2">
                                                        📥 Importer Excel
                                                        <input 
                                                            type="file" 
                                                            accept=".xlsx,.xls,.csv" 
                                                            onChange={handleSuppliersImport}
                                                            className="hidden"
                                                        />
                                                    </label>
                                                    <button 
                                                        onClick={() => {
                                                            const newSupplier = {
                                                                id: `SUP${String(suppliers.length + 1).padStart(3, '0')}`,
                                                                name: prompt('Nom du fournisseur:') || 'Nouveau Fournisseur',
                                                                email: prompt('Email:') || '',
                                                                phone: prompt('Téléphone:') || '',
                                                                country: prompt('Pays:') || 'France'
                                                            };
                                                            const updated = [...suppliers, newSupplier];
                                                            setSuppliers(updated);
                                                            localStorage.setItem('posSuppliers', JSON.stringify(updated));
                                                            // 🔥 Sauvegarder dans Firebase
                                                            saveToFirestore('suppliers', newSupplier);
                                                        }}
                                                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded transition"
                                                    >
                                                        + Ajouter Manuel
                                                    </button>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-1 gap-3">
                                                {suppliers.map(supplier => (
                                                    <div key={supplier.id} className="bg-gray-700 p-4 rounded-lg border border-gray-600 hover:border-blue-500 transition">
                                                        <div className="flex justify-between items-start">
                                                            <div className="flex-1">
                                                                <div className="font-bold text-white text-lg">{supplier.name}</div>
                                                                <div className="text-sm text-gray-400 mt-2 space-y-1">
                                                                    <div>📧 {supplier.email}</div>
                                                                    <div>📞 {supplier.phone}</div>
                                                                    <div>🌍 {supplier.country}</div>
                                                                </div>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className="font-mono text-blue-400 font-semibold">{supplier.id}</div>
                                                                <button 
                                                                    onClick={() => {
                                                                        const updated = suppliers.filter(s => s.id !== supplier.id);
                                                                        setSuppliers(updated);
                                                                        localStorage.setItem('posSuppliers', JSON.stringify(updated));
                                                                    }}
                                                                    className="text-xs text-red-400 hover:text-red-300 mt-2"
                                                                >
                                                                    Supprimer
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* --- ONGLET ARTICLES + COÛTS + FOURNISSEURS --- */}
                                    {backOfficeTab === 'articles' && (
                                        <div className="space-y-6">
                                            <div className="flex justify-between items-center">
                                                <h2 className="text-2xl font-bold text-white">🏷️ Gestion des Articles & Fournisseurs</h2>
                                                <div className="flex gap-2">
                                                    <label className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold cursor-pointer transition flex items-center gap-2">
                                                        📥 Importer Excel
                                                        <input 
                                                            type="file" 
                                                            accept=".xlsx,.xls" 
                                                            onChange={handleExcelImport}
                                                            className="hidden"
                                                        />
                                                    </label>
                                                    <button 
                                                        onClick={() => {
                                                            const example = "Exemple de format Excel:\nnom | prix | categorie | barcode | location\nSki Expert | 35.00 | Location | 370123456 | oui\nGants Ski | 49.99 | Vente | 370123457 | non";
                                                            alert(example);
                                                        }}
                                                        className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition"
                                                    >
                                                        ℹ️ Format
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Affichage de tous les articles */}
                                            <div className="space-y-4">
                                                <h3 className="text-xl font-bold text-white">📦 Catalogue Complet ({products.length} articles)</h3>
                                                <div className="grid grid-cols-1 gap-4">
                                                    {products.map(product => {
                                                        const supplier = productSuppliers[product.id];
                                                        const cost = productCosts[product.id] || 0;
                                                        const margin = product.price > 0 && cost > 0 
                                                            ? ((product.price - cost) / product.price * 100).toFixed(1)
                                                            : 0;
                                                        const stock = productStock[product.id] || 0;

                                                        return (
                                                            <div key={product.id} className="bg-gray-800 p-6 rounded-lg border border-gray-700 hover:border-blue-500 transition">
                                                                <div className="grid grid-cols-3 gap-4 mb-4">
                                                                    {/* Infos produit */}
                                                                    <div>
                                                                        <div className="font-bold text-white text-lg">{product.name}</div>
                                                                        <div className="text-xs font-mono text-gray-400 mt-1">Code: {product.barcode}</div>
                                                                        <div className="text-sm text-gray-300 mt-3 space-y-1">
                                                                            <div>📂 {product.category}</div>
                                                                            <div>🔄 {product.isRentable ? '📍 Location' : '🛒 Vente'}</div>
                                                                        </div>
                                                                    </div>

                                                                    {/* Prix et marge */}
                                                                    <div>
                                                                        <div className="text-sm text-gray-400 font-semibold mb-2">💰 Tarification</div>
                                                                        <div className="space-y-2">
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Prix de vente</div>
                                                                                <div className="text-xl font-bold text-green-400">{formatPrice(product.price)}</div>
                                                                            </div>
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Coût d'achat</div>
                                                                                <div className="text-lg font-bold text-yellow-400">{cost.toFixed(2)}€</div>
                                                                            </div>
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Marge</div>
                                                                                <div className={`text-lg font-bold ${margin >= 30 ? 'text-green-400' : margin >= 20 ? 'text-yellow-400' : 'text-red-400'}`}>
                                                                                    {margin}%
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    {/* Fournisseur et stock */}
                                                                    <div>
                                                                        <div className="text-sm text-gray-400 font-semibold mb-2">📦 Fournisseur & Stock</div>
                                                                        <div className="space-y-2">
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Fournisseur</div>
                                                                                <select 
                                                                                    value={supplier?.id || ''}
                                                                                    onChange={(e) => {
                                                                                        const suppId = e.target.value;
                                                                                        if (suppId) {
                                                                                            const sup = suppliers.find(s => s.id === suppId);
                                                                                            setProductSuppliers(prev => ({
                                                                                                ...prev,
                                                                                                [product.id]: sup
                                                                                            }));
                                                                                            localStorage.setItem('posProductSuppliers', JSON.stringify({
                                                                                                ...productSuppliers,
                                                                                                [product.id]: sup
                                                                                            }));
                                                                                        }
                                                                                    }}
                                                                                    className="w-full px-2 py-1 bg-gray-700 text-white text-sm rounded border border-gray-600 focus:border-blue-500"
                                                                                >
                                                                                    <option value="">Choisir un fournisseur</option>
                                                                                    {suppliers.map(sup => (
                                                                                        <option key={sup.id} value={sup.id}>{sup.name}</option>
                                                                                    ))}
                                                                                </select>
                                                                                {supplier && <div className="text-xs text-blue-300 mt-1">✅ {supplier.name}</div>}
                                                                            </div>
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Stock actuel</div>
                                                                                <div className="flex items-center space-x-2 mt-1">
                                                                                    <input 
                                                                                        type="number"
                                                                                        min="0"
                                                                                        value={stock}
                                                                                        onChange={(e) => {
                                                                                            const newStock = parseInt(e.target.value) || 0;
                                                                                            setProductStock(prev => ({
                                                                                                ...prev,
                                                                                                [product.id]: newStock
                                                                                            }));
                                                                                            localStorage.setItem('posProductStock', JSON.stringify({
                                                                                                ...productStock,
                                                                                                [product.id]: newStock
                                                                                            }));
                                                                                        }}
                                                                                        className="w-16 px-2 py-1 bg-gray-700 text-white text-sm rounded border border-gray-600 focus:border-blue-500"
                                                                                    />
                                                                                    <span className="text-sm text-gray-300">unités</span>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                {/* Input pour le coût d'achat */}
                                                                <div className="border-t border-gray-700 pt-4">
                                                                    <label className="block text-sm text-gray-400 font-semibold mb-2">💳 Entrer le coût d'achat (€)</label>
                                                                    <div className="flex gap-2">
                                                                        <input 
                                                                            type="number"
                                                                            step="0.01"
                                                                            min="0"
                                                                            value={cost}
                                                                            onChange={(e) => {
                                                                                const newCost = parseFloat(e.target.value) || 0;
                                                                                setProductCosts(prev => ({
                                                                                    ...prev,
                                                                                    [product.id]: newCost
                                                                                }));
                                                                                localStorage.setItem('posProductCosts', JSON.stringify({
                                                                                    ...productCosts,
                                                                                    [product.id]: newCost
                                                                                }));
                                                                            }}
                                                                            className="flex-1 px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-green-500"
                                                                            placeholder="Coût d'achat"
                                                                        />
                                                                        <div className="flex items-center px-3 bg-gray-700 rounded border border-gray-600 text-gray-300">
                                                                            Marge: <span className="ml-2 font-bold text-green-400">{margin}%</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* --- ONGLET STOCK --- */}
                                    {backOfficeTab === 'stock' && (
                                        <div className="space-y-6">
                                            <h2 className="text-2xl font-bold text-white">📦 Gestion de Stock</h2>

                                            {/* Vue résumée - Alertes stock bas */}
                                            <div className="bg-gradient-to-r from-red-900 to-red-800 rounded-lg border border-red-700 p-6">
                                                <h3 className="text-lg font-bold text-white mb-4">⚠️ Articles en alerte stock</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    {MOCK_PRODUCTS.map(product => {
                                                        const stock = productStock[product.id] || 0;
                                                        const alertLevel = stockAlerts[product.id] || 10;
                                                        
                                                        if (stock <= alertLevel) {
                                                            return (
                                                                <div key={product.id} className="bg-gray-800 p-4 rounded-lg border border-red-600">
                                                                    <div className="flex justify-between items-start mb-2">
                                                                        <div className="font-bold text-white">{product.name}</div>
                                                                        <span className="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded">ALERTE</span>
                                                                    </div>
                                                                    <div className="flex justify-between items-center">
                                                                        <div className="text-sm text-gray-400">Stock actuel: <span className="text-red-400 font-bold text-lg">{stock}</span></div>
                                                                        <div className="text-sm text-gray-400">Seuil: <span className="text-yellow-400 font-bold">{alertLevel}</span></div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        }
                                                        return null;
                                                    })}
                                                    {!MOCK_PRODUCTS.some(p => {
                                                        const stock = productStock[p.id] || 0;
                                                        const alertLevel = stockAlerts[p.id] || 10;
                                                        return stock <= alertLevel;
                                                    }) && (
                                                        <div className="col-span-full text-center text-green-400 py-4">✅ Tous les stocks sont suffisants !</div>
                                                    )}
                                                </div>
                                            </div>

                                            {/* Gestion détaillée du stock */}
                                            <div className="space-y-4">
                                                <h3 className="text-xl font-bold text-white">📊 Inventaire détaillé</h3>
                                                <div className="grid grid-cols-1 gap-4">
                                                    {MOCK_PRODUCTS.map(product => {
                                                        const stock = productStock[product.id] || 0;
                                                        const alertLevel = stockAlerts[product.id] || 10;
                                                        const status = stock > alertLevel * 2 ? 'OK' : stock > alertLevel ? 'ATTENTION' : 'CRITIQUE';
                                                        const statusColor = status === 'OK' ? 'text-green-400' : status === 'ATTENTION' ? 'text-yellow-400' : 'text-red-400';
                                                        
                                                        return (
                                                            <div key={product.id} className="bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-blue-500 transition">
                                                                <div className="grid grid-cols-4 gap-4 items-center">
                                                                    {/* Infos produit */}
                                                                    <div>
                                                                        <div className="font-bold text-white">{product.name}</div>
                                                                        <div className="text-xs text-gray-400 mt-1">{product.barcode}</div>
                                                                    </div>

                                                                    {/* Stock actuel */}
                                                                    <div>
                                                                        <div className="text-sm text-gray-400">Stock actuel</div>
                                                                        <div className={`text-2xl font-bold ${statusColor}`}>{stock}</div>
                                                                    </div>

                                                                    {/* Seuil d'alerte */}
                                                                    <div>
                                                                        <div className="text-sm text-gray-400">Seuil d'alerte</div>
                                                                        <input 
                                                                            type="number"
                                                                            min="0"
                                                                            value={alertLevel}
                                                                            onChange={(e) => {
                                                                                const newAlert = parseInt(e.target.value) || 0;
                                                                                setStockAlerts(prev => ({
                                                                                    ...prev,
                                                                                    [product.id]: newAlert
                                                                                }));
                                                                                localStorage.setItem('posStockAlerts', JSON.stringify({
                                                                                    ...stockAlerts,
                                                                                    [product.id]: newAlert
                                                                                }));
                                                                            }}
                                                                            className="w-20 px-2 py-1 bg-gray-700 text-white rounded border border-gray-600 focus:border-yellow-500"
                                                                        />
                                                                    </div>

                                                                    {/* Boutons d'ajustement */}
                                                                    <div className="flex gap-2">
                                                                        <button 
                                                                            onClick={() => {
                                                                                const newStock = stock + 1;
                                                                                setProductStock(prev => ({...prev, [product.id]: newStock}));
                                                                                localStorage.setItem('posProductStock', JSON.stringify({...productStock, [product.id]: newStock}));
                                                                                recordStockMovement(product.id, 1, 'entrée', 'Ajustement manuel');
                                                                            }}
                                                                            className="px-2 py-1 bg-green-600 hover:bg-green-700 text-white text-sm rounded transition"
                                                                        >+1</button>
                                                                        <button 
                                                                            onClick={() => {
                                                                                if (stock > 0) {
                                                                                    const newStock = stock - 1;
                                                                                    setProductStock(prev => ({...prev, [product.id]: newStock}));
                                                                                    localStorage.setItem('posProductStock', JSON.stringify({...productStock, [product.id]: newStock}));
                                                                                    recordStockMovement(product.id, 1, 'sortie', 'Ajustement manuel');
                                                                                }
                                                                            }}
                                                                            className="px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition disabled:opacity-50"
                                                                            disabled={stock === 0}
                                                                        >-1</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>

                                            {/* Historique des mouvements */}
                                            <div className="space-y-4">
                                                <h3 className="text-xl font-bold text-white">📜 Historique des mouvements</h3>
                                                <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
                                                    {stockMovements.length > 0 ? (
                                                        <div className="space-y-2 max-h-96 overflow-y-auto">
                                                            {[...stockMovements].reverse().slice(0, 50).map(movement => (
                                                                <div key={movement.id} className={`p-3 rounded border-l-4 flex justify-between items-center ${
                                                                    movement.type === 'entrée' 
                                                                        ? 'bg-green-900/20 border-green-600' 
                                                                        : 'bg-red-900/20 border-red-600'
                                                                }`}>
                                                                    <div className="flex-1">
                                                                        <div className="font-semibold text-white">{movement.productName}</div>
                                                                        <div className="text-sm text-gray-400">
                                                                            {movement.reason} · {new Date(movement.date).toLocaleString('fr-FR')}
                                                                        </div>
                                                                    </div>
                                                                    <div className={`text-lg font-bold ${movement.type === 'entrée' ? 'text-green-400' : 'text-red-400'}`}>
                                                                        {movement.type === 'entrée' ? '+' : '-'}{movement.quantity}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <div className="text-center text-gray-400 py-8">Aucun mouvement enregistré</div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* --- ONGLET FINANCES --- */}
                                    {backOfficeTab === 'finances' && (
                                        <div className="space-y-6">
                                            <h2 className="text-2xl font-bold text-white">💰 Gestion Financière</h2>

                                            {(() => {
                                                // Bilan du jour
                                                const today = new Date();
                                                today.setHours(0, 0, 0, 0);
                                                const tomorrowStart = new Date(today);
                                                tomorrowStart.setDate(tomorrowStart.getDate() + 1);

                                                // Bilan du mois
                                                const monthStart = new Date(today);
                                                monthStart.setDate(1);
                                                const monthEnd = new Date(today);
                                                monthEnd.setDate(monthEnd.getDate() + 1);

                                                // Bilan de l'année
                                                const yearStart = new Date(today);
                                                yearStart.setMonth(0, 1);
                                                const yearEnd = new Date(today);
                                                yearEnd.setDate(yearEnd.getDate() + 1);

                                                const dailyStats = getFinancialStats(today, tomorrowStart);
                                                const monthlyStats = getFinancialStats(monthStart, monthEnd);
                                                const yearlyStats = getFinancialStats(yearStart, yearEnd);

                                                return (
                                                    <>
                                                        {/* Bilans rapides */}
                                                        <div className="grid grid-cols-3 gap-4">
                                                            {/* Bilan du jour */}
                                                            <div className="bg-gradient-to-br from-blue-900 to-blue-800 rounded-lg border border-blue-600 p-6">
                                                                <h3 className="text-lg font-bold text-white mb-4">📅 Bilan du jour</h3>
                                                                <div className="space-y-3">
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Chiffre d'affaires</div>
                                                                        <div className="text-2xl font-bold text-green-400">{dailyStats.totalRevenue.toFixed(2)}€</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Coûts produits</div>
                                                                        <div className="text-lg text-yellow-400">{dailyStats.totalCost.toFixed(2)}€</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Dépenses</div>
                                                                        <div className="text-lg text-red-400">{dailyStats.totalExpenses.toFixed(2)}€</div>
                                                                    </div>
                                                                    <div className="border-t border-blue-700 pt-3">
                                                                        <div className="text-xs text-gray-300">Bénéfice net</div>
                                                                        <div className={`text-2xl font-bold ${dailyStats.netProfit >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                                            {dailyStats.netProfit.toFixed(2)}€
                                                                        </div>
                                                                        <div className="text-xs text-gray-400 mt-1">Marge: {dailyStats.profitMargin}%</div>
                                                                    </div>
                                                                    <div className="text-xs text-gray-400 mt-2">{dailyStats.totalTransactions} transactions</div>
                                                                </div>
                                                            </div>

                                                            {/* Bilan du mois */}
                                                            <div className="bg-gradient-to-br from-purple-900 to-purple-800 rounded-lg border border-purple-600 p-6">
                                                                <h3 className="text-lg font-bold text-white mb-4">📆 Bilan du mois</h3>
                                                                <div className="space-y-3">
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Chiffre d'affaires</div>
                                                                        <div className="text-2xl font-bold text-green-400">{monthlyStats.totalRevenue.toFixed(2)}€</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Coûts produits</div>
                                                                        <div className="text-lg text-yellow-400">{monthlyStats.totalCost.toFixed(2)}€</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Dépenses</div>
                                                                        <div className="text-lg text-red-400">{monthlyStats.totalExpenses.toFixed(2)}€</div>
                                                                    </div>
                                                                    <div className="border-t border-purple-700 pt-3">
                                                                        <div className="text-xs text-gray-300">Bénéfice net</div>
                                                                        <div className={`text-2xl font-bold ${monthlyStats.netProfit >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                                            {monthlyStats.netProfit.toFixed(2)}€
                                                                        </div>
                                                                        <div className="text-xs text-gray-400 mt-1">Marge: {monthlyStats.profitMargin}%</div>
                                                                    </div>
                                                                    <div className="text-xs text-gray-400 mt-2">{monthlyStats.totalTransactions} transactions</div>
                                                                </div>
                                                            </div>

                                                            {/* Bilan de l'année */}
                                                            <div className="bg-gradient-to-br from-orange-900 to-orange-800 rounded-lg border border-orange-600 p-6">
                                                                <h3 className="text-lg font-bold text-white mb-4">📊 Bilan de l'année</h3>
                                                                <div className="space-y-3">
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Chiffre d'affaires</div>
                                                                        <div className="text-2xl font-bold text-green-400">{yearlyStats.totalRevenue.toFixed(2)}€</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Coûts produits</div>
                                                                        <div className="text-lg text-yellow-400">{yearlyStats.totalCost.toFixed(2)}€</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Dépenses</div>
                                                                        <div className="text-lg text-red-400">{yearlyStats.totalExpenses.toFixed(2)}€</div>
                                                                    </div>
                                                                    <div className="border-t border-orange-700 pt-3">
                                                                        <div className="text-xs text-gray-300">Bénéfice net</div>
                                                                        <div className={`text-2xl font-bold ${yearlyStats.netProfit >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                                            {yearlyStats.netProfit.toFixed(2)}€
                                                                        </div>
                                                                        <div className="text-xs text-gray-400 mt-1">Marge: {yearlyStats.profitMargin}%</div>
                                                                    </div>
                                                                    <div className="text-xs text-gray-400 mt-2">{yearlyStats.totalTransactions} transactions</div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Gestion des dépenses */}
                                                        <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                            <h3 className="text-xl font-bold text-white mb-4">📋 Enregistrer une dépense</h3>
                                                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                                                <select 
                                                                    id="expenseCategory"
                                                                    defaultValue="autre"
                                                                    className="px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500"
                                                                >
                                                                    <option value="salaires">👥 Salaires & Charges</option>
                                                                    <option value="loyer">🏠 Loyer</option>
                                                                    <option value="fournitures">📦 Fournitures</option>
                                                                    <option value="maintenance">🔧 Maintenance & Réparations</option>
                                                                    <option value="transport">🚚 Transport & Logistique</option>
                                                                    <option value="utilities">💡 Électricité & Eau</option>
                                                                    <option value="assurance">🛡️ Assurance</option>
                                                                    <option value="marketing">📢 Marketing & Publicité</option>
                                                                    <option value="autre">📌 Autre</option>
                                                                </select>
                                                                <input 
                                                                    type="number"
                                                                    id="expenseAmount"
                                                                    placeholder="Montant (€)"
                                                                    step="0.01"
                                                                    min="0"
                                                                    className="px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500"
                                                                />
                                                                <input 
                                                                    type="text"
                                                                    id="expenseDescription"
                                                                    placeholder="Description (optionnel)"
                                                                    className="px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500"
                                                                />
                                                                <button 
                                                                    onClick={() => {
                                                                        const category = document.getElementById('expenseCategory').value;
                                                                        const amount = parseFloat(document.getElementById('expenseAmount').value);
                                                                        const description = document.getElementById('expenseDescription').value;
                                                                        
                                                                        if (amount > 0) {
                                                                            addExpense(category, amount, description);
                                                                            document.getElementById('expenseAmount').value = '';
                                                                            document.getElementById('expenseDescription').value = '';
                                                                            alert('Dépense enregistrée !');
                                                                        }
                                                                    }}
                                                                    className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded transition"
                                                                >
                                                                    ✓ Ajouter
                                                                </button>
                                                            </div>
                                                        </div>

                                                        {/* Historique des dépenses */}
                                                        <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                            <h3 className="text-xl font-bold text-white mb-4">📜 Historique des dépenses</h3>
                                                            <div className="space-y-2 max-h-64 overflow-y-auto">
                                                                {expenses.length > 0 ? (
                                                                    [...expenses].reverse().map(expense => (
                                                                        <div key={expense.id} className="bg-gray-700 p-3 rounded border-l-4 border-red-600 flex justify-between items-center hover:bg-gray-650 transition">
                                                                            <div className="flex-1">
                                                                                <div className="font-semibold text-white">{expense.category}</div>
                                                                                <div className="text-sm text-gray-400">{expense.description || 'Aucune description'}</div>
                                                                                <div className="text-xs text-gray-500">{new Date(expense.date).toLocaleString('fr-FR')}</div>
                                                                            </div>
                                                                            <div className="text-lg font-bold text-red-400">-{expense.amount.toFixed(2)}€</div>
                                                                        </div>
                                                                    ))
                                                                ) : (
                                                                    <div className="text-center text-gray-400 py-8">Aucune dépense enregistrée</div>
                                                                )}
                                                            </div>
                                                        </div>

                                                        {/* Rapports TVA */}
                                                        <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                            <h3 className="text-xl font-bold text-white mb-4">🧾 Rapports TVA</h3>
                                                            <div className="grid grid-cols-3 gap-4">
                                                                <div>
                                                                    <div className="text-sm text-gray-400 font-semibold mb-3">Taux TVA standard: 20%</div>
                                                                    <div className="space-y-2">
                                                                        <div className="flex justify-between">
                                                                            <span className="text-gray-300">CA journalier TTC:</span>
                                                                            <span className="text-white font-bold">{dailyStats.totalRevenue.toFixed(2)}€</span>
                                                                        </div>
                                                                        <div className="flex justify-between bg-gray-700 p-2 rounded">
                                                                            <span className="text-gray-300">CA HT:</span>
                                                                            <span className="text-green-400 font-bold">{(dailyStats.totalRevenue / 1.20).toFixed(2)}€</span>
                                                                        </div>
                                                                        <div className="flex justify-between bg-blue-900/30 p-2 rounded border border-blue-700">
                                                                            <span className="text-gray-300">TVA due:</span>
                                                                            <span className="text-blue-400 font-bold">{(dailyStats.totalRevenue - dailyStats.totalRevenue / 1.20).toFixed(2)}€</span>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div>
                                                                    <div className="text-sm text-gray-400 font-semibold mb-3">Mensuel</div>
                                                                    <div className="space-y-2">
                                                                        <div className="flex justify-between">
                                                                            <span className="text-gray-300">CA mensuel TTC:</span>
                                                                            <span className="text-white font-bold">{monthlyStats.totalRevenue.toFixed(2)}€</span>
                                                                        </div>
                                                                        <div className="flex justify-between bg-gray-700 p-2 rounded">
                                                                            <span className="text-gray-300">CA HT:</span>
                                                                            <span className="text-green-400 font-bold">{(monthlyStats.totalRevenue / 1.20).toFixed(2)}€</span>
                                                                        </div>
                                                                        <div className="flex justify-between bg-blue-900/30 p-2 rounded border border-blue-700">
                                                                            <span className="text-gray-300">TVA due:</span>
                                                                            <span className="text-blue-400 font-bold">{(monthlyStats.totalRevenue - monthlyStats.totalRevenue / 1.20).toFixed(2)}€</span>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div>
                                                                    <div className="text-sm text-gray-400 font-semibold mb-3">Annuel</div>
                                                                    <div className="space-y-2">
                                                                        <div className="flex justify-between">
                                                                            <span className="text-gray-300">CA annuel TTC:</span>
                                                                            <span className="text-white font-bold">{yearlyStats.totalRevenue.toFixed(2)}€</span>
                                                                        </div>
                                                                        <div className="flex justify-between bg-gray-700 p-2 rounded">
                                                                            <span className="text-gray-300">CA HT:</span>
                                                                            <span className="text-green-400 font-bold">{(yearlyStats.totalRevenue / 1.20).toFixed(2)}€</span>
                                                                        </div>
                                                                        <div className="flex justify-between bg-blue-900/30 p-2 rounded border border-blue-700">
                                                                            <span className="text-gray-300">TVA due:</span>
                                                                            <span className="text-blue-400 font-bold">{(yearlyStats.totalRevenue - yearlyStats.totalRevenue / 1.20).toFixed(2)}€</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </>
                                                );
                                            })()}
                                        </div>
                                    )}

                                    {/* --- ONGLET CRM CLIENTS --- */}
                                    {backOfficeTab === 'clients' && (
                                        <div className="space-y-6">
                                            <div className="flex justify-between items-center">
                                                <h2 className="text-2xl font-bold text-white">👥 Gestion CRM Clients</h2>
                                                <label className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded transition cursor-pointer flex items-center gap-2">
                                                    📥 Importer Excel
                                                    <input 
                                                        type="file" 
                                                        accept=".xlsx,.xls,.csv" 
                                                        onChange={handleClientsImport}
                                                        className="hidden"
                                                    />
                                                </label>
                                            </div>

                                            {/* Vue d'ensemble clients par segment */}
                                            <div className="grid grid-cols-5 gap-4">
                                                {(() => {
                                                    const segments = {
                                                        'VIP': { icon: '👑', color: 'from-yellow-900 to-yellow-800', border: 'border-yellow-600', count: 0 },
                                                        'Premium': { icon: '💎', color: 'from-purple-900 to-purple-800', border: 'border-purple-600', count: 0 },
                                                        'Fidèle': { icon: '⭐', color: 'from-blue-900 to-blue-800', border: 'border-blue-600', count: 0 },
                                                        'Régulier': { icon: '✓', color: 'from-green-900 to-green-800', border: 'border-green-600', count: 0 },
                                                        'Nouveau': { icon: '🆕', color: 'from-gray-700 to-gray-800', border: 'border-gray-600', count: 0 }
                                                    };

                                                    clients.forEach(client => {
                                                        const segment = getClientSegment(client.num);
                                                        segments[segment.name].count++;
                                                    });

                                                    return Object.entries(segments).map(([name, data]) => (
                                                        <div key={name} className={`bg-gradient-to-br ${data.color} rounded-lg border ${data.border} p-4`}>
                                                            <div className="text-2xl mb-2">{data.icon}</div>
                                                            <div className="text-sm text-gray-300">{name}</div>
                                                            <div className="text-3xl font-bold text-white mt-2">{data.count}</div>
                                                        </div>
                                                    ));
                                                })()}
                                            </div>

                                            {/* Liste détaillée des clients */}
                                            <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                <h3 className="text-xl font-bold text-white mb-4">📋 Détail des clients</h3>
                                                <div className="space-y-3">
                                                    {clients.map(client => {
                                                        const segment = getClientSegment(client.num);
                                                        const loyaltyPoints = calculateLoyaltyPoints(client.num);
                                                        const purchaseHistory = getClientPurchaseHistory(client.num);
                                                        const totalSpent = purchaseHistory.reduce((sum, t) => sum + (t.total || 0), 0);

                                                        return (
                                                            <details key={client.num} className="bg-gray-700 rounded-lg border border-gray-600 hover:border-blue-500 transition cursor-pointer group">
                                                                <summary className="p-4 font-semibold text-white flex justify-between items-center">
                                                                    <div className="flex items-center gap-4 flex-1">
                                                                        <div className="text-2xl">{segment.icon}</div>
                                                                        <div>
                                                                            <div className="font-bold text-lg">{client.name}</div>
                                                                            <div className="text-sm text-gray-400">{client.num} • 📧 {client.email}</div>
                                                                        </div>
                                                                    </div>
                                                                    <div className="flex items-center gap-6 mr-4">
                                                                        <div className="text-right">
                                                                            <div className="text-xs text-gray-400">Segment</div>
                                                                            <div className="font-bold text-amber-400">{segment.name}</div>
                                                                        </div>
                                                                        <div className="text-right">
                                                                            <div className="text-xs text-gray-400">Points fidélité</div>
                                                                            <div className="font-bold text-green-400">{loyaltyPoints} pts</div>
                                                                        </div>
                                                                    </div>
                                                                </summary>
                                                                <div className="px-4 pb-4 border-t border-gray-600 pt-4 space-y-4">
                                                                    {/* Info client */}
                                                                    <div className="grid grid-cols-3 gap-4">
                                                                        <div>
                                                                            <div className="text-xs text-gray-400 font-semibold">📞 Téléphone</div>
                                                                            <div className="text-white mt-1">{client.phone || 'Non renseigné'}</div>
                                                                        </div>
                                                                        <div>
                                                                            <div className="text-xs text-gray-400 font-semibold">🏠 Adresse</div>
                                                                            <div className="text-white mt-1">{client.address || 'Non renseignée'}</div>
                                                                        </div>
                                                                        <div>
                                                                            <div className="text-xs text-gray-400 font-semibold">📅 Depuis</div>
                                                                            <div className="text-white mt-1">{client.joinDate || 'Non renseigné'}</div>
                                                                        </div>
                                                                    </div>

                                                                    {/* Statistiques */}
                                                                    <div className="bg-gray-800 rounded-lg p-4 border border-gray-600">
                                                                        <div className="text-sm font-semibold text-gray-300 mb-3">📊 Statistiques d'achat</div>
                                                                        <div className="grid grid-cols-4 gap-4">
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Total dépensé</div>
                                                                                <div className="text-xl font-bold text-green-400">{totalSpent.toFixed(2)}€</div>
                                                                            </div>
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Nb transactions</div>
                                                                                <div className="text-xl font-bold text-blue-400">{purchaseHistory.length}</div>
                                                                            </div>
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Ticket moyen</div>
                                                                                <div className="text-xl font-bold text-purple-400">
                                                                                    {purchaseHistory.length > 0 
                                                                                        ? (totalSpent / purchaseHistory.length).toFixed(2)
                                                                                        : 0}€
                                                                                </div>
                                                                            </div>
                                                                            <div>
                                                                                <div className="text-xs text-gray-400">Fidélité</div>
                                                                                <div className="text-xl font-bold text-amber-400">{loyaltyPoints} pts</div>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    {/* Historique d'achats */}
                                                                    <div>
                                                                        <div className="text-sm font-semibold text-gray-300 mb-3">📜 Historique d'achats</div>
                                                                        <div className="space-y-2 max-h-48 overflow-y-auto">
                                                                            {purchaseHistory.length > 0 ? (
                                                                                purchaseHistory.map((transaction, idx) => (
                                                                                    <div key={idx} className="bg-gray-800 p-3 rounded border-l-4 border-blue-600 flex justify-between items-center text-sm">
                                                                                        <div>
                                                                                            <div className="text-gray-300">
                                                                                                {transaction.items?.length || 0} article(s) • 
                                                                                                <span className="text-gray-500 ml-2">{new Date(transaction.date).toLocaleString('fr-FR')}</span>
                                                                                            </div>
                                                                                            <div className="text-xs text-gray-500 mt-1">
                                                                                                {transaction.items?.map(i => i.name || i.article).join(', ')}
                                                                                            </div>
                                                                                        </div>
                                                                                        <div className="text-right">
                                                                                            <div className="font-bold text-green-400">{(transaction.total || 0).toFixed(2)}€</div>
                                                                                            <div className="text-xs text-gray-500">{transaction.paymentMethod}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                ))
                                                                            ) : (
                                                                                <div className="text-center text-gray-400 py-4">Aucune transaction</div>
                                                                            )}
                                                                        </div>
                                                                    </div>

                                                                    {/* Actions */}
                                                                    <div className="flex gap-2 pt-4 border-t border-gray-600">
                                                                        <button 
                                                                            onClick={() => {
                                                                                const points = prompt(`Ajouter des points de fidélité (actuel: ${loyaltyPoints}):`);
                                                                                if (points && !isNaN(points)) {
                                                                                    addLoyaltyPoints(client.num, parseInt(points));
                                                                                }
                                                                            }}
                                                                            className="px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded transition"
                                                                        >
                                                                            ➕ Points
                                                                        </button>
                                                                        <button 
                                                                            onClick={() => {
                                                                                const newEmail = prompt('Nouvelle adresse email:', client.email);
                                                                                if (newEmail) {
                                                                                    setClients(prev => prev.map(c => 
                                                                                        c.num === client.num ? { ...c, email: newEmail } : c
                                                                                    ));
                                                                                }
                                                                            }}
                                                                            className="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded transition"
                                                                        >
                                                                            ✏️ Modifier
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </details>
                                                        );
                                                    })}
                                                </div>
                                            </div>

                                            {/* Vue Segmentation */}
                                            <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                <h3 className="text-xl font-bold text-white mb-4">🎯 Analyse de Segmentation</h3>
                                                <div className="space-y-4">
                                                    {(() => {
                                                        const segmentDetails = {
                                                            'VIP': { clients: [], description: 'Top clients (CA ≥ 5000€ ou ≥ 50 transactions)' },
                                                            'Premium': { clients: [], description: 'Gros clients (CA ≥ 2000€ ou ≥ 20 transactions)' },
                                                            'Fidèle': { clients: [], description: 'Clients réguliers (CA ≥ 500€ ou ≥ 5 transactions)' },
                                                            'Régulier': { clients: [], description: 'Clients avec achat (CA > 0)' },
                                                            'Nouveau': { clients: [], description: 'Pas encore acheté' }
                                                        };

                                                        clients.forEach(client => {
                                                            const segment = getClientSegment(client.num);
                                                            segmentDetails[segment.name].clients.push(client);
                                                        });

                                                        return Object.entries(segmentDetails).map(([name, data]) => {
                                                            const avgValue = data.clients.length > 0
                                                                ? data.clients.reduce((sum, c) => {
                                                                    const transactions = getClientPurchaseHistory(c.num);
                                                                    return sum + transactions.reduce((s, t) => s + (t.total || 0), 0);
                                                                }, 0) / data.clients.length
                                                                : 0;

                                                            return (
                                                                <div key={name} className="bg-gray-700 p-4 rounded-lg border border-gray-600">
                                                                    <div className="flex justify-between items-start mb-2">
                                                                        <div>
                                                                            <div className="font-bold text-white text-lg">{name}</div>
                                                                            <div className="text-sm text-gray-400">{data.description}</div>
                                                                        </div>
                                                                        <div className="text-right">
                                                                            <div className="text-2xl font-bold text-blue-400">{data.clients.length}</div>
                                                                            <div className="text-xs text-gray-400">clients</div>
                                                                        </div>
                                                                    </div>
                                                                    <div className="flex items-center justify-between pt-2 border-t border-gray-600">
                                                                        <span className="text-sm text-gray-400">Valeur moyenne par client</span>
                                                                        <span className="text-lg font-bold text-green-400">{avgValue.toFixed(2)}€</span>
                                                                    </div>
                                                                </div>
                                                            );
                                                        });
                                                    })()}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* --- ONGLET MENTIONS LÉGALES --- */}
                                    {backOfficeTab === 'mentions' && (
                                        <div className="space-y-6">
                                            <h3 className="text-2xl font-bold text-white mb-6">⚖️ Mentions Légales & Informations Magasin</h3>
                                            
                                            {/* Avertissement */}
                                            <div className="bg-yellow-900/30 border border-yellow-700 rounded-lg p-4 mb-6">
                                                <div className="text-yellow-400 font-semibold text-lg">⚠️ Données à Configurer</div>
                                                <div className="text-yellow-300 text-sm mt-2">Remplissez tous les champs pour la conformité légale française</div>
                                            </div>

                                            {/* Identité du Magasin */}
                                            <div className="bg-gray-700 p-6 rounded-lg border border-gray-600">
                                                <h4 className="text-white font-bold text-lg mb-4">🏪 Identité du Magasin</h4>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="text-gray-300 text-sm block mb-2">Nom du Magasin</label>
                                                        <input type="text" placeholder="[À REMPLIR]" className="w-full bg-gray-600 text-white p-2 rounded border border-gray-500 text-sm" />
                                                    </div>
                                                    <div>
                                                        <label className="text-gray-300 text-sm block mb-2">SIRET</label>
                                                        <input type="text" placeholder="[À REMPLIR]" className="w-full bg-gray-600 text-white p-2 rounded border border-gray-500 text-sm" />
                                                    </div>
                                                    <div>
                                                        <label className="text-gray-300 text-sm block mb-2">SIREN</label>
                                                        <input type="text" placeholder="[À REMPLIR]" className="w-full bg-gray-600 text-white p-2 rounded border border-gray-500 text-sm" />
                                                    </div>
                                                    <div>
                                                        <label className="text-gray-300 text-sm block mb-2">Numéro TVA</label>
                                                        <input type="text" placeholder="[À REMPLIR]" className="w-full bg-gray-600 text-white p-2 rounded border border-gray-500 text-sm" />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Contact et Localisation */}
                                            <div className="bg-gray-700 p-6 rounded-lg border border-gray-600">
                                                <h4 className="text-white font-bold text-lg mb-4">📍 Contact & Localisation</h4>
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="text-gray-300 text-sm block mb-2">Adresse</label>
                                                        <input type="text" placeholder="[À REMPLIR]" className="w-full bg-gray-600 text-white p-2 rounded border border-gray-500 text-sm" />
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div>
                                                            <label className="text-gray-300 text-sm block mb-2">Téléphone</label>
                                                            <input type="tel" placeholder="[À REMPLIR]" className="w-full bg-gray-600 text-white p-2 rounded border border-gray-500 text-sm" />
                                                        </div>
                                                        <div>
                                                            <label className="text-gray-300 text-sm block mb-2">Email</label>
                                                            <input type="email" placeholder="[À REMPLIR]" className="w-full bg-gray-600 text-white p-2 rounded border border-gray-500 text-sm" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Conditions Commerciales */}
                                            <div className="bg-gray-700 p-6 rounded-lg border border-gray-600">
                                                <h4 className="text-white font-bold text-lg mb-4">💳 Conditions Commerciales</h4>
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="text-gray-300 text-sm block mb-2">Moyens de paiement acceptés</label>
                                                        <textarea placeholder="Espèces, Carte bancaire, Chèque..." className="w-full bg-gray-600 text-white p-2 rounded border border-gray-500 text-sm h-20"></textarea>
                                                    </div>
                                                    <div>
                                                        <label className="text-gray-300 text-sm block mb-2">Politique de retour et garantie</label>
                                                        <textarea placeholder="[À REMPLIR]" className="w-full bg-gray-600 text-white p-2 rounded border border-gray-500 text-sm h-20"></textarea>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Protection des Données */}
                                            <div className="bg-gray-700 p-6 rounded-lg border border-gray-600">
                                                <h4 className="text-white font-bold text-lg mb-4">🔒 Protection des Données (RGPD)</h4>
                                                <div>
                                                    <label className="text-gray-300 text-sm block mb-2">Responsable de traitement</label>
                                                    <textarea placeholder="Nom et contact du responsable RGPD" className="w-full bg-gray-600 text-white p-2 rounded border border-gray-500 text-sm h-16"></textarea>
                                                </div>
                                            </div>

                                            {/* Bouton de sauvegarde */}
                                            <div className="flex gap-2">
                                                <button className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition">💾 Sauvegarder</button>
                                                <button className="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition">📥 Télécharger PDF</button>
                                            </div>
                                        </div>
                                    )}

                                    {/* --- ONGLET GESTION DES SOCIÉTÉS (Super Admin uniquement) --- */}
                                    {currentUser?.role === 'superadmin' && backOfficeTab === 'companies' && (
                                        <div className="space-y-6">
                                            <div className="flex items-center justify-between">
                                                <h3 className="text-2xl font-bold text-white">🏢 Gestion des Sociétés Clientes</h3>
                                                <button 
                                                    onClick={() => {
                                                        const name = prompt('Nom de la nouvelle société:');
                                                        if (!name) return;
                                                        const siret = prompt('SIRET:');
                                                        const address = prompt('Adresse:');
                                                        const email = prompt('Email:');
                                                        const phone = prompt('Téléphone:');
                                                        const plan = prompt('Plan d\'abonnement (standard/pro/premium):') || 'standard';
                                                        
                                                        const newCompany = {
                                                            id: `COMPANY${String(companies.length + 1).padStart(3, '0')}`,
                                                            name: name.trim(),
                                                            siret: (siret || '').trim(),
                                                            address: (address || '').trim(),
                                                            email: (email || '').trim(),
                                                            phone: (phone || '').trim(),
                                                            createdDate: new Date().toISOString().split('T')[0],
                                                            status: 'active',
                                                            subscriptionPlan: plan.toLowerCase()
                                                        };
                                                        setCompanies([...companies, newCompany]);
                                                        alert(`✅ Société "${name}" créée avec succès !\nID: ${newCompany.id}`);
                                                    }}
                                                    className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded transition flex items-center gap-2"
                                                >
                                                    ➕ Nouvelle Société
                                                </button>
                                            </div>

                                            <div className="grid grid-cols-1 gap-6">
                                                {companies.map(company => (
                                                    <div key={company.id} className="bg-gray-800 p-6 rounded-lg border-2 border-blue-600">
                                                        <div className="flex justify-between items-start mb-4">
                                                            <div>
                                                                <div className="flex items-center gap-3 mb-2">
                                                                    <span className="text-4xl">🏢</span>
                                                                    <div>
                                                                        <div className="text-2xl font-bold text-white">{company.name}</div>
                                                                        <div className="text-sm text-gray-400 font-mono">{company.id}</div>
                                                                    </div>
                                                                </div>
                                                                <div className="space-y-2 text-sm text-gray-300 ml-14">
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="text-blue-400">🏛️</span>
                                                                        <span>SIRET: {company.siret}</span>
                                                                    </div>
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="text-blue-400">📍</span>
                                                                        <span>{company.address}</span>
                                                                    </div>
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="text-green-400">📧</span>
                                                                        <span>{company.email}</span>
                                                                    </div>
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="text-green-400">📞</span>
                                                                        <span>{company.phone}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <div className="text-right space-y-2">
                                                                <div className={`text-xs px-3 py-1 rounded font-semibold ${company.status === 'active' ? 'bg-green-900/50 text-green-400' : 'bg-red-900/50 text-red-400'}`}>
                                                                    {company.status === 'active' ? '✅ Active' : '❌ Inactive'}
                                                                </div>
                                                                <div className="bg-blue-900/50 px-3 py-1 rounded text-xs text-blue-400 font-semibold">
                                                                    📦 {company.subscriptionPlan}
                                                                </div>
                                                                <div className="text-xs text-gray-500">
                                                                    Créée: {company.createdDate}
                                                                </div>
                                                                <button 
                                                                    onClick={() => {
                                                                        if (confirm(`Suspendre/Réactiver la société "${company.name}" ?`)) {
                                                                            const updated = companies.map(c => 
                                                                                c.id === company.id 
                                                                                    ? {...c, status: c.status === 'active' ? 'inactive' : 'active'}
                                                                                    : c
                                                                            );
                                                                            setCompanies(updated);
                                                                        }
                                                                    }}
                                                                    className="px-3 py-1 bg-yellow-600 hover:bg-yellow-700 text-white text-xs rounded transition"
                                                                >
                                                                    {company.status === 'active' ? '🔒 Suspendre' : '🔓 Réactiver'}
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Statistiques de la société */}
                                                        <div className="grid grid-cols-4 gap-4 mt-6 mb-4">
                                                            <div className="bg-purple-900/30 p-4 rounded-lg border border-purple-600">
                                                                <div className="text-xs text-purple-300">Utilisateurs</div>
                                                                <div className="text-3xl font-bold text-purple-400">
                                                                    {users.filter(u => u.companyId === company.id).length}
                                                                </div>
                                                            </div>
                                                            <div className="bg-blue-900/30 p-4 rounded-lg border border-blue-600">
                                                                <div className="text-xs text-blue-300">Entités</div>
                                                                <div className="text-3xl font-bold text-blue-400">
                                                                    {entities.filter(e => e.companyId === company.id).length}
                                                                </div>
                                                            </div>
                                                            <div className="bg-green-900/30 p-4 rounded-lg border border-green-600">
                                                                <div className="text-xs text-green-300">Magasins</div>
                                                                <div className="text-3xl font-bold text-green-400">
                                                                    {stores.filter(s => entities.find(e => e.companyId === company.id && e.id === s.entityId)).length}
                                                                </div>
                                                            </div>
                                                            <div className="bg-yellow-900/30 p-4 rounded-lg border border-yellow-600">
                                                                <div className="text-xs text-yellow-300">CA Total</div>
                                                                <div className="text-2xl font-bold text-yellow-400">
                                                                    {formatPrice(transactions.filter(t => entities.find(e => e.companyId === company.id && e.id === t.entityId?.split('_')[0])).reduce((sum, t) => sum + t.total, 0) || 0)}
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Actions */}
                                                        <div className="flex gap-2 mt-4">
                                                            <button 
                                                                onClick={() => setExpandedCompanyId(expandedCompanyId === company.id ? null : company.id)}
                                                                className="flex-1 px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded transition"
                                                            >
                                                                {expandedCompanyId === company.id ? '📋 Masquer gestion' : '⚙️ Gérer société'}
                                                            </button>
                                                            <button 
                                                                onClick={() => {
                                                                    if (confirm(`Supprimer la société "${company.name}" et toutes ses données ? Cette action est irréversible !`)) {
                                                                        setCompanies(companies.filter(c => c.id !== company.id));
                                                                        setUsers(users.filter(u => u.companyId !== company.id));
                                                                        alert('✅ Société supprimée');
                                                                    }
                                                                }}
                                                                className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition"
                                                            >
                                                                🗑️ Supprimer
                                                            </button>
                                                        </div>

                                                        {/* Section Gestion de la Société */}
                                                        {expandedCompanyId === company.id && (
                                                            <div className="mt-6 p-6 bg-gray-900 rounded-lg border border-gray-700">
                                                                <h4 className="text-xl font-bold text-white mb-4">⚙️ Gestion de {company.name}</h4>
                                                                
                                                                {/* Onglets de gestion */}
                                                                <div className="flex gap-2 mb-4 border-b border-gray-700 pb-4">
                                                                    <button 
                                                                        onClick={() => setCompanyManagementTab('users')}
                                                                        className={`px-4 py-2 rounded font-semibold transition ${
                                                                            companyManagementTab === 'users' 
                                                                                ? 'bg-blue-600 text-white' 
                                                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                                                        }`}
                                                                    >
                                                                        👥 Utilisateurs
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => setCompanyManagementTab('entities')}
                                                                        className={`px-4 py-2 rounded font-semibold transition ${
                                                                            companyManagementTab === 'entities' 
                                                                                ? 'bg-purple-600 text-white' 
                                                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                                                        }`}
                                                                    >
                                                                        🏢 Entités
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => setCompanyManagementTab('stores')}
                                                                        className={`px-4 py-2 rounded font-semibold transition ${
                                                                            companyManagementTab === 'stores' 
                                                                                ? 'bg-green-600 text-white' 
                                                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                                                        }`}
                                                                    >
                                                                        🏪 Magasins
                                                                    </button>
                                                                </div>
                                                                
                                                                {/* ONGLET UTILISATEURS */}
                                                                {companyManagementTab === 'users' && (
                                                                <div>
                                                                {/* Formulaire création utilisateur */}
                                                                <div className="bg-gray-800 p-4 rounded-lg mb-4 border border-gray-700">
                                                                    <h5 className="text-lg font-semibold text-white mb-4">➕ Créer un nouvel utilisateur</h5>
                                                                    <div className="grid grid-cols-2 gap-4">
                                                                        <input 
                                                                            type="text"
                                                                            placeholder="Nom d'utilisateur"
                                                                            id={`username-${company.id}`}
                                                                            className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500"
                                                                        />
                                                                        <input 
                                                                            type="password"
                                                                            placeholder="Mot de passe"
                                                                            id={`password-${company.id}`}
                                                                            className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500"
                                                                        />
                                                                        <input 
                                                                            type="text"
                                                                            placeholder="Nom complet"
                                                                            id={`fullname-${company.id}`}
                                                                            className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500"
                                                                        />
                                                                        <input 
                                                                            type="email"
                                                                            placeholder="Email"
                                                                            id={`email-${company.id}`}
                                                                            className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500"
                                                                        />
                                                                        <select 
                                                                            id={`role-${company.id}`}
                                                                            className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500"
                                                                        >
                                                                            <option value="admin">Admin</option>
                                                                            <option value="employee">Employé</option>
                                                                        </select>
                                                                        <select 
                                                                            id={`entity-${company.id}`}
                                                                            className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500"
                                                                        >
                                                                            <option value="">-- Sélectionner une entité --</option>
                                                                            {entities.filter(e => e.companyId === company.id).map(e => (
                                                                                <option key={e.id} value={e.id}>{e.name}</option>
                                                                            ))}
                                                                        </select>
                                                                        <select 
                                                                            id={`store-${company.id}`}
                                                                            className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500 col-span-2"
                                                                        >
                                                                            <option value="">-- Sélectionner un magasin --</option>
                                                                            {(() => {
                                                                                const companyEntities = entities.filter(e => e.companyId === company.id);
                                                                                return stores.filter(s => companyEntities.some(e => e.id === s.entityId)).map(s => (
                                                                                    <option key={s.id} value={s.id}>{s.name}</option>
                                                                                ));
                                                                            })()}
                                                                        </select>
                                                                    </div>
                                                                    <button 
                                                                        onClick={() => {
                                                                            const username = document.getElementById(`username-${company.id}`).value.trim();
                                                                            const password = document.getElementById(`password-${company.id}`).value.trim();
                                                                            const fullName = document.getElementById(`fullname-${company.id}`).value.trim();
                                                                            const email = document.getElementById(`email-${company.id}`).value.trim();
                                                                            const role = document.getElementById(`role-${company.id}`).value;
                                                                            const entityId = document.getElementById(`entity-${company.id}`).value;
                                                                            const storeId = document.getElementById(`store-${company.id}`).value;

                                                                            if (!username || !password || !fullName || !email) {
                                                                                alert('❌ Veuillez remplir tous les champs obligatoires');
                                                                                return;
                                                                            }

                                                                            if (users.some(u => u.username === username)) {
                                                                                alert('❌ Ce nom d\'utilisateur existe déjà');
                                                                                return;
                                                                            }

                                                                            if (!entityId || !storeId) {
                                                                                alert('❌ Veuillez sélectionner une entité et un magasin');
                                                                                return;
                                                                            }

                                                                            const newUser = {
                                                                                id: `U${String(Math.max(...users.map(u => parseInt(u.id.slice(1)) || 0), 0) + 1).padStart(3, '0')}`,
                                                                                username: username,
                                                                                password: password,
                                                                                fullName: fullName,
                                                                                role: role,
                                                                                email: email,
                                                                                storeId: storeId,
                                                                                entityId: entityId,
                                                                                companyId: company.id
                                                                            };

                                                                            setUsers([...users, newUser]);
                                                                            
                                                                            // Réinitialiser les champs
                                                                            document.getElementById(`username-${company.id}`).value = '';
                                                                            document.getElementById(`password-${company.id}`).value = '';
                                                                            document.getElementById(`fullname-${company.id}`).value = '';
                                                                            document.getElementById(`email-${company.id}`).value = '';
                                                                            document.getElementById(`role-${company.id}`).value = 'admin';
                                                                            document.getElementById(`entity-${company.id}`).value = '';
                                                                            document.getElementById(`store-${company.id}`).value = '';

                                                                            alert(`✅ Utilisateur "${fullName}" créé avec succès !\nIdentifiants:\n👤 ${username}\n🔑 ${password}`);
                                                                        }}
                                                                        className="w-full mt-4 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded transition"
                                                                    >
                                                                        ✓ Créer utilisateur
                                                                    </button>
                                                                </div>

                                                                {/* Liste des utilisateurs */}
                                                                <div className="space-y-2">
                                                                    <h5 className="text-lg font-semibold text-white mb-3">Liste des utilisateurs ({users.filter(u => u.companyId === company.id).length})</h5>
                                                                    {users.filter(u => u.companyId === company.id).length === 0 ? (
                                                                        <div className="p-4 bg-gray-800 rounded border border-gray-700 text-gray-400 text-center">
                                                                            Aucun utilisateur pour cette société
                                                                        </div>
                                                                    ) : (
                                                                        users.filter(u => u.companyId === company.id).map(user => {
                                                                            const userEntity = entities.find(e => e.id === user.entityId);
                                                                            const userStore = stores.find(s => s.id === user.storeId);
                                                                            return (
                                                                                <div key={user.id} className="p-3 bg-gray-800 rounded border border-gray-700 flex justify-between items-start">
                                                                                    <div className="flex-1">
                                                                                        <div className="font-semibold text-white">{user.fullName}</div>
                                                                                        <div className="text-sm text-gray-400 mt-1">👤 {user.username} | 🔑 {user.password}</div>
                                                                                        <div className="text-sm text-gray-400">📧 {user.email}</div>
                                                                                        <div className="text-xs text-blue-400 mt-1">
                                                                                            Role: <span className={user.role === 'admin' ? 'text-purple-400' : 'text-yellow-400'}>{user.role === 'admin' ? 'Admin' : 'Employé'}</span>
                                                                                        </div>
                                                                                        {userEntity && <div className="text-xs text-purple-400">🏢 {userEntity.name}</div>}
                                                                                        {userStore && <div className="text-xs text-blue-400">🏪 {userStore.name}</div>}
                                                                                    </div>
                                                                                    <button 
                                                                                        onClick={() => {
                                                                                            if (confirm(`Supprimer l'utilisateur "${user.fullName}" ?`)) {
                                                                                                setUsers(users.filter(u => u.id !== user.id));
                                                                                                alert('✅ Utilisateur supprimé');
                                                                                            }
                                                                                        }}
                                                                                        className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition"
                                                                                    >
                                                                                        🗑️ Supprimer
                                                                                    </button>
                                                                                </div>
                                                                            );
                                                                        })
                                                                                    )}
                                                                </div>
                                                                </div>
                                                                )}

                                                                {/* ONGLET ENTITÉS */}
                                                                {companyManagementTab === 'entities' && (
                                                                <div>
                                                                    <div className="bg-gray-800 p-4 rounded-lg mb-4 border border-gray-700">
                                                                        <h5 className="text-lg font-semibold text-white mb-4">➕ Créer une nouvelle entité</h5>
                                                                        <div className="grid grid-cols-2 gap-4">
                                                                            <input 
                                                                                type="text"
                                                                                placeholder="Nom de l'entité"
                                                                                id={`entity-name-${company.id}`}
                                                                                className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500"
                                                                            />
                                                                            <input 
                                                                                type="text"
                                                                                placeholder="SIRET"
                                                                                id={`entity-siret-${company.id}`}
                                                                                className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500"
                                                                            />
                                                                            <input 
                                                                                type="text"
                                                                                placeholder="Adresse"
                                                                                id={`entity-address-${company.id}`}
                                                                                className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500 col-span-2"
                                                                            />
                                                                            <input 
                                                                                type="email"
                                                                                placeholder="Email"
                                                                                id={`entity-email-${company.id}`}
                                                                                className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500"
                                                                            />
                                                                            <input 
                                                                                type="text"
                                                                                placeholder="Téléphone"
                                                                                id={`entity-phone-${company.id}`}
                                                                                className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500"
                                                                            />
                                                                        </div>
                                                                        <button 
                                                                            onClick={() => {
                                                                                const name = document.getElementById(`entity-name-${company.id}`).value.trim();
                                                                                const siret = document.getElementById(`entity-siret-${company.id}`).value.trim();
                                                                                const address = document.getElementById(`entity-address-${company.id}`).value.trim();
                                                                                const email = document.getElementById(`entity-email-${company.id}`).value.trim();
                                                                                const phone = document.getElementById(`entity-phone-${company.id}`).value.trim();

                                                                                if (!name) {
                                                                                    alert('❌ Le nom de l\'entité est obligatoire');
                                                                                    return;
                                                                                }

                                                                                const newEntity = {
                                                                                    id: `ENT${String(Math.max(...entities.map(e => parseInt(e.id.slice(3)) || 0), 0) + 1).padStart(3, '0')}`,
                                                                                    name: name,
                                                                                    siret: siret,
                                                                                    address: address,
                                                                                    contactEmail: email,
                                                                                    contactPhone: phone,
                                                                                    companyId: company.id
                                                                                };

                                                                                setEntities([...entities, newEntity]);
                                                                                
                                                                                // Réinitialiser
                                                                                document.getElementById(`entity-name-${company.id}`).value = '';
                                                                                document.getElementById(`entity-siret-${company.id}`).value = '';
                                                                                document.getElementById(`entity-address-${company.id}`).value = '';
                                                                                document.getElementById(`entity-email-${company.id}`).value = '';
                                                                                document.getElementById(`entity-phone-${company.id}`).value = '';

                                                                                alert(`✅ Entité "${name}" créée avec succès !`);
                                                                            }}
                                                                            className="w-full mt-4 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded transition"
                                                                        >
                                                                            ✓ Créer entité
                                                                        </button>
                                                                    </div>

                                                                    <div className="space-y-2">
                                                                        <h5 className="text-lg font-semibold text-white mb-3">Entités de cette société ({entities.filter(e => e.companyId === company.id).length})</h5>
                                                                        {entities.filter(e => e.companyId === company.id).length === 0 ? (
                                                                            <div className="p-4 bg-gray-800 rounded border border-gray-700 text-gray-400 text-center">
                                                                                Aucune entité pour cette société
                                                                            </div>
                                                                        ) : (
                                                                            entities.filter(e => e.companyId === company.id).map(entity => (
                                                                                <div key={entity.id} className="p-3 bg-gray-800 rounded border border-gray-700">
                                                                                    <div className="flex justify-between items-start">
                                                                                        <div className="flex-1">
                                                                                            <div className="font-semibold text-white">{entity.name}</div>
                                                                                            <div className="text-sm text-gray-400 mt-1">SIRET: {entity.siret}</div>
                                                                                            <div className="text-sm text-gray-400">📍 {entity.address}</div>
                                                                                            <div className="text-sm text-gray-400">📧 {entity.contactEmail} | 📞 {entity.contactPhone}</div>
                                                                                            <div className="text-xs text-blue-400 mt-2">
                                                                                                Magasins: {stores.filter(s => s.entityId === entity.id).length}
                                                                                            </div>
                                                                                        </div>
                                                                                        <button 
                                                                                            onClick={() => {
                                                                                                if (confirm(`Supprimer l'entité "${entity.name}" et ses magasins ?`)) {
                                                                                                    setEntities(entities.filter(e => e.id !== entity.id));
                                                                                                    setStores(stores.filter(s => s.entityId !== entity.id));
                                                                                                    alert('✅ Entité supprimée');
                                                                                                }
                                                                                            }}
                                                                                            className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition"
                                                                                        >
                                                                                            🗑️
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                            ))
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                )}

                                                                {/* ONGLET MAGASINS */}
                                                                {companyManagementTab === 'stores' && (
                                                                <div>
                                                                    <div className="bg-gray-800 p-4 rounded-lg mb-4 border border-gray-700">
                                                                        <h5 className="text-lg font-semibold text-white mb-4">➕ Créer un nouveau magasin</h5>
                                                                        <div className="grid grid-cols-2 gap-4">
                                                                            <input 
                                                                                type="text"
                                                                                placeholder="Nom du magasin"
                                                                                id={`store-name-${company.id}`}
                                                                                className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500"
                                                                            />
                                                                            <input 
                                                                                type="text"
                                                                                placeholder="Adresse"
                                                                                id={`store-address-${company.id}`}
                                                                                className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500"
                                                                            />
                                                                            <input 
                                                                                type="text"
                                                                                placeholder="Téléphone"
                                                                                id={`store-phone-${company.id}`}
                                                                                className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500"
                                                                            />
                                                                            <select 
                                                                                id={`store-entity-${company.id}`}
                                                                                className="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500"
                                                                            >
                                                                                <option value="">-- Sélectionner une entité --</option>
                                                                                {entities.filter(e => e.companyId === company.id).map(e => (
                                                                                    <option key={e.id} value={e.id}>{e.name}</option>
                                                                                ))}
                                                                            </select>
                                                                        </div>
                                                                        <button 
                                                                            onClick={() => {
                                                                                const name = document.getElementById(`store-name-${company.id}`).value.trim();
                                                                                const address = document.getElementById(`store-address-${company.id}`).value.trim();
                                                                                const phone = document.getElementById(`store-phone-${company.id}`).value.trim();
                                                                                const entityId = document.getElementById(`store-entity-${company.id}`).value;

                                                                                if (!name || !entityId) {
                                                                                    alert('❌ Le nom et l\'entité sont obligatoires');
                                                                                    return;
                                                                                }

                                                                                const newStore = {
                                                                                    id: `STORE${String(Math.max(...stores.map(s => parseInt(s.id.slice(5)) || 0), 0) + 1).padStart(3, '0')}`,
                                                                                    name: name,
                                                                                    address: address,
                                                                                    phone: phone,
                                                                                    entityId: entityId
                                                                                };

                                                                                setStores([...stores, newStore]);
                                                                                
                                                                                // Réinitialiser
                                                                                document.getElementById(`store-name-${company.id}`).value = '';
                                                                                document.getElementById(`store-address-${company.id}`).value = '';
                                                                                document.getElementById(`store-phone-${company.id}`).value = '';
                                                                                document.getElementById(`store-entity-${company.id}`).value = '';

                                                                                alert(`✅ Magasin "${name}" créé avec succès !`);
                                                                            }}
                                                                            className="w-full mt-4 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded transition"
                                                                        >
                                                                            ✓ Créer magasin
                                                                        </button>
                                                                    </div>

                                                                    <div className="space-y-2">
                                                                        <h5 className="text-lg font-semibold text-white mb-3">Magasins de cette société</h5>
                                                                        {(() => {
                                                                            const companyEntities = entities.filter(e => e.companyId === company.id);
                                                                            const companyStores = stores.filter(s => companyEntities.some(e => e.id === s.entityId));
                                                                            
                                                                            if (companyStores.length === 0) {
                                                                                return <div className="p-4 bg-gray-800 rounded border border-gray-700 text-gray-400 text-center">Aucun magasin pour cette société</div>;
                                                                            }
                                                                            
                                                                            return companyStores.map(store => {
                                                                                const storeEntity = entities.find(e => e.id === store.entityId);
                                                                                return (
                                                                                    <div key={store.id} className="p-3 bg-gray-800 rounded border border-gray-700">
                                                                                        <div className="flex justify-between items-start">
                                                                                            <div className="flex-1">
                                                                                                <div className="font-semibold text-white">{store.name}</div>
                                                                                                <div className="text-sm text-gray-400 mt-1">📍 {store.address}</div>
                                                                                                <div className="text-sm text-gray-400">📞 {store.phone}</div>
                                                                                                <div className="text-xs text-purple-400 mt-1">🏢 {storeEntity?.name}</div>
                                                                                            </div>
                                                                                            <button 
                                                                                                onClick={() => {
                                                                                                    if (confirm(`Supprimer le magasin "${store.name}" ?`)) {
                                                                                                        setStores(stores.filter(s => s.id !== store.id));
                                                                                                        alert('✅ Magasin supprimé');
                                                                                                    }
                                                                                                }}
                                                                                                className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition"
                                                                                            >
                                                                                                🗑️
                                                                                            </button>
                                                                                        </div>
                                                                                    </div>
                                                                                );
                                                                            });
                                                                        })()}
                                                                    </div>
                                                                </div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* --- ONGLET UTILISATEURS ET PERMISSIONS --- */}
                                    {/* --- ONGLET ENTITÉS (Admin uniquement) --- */}
                                    {backOfficeTab === 'entities' && (
                                        <div className="space-y-6">
                                            {!isAdmin() ? (
                                                <div className="bg-red-900/30 border border-red-700 rounded-lg p-6 text-center">
                                                    <div className="text-red-400 text-lg font-bold">🔒 Accès Refusé</div>
                                                    <div className="text-red-300 text-sm mt-2">Seuls les administrateurs peuvent gérer les entités</div>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="flex items-center justify-between">
                                                        <h3 className="text-2xl font-bold text-white">🏢 Gestion des Entités / Enseignes</h3>
                                                        <button 
                                                            onClick={() => {
                                                                const name = prompt('Nom de l\'entité/enseigne:');
                                                                if (!name) return;
                                                                const siret = prompt('SIRET:');
                                                                const address = prompt('Adresse du siège:');
                                                                const contactEmail = prompt('Email de contact:');
                                                                const contactPhone = prompt('Téléphone:');
                                                                
                                                                const newEntity = {
                                                                    id: `ENT${String(entities.length + 1).padStart(3, '0')}`,
                                                                    name: name,
                                                                    siret: siret || '',
                                                                    address: address || '',
                                                                    contactEmail: contactEmail || '',
                                                                    contactPhone: contactPhone || ''
                                                                };
                                                                
                                                                setEntities([...entities, newEntity]);
                                                                saveToFirestore('entities', newEntity);
                                                                alert(`✅ Entité "${name}" créée avec succès !`);
                                                            }}
                                                            className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded transition"
                                                        >
                                                            ➕ Ajouter Entité
                                                        </button>
                                                    </div>

                                                    <div className="grid grid-cols-1 gap-6">
                                                        {entities.map(entity => {
                                                            const entityStores = stores.filter(s => s.entityId === entity.id);
                                                            const entityUsers = users.filter(u => u.entityId === entity.id);
                                                            const entityTransactions = transactions.filter(t => t.entityId === entity.id);
                                                            const entityRevenue = entityTransactions.reduce((sum, t) => sum + t.total, 0);
                                                            
                                                            return (
                                                            <div key={entity.id} className="bg-gray-800 p-6 rounded-lg border-2 border-purple-600">
                                                                <div className="flex justify-between items-start mb-4">
                                                                    <div>
                                                                        <div className="flex items-center gap-3 mb-2">
                                                                            <span className="text-4xl">🏢</span>
                                                                            <div>
                                                                                <div className="text-2xl font-bold text-white">{entity.name}</div>
                                                                                <div className="text-sm text-gray-400 font-mono">{entity.id}</div>
                                                                            </div>
                                                                        </div>
                                                                        <div className="space-y-2 text-sm text-gray-300 ml-14">
                                                                            <div className="flex items-center gap-2">
                                                                                <span className="text-blue-400">🏛️</span>
                                                                                <span>SIRET: {entity.siret}</span>
                                                                            </div>
                                                                            <div className="flex items-center gap-2">
                                                                                <span className="text-blue-400">📍</span>
                                                                                <span>{entity.address}</span>
                                                                            </div>
                                                                            <div className="flex items-center gap-2">
                                                                                <span className="text-green-400">📧</span>
                                                                                <span>{entity.contactEmail}</span>
                                                                            </div>
                                                                            <div className="flex items-center gap-2">
                                                                                <span className="text-green-400">📞</span>
                                                                                <span>{entity.contactPhone}</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    <button 
                                                                        onClick={() => {
                                                                            if (confirm(`Supprimer l'entité "${entity.name}" et tous ses magasins ?`)) {
                                                                                setEntities(entities.filter(e => e.id !== entity.id));
                                                                                setStores(stores.filter(s => s.entityId !== entity.id));
                                                                            }
                                                                        }}
                                                                        className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition"
                                                                    >
                                                                        🗑️
                                                                    </button>
                                                                </div>
                                                                
                                                                {/* Statistiques globales de l'entité */}
                                                                <div className="grid grid-cols-4 gap-4 mt-6">
                                                                    <div className="bg-purple-900/30 p-4 rounded-lg border border-purple-600">
                                                                        <div className="text-xs text-purple-300">Magasins</div>
                                                                        <div className="text-3xl font-bold text-purple-400">{entityStores.length}</div>
                                                                    </div>
                                                                    <div className="bg-blue-900/30 p-4 rounded-lg border border-blue-600">
                                                                        <div className="text-xs text-blue-300">Utilisateurs</div>
                                                                        <div className="text-3xl font-bold text-blue-400">{entityUsers.length}</div>
                                                                    </div>
                                                                    <div className="bg-green-900/30 p-4 rounded-lg border border-green-600">
                                                                        <div className="text-xs text-green-300">Transactions</div>
                                                                        <div className="text-3xl font-bold text-green-400">{entityTransactions.length}</div>
                                                                    </div>
                                                                    <div className="bg-yellow-900/30 p-4 rounded-lg border border-yellow-600">
                                                                        <div className="text-xs text-yellow-300">CA Total</div>
                                                                        <div className="text-2xl font-bold text-yellow-400">{formatPrice(entityRevenue)}</div>
                                                                    </div>
                                                                </div>

                                                                {/* Liste des magasins de cette entité */}
                                                                {entityStores.length > 0 && (
                                                                    <div className="mt-6">
                                                                        <h4 className="text-white font-bold text-lg mb-3">🏪 Magasins de cette entité:</h4>
                                                                        <div className="grid grid-cols-2 gap-3">
                                                                            {entityStores.map(store => (
                                                                                <div key={store.id} className="bg-gray-700 p-3 rounded border border-gray-600">
                                                                                    <div className="font-bold text-white">{store.name}</div>
                                                                                    <div className="text-xs text-gray-400 mt-1">{store.address}</div>
                                                                                    <div className="text-xs text-blue-400 mt-1">
                                                                                        {users.filter(u => u.storeId === store.id).length} utilisateurs
                                                                                    </div>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                            );
                                                        })}
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    )}

                                    {/* --- ONGLET MAGASINS (Admin uniquement) --- */}
                                    {backOfficeTab === 'stores' && (
                                        <div className="space-y-6">
                                            {!isAdmin() ? (
                                                <div className="bg-red-900/30 border border-red-700 rounded-lg p-6 text-center">
                                                    <div className="text-red-400 text-lg font-bold">🔒 Accès Refusé</div>
                                                    <div className="text-red-300 text-sm mt-2">Seuls les administrateurs peuvent gérer les magasins</div>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="flex items-center justify-between">
                                                        <h3 className="text-2xl font-bold text-white">🏪 Gestion des Magasins</h3>
                                                        <button 
                                                            onClick={() => {
                                                                if (entities.length === 0) {
                                                                    alert('Veuillez d\'abord créer une entité !');
                                                                    return;
                                                                }
                                                                
                                                                const name = prompt('Nom du magasin:');
                                                                if (!name) return;
                                                                const address = prompt('Adresse:');
                                                                const phone = prompt('Téléphone:');
                                                                
                                                                // Sélection de l'entité
                                                                let entityOptions = entities.map((e, i) => `${i + 1}. ${e.name} (${e.id})`).join('\n');
                                                                const entityChoice = prompt(`Choisir une entité (numéro) :\n${entityOptions}`);
                                                                if (!entityChoice || isNaN(entityChoice)) {
                                                                    alert('Choix invalide');
                                                                    return;
                                                                }
                                                                const selectedEntity = entities[parseInt(entityChoice) - 1];
                                                                if (!selectedEntity) {
                                                                    alert('Entité invalide');
                                                                    return;
                                                                }
                                                                
                                                                const newStore = {
                                                                    id: `STORE${String(stores.length + 1).padStart(3, '0')}`,
                                                                    name: name,
                                                                    address: address || '',
                                                                    phone: phone || '',
                                                                    entityId: selectedEntity.id
                                                                };
                                                                
                                                                setStores([...stores, newStore]);
                                                                saveToFirestore('stores', newStore);
                                                                alert(`✅ Magasin "${name}" créé avec succès !`);
                                                            }}
                                                            className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded transition"
                                                        >
                                                            ➕ Ajouter Magasin
                                                        </button>
                                                    </div>

                                                    <div className="grid grid-cols-1 gap-4">
                                                        {stores.map(store => {
                                                            const storeEntity = entities.find(e => e.id === store.entityId);
                                                            return (
                                                                <div key={store.id} className="bg-gray-800 p-6 rounded-lg border border-gray-700">
                                                                    <div className="flex justify-between items-start">
                                                                        <div>
                                                                            <div className="flex items-center gap-3 mb-3">
                                                                                <span className="text-3xl">🏪</span>
                                                                                <div>
                                                                                    <div className="text-xl font-bold text-white">{store.name}</div>
                                                                                    <div className="text-sm text-gray-400 font-mono">{store.id}</div>
                                                                                    {storeEntity && (
                                                                                        <div className="text-sm text-purple-400 mt-1">
                                                                                            🏢 {storeEntity.name}
                                                                                        </div>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                            <div className="space-y-2 text-sm text-gray-300">
                                                                                <div className="flex items-center gap-2">
                                                                                    <span className="text-blue-400">📍</span>
                                                                                    <span>{store.address}</span>
                                                                                </div>
                                                                                <div className="flex items-center gap-2">
                                                                                    <span className="text-green-400">📞</span>
                                                                                    <span>{store.phone}</span>
                                                                                </div>
                                                                            </div>
                                                                            
                                                                            {/* Statistiques du magasin */}
                                                                            <div className="mt-4 grid grid-cols-3 gap-4">
                                                                                <div className="bg-gray-700 p-3 rounded">
                                                                                    <div className="text-xs text-gray-400">Utilisateurs</div>
                                                                                    <div className="text-2xl font-bold text-blue-400">
                                                                                        {users.filter(u => u.storeId === store.id).length}
                                                                                    </div>
                                                                                </div>
                                                                                <div className="bg-gray-700 p-3 rounded">
                                                                                    <div className="text-xs text-gray-400">Transactions</div>
                                                                                    <div className="text-2xl font-bold text-green-400">
                                                                                        {transactions.filter(t => t.storeId === store.id).length}
                                                                                    </div>
                                                                                </div>
                                                                                <div className="bg-gray-700 p-3 rounded">
                                                                                    <div className="text-xs text-gray-400">CA Total</div>
                                                                                    <div className="text-2xl font-bold text-yellow-400">
                                                                                        {formatPrice(transactions.filter(t => t.storeId === store.id).reduce((sum, t) => sum + t.total, 0))}
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        <button 
                                                                            onClick={() => {
                                                                                if (confirm(`Supprimer le magasin "${store.name}" ?`)) {
                                                                                    setStores(stores.filter(s => s.id !== store.id));
                                                                                }
                                                                            }}
                                                                            className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition"
                                                                        >
                                                                            🗑️
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    )}

                                    {/* --- ONGLET UTILISATEURS (Admin uniquement) --- */}
                                    {backOfficeTab === 'users' && (
                                        <div className="space-y-6">
                                            {!isAdmin() ? (
                                                <div className="bg-red-900/30 border border-red-700 rounded-lg p-6 text-center">
                                                    <div className="text-red-400 text-lg font-bold">🔒 Accès Refusé</div>
                                                    <div className="text-red-300 text-sm mt-2">Seuls les administrateurs peuvent gérer les utilisateurs</div>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="flex items-center justify-between">
                                                        <h3 className="text-2xl font-bold text-white">👨‍💼 Gestion des Utilisateurs & Permissions</h3>
                                                        <button 
                                                            onClick={() => {
                                                                const username = prompt('Nom d\'utilisateur :');
                                                                if (!username) return;
                                                                const password = prompt('Mot de passe :');
                                                                if (!password) return;
                                                                const fullName = prompt('Nom complet :');
                                                                if (!fullName) return;
                                                                const role = prompt('Rôle (admin ou employee) :');
                                                                if (role !== 'admin' && role !== 'employee') {
                                                                    alert('Rôle invalide');
                                                                    return;
                                                                }
                                                                
                                                                // Sélection de l'entité
                                                                let entityOptions = entities.map((e, i) => `${i + 1}. ${e.name} (${e.id})`).join('\n');
                                                                const entityChoice = prompt(`Choisir une entité (numéro) :\n${entityOptions}`);
                                                                if (!entityChoice || isNaN(entityChoice)) {
                                                                    alert('Choix invalide');
                                                                    return;
                                                                }
                                                                const selectedEntity = entities[parseInt(entityChoice) - 1];
                                                                if (!selectedEntity) {
                                                                    alert('Entité invalide');
                                                                    return;
                                                                }
                                                                
                                                                // Sélection du magasin (filtrés par entité)
                                                                const entityStores = stores.filter(s => s.entityId === selectedEntity.id);
                                                                if (entityStores.length === 0) {
                                                                    alert('Aucun magasin pour cette entité !');
                                                                    return;
                                                                }
                                                                let storeOptions = entityStores.map((s, i) => `${i + 1}. ${s.name} (${s.id})`).join('\n');
                                                                const storeChoice = prompt(`Choisir un magasin de ${selectedEntity.name} (numéro) :\n${storeOptions}`);
                                                                if (!storeChoice || isNaN(storeChoice)) {
                                                                    alert('Choix invalide');
                                                                    return;
                                                                }
                                                                const selectedStore = entityStores[parseInt(storeChoice) - 1];
                                                                if (!selectedStore) {
                                                                    alert('Magasin invalide');
                                                                    return;
                                                                }
                                                                
                                                                const newUser = {
                                                                    id: 'U' + String(users.length + 1).padStart(3, '0'),
                                                                    username,
                                                                    password,
                                                                    fullName,
                                                                    role,
                                                                    email: `${username}@caisse2.fr`,
                                                                    entityId: selectedEntity.id,
                                                                    storeId: selectedStore.id
                                                                };
                                                                setUsers([...users, newUser]);
                                                                alert(`Utilisateur créé avec succès pour le magasin "${selectedStore.name}"`);
                                                            }}
                                                            className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition"
                                                        >
                                                            ➕ Ajouter Utilisateur
                                                        </button>
                                                    </div>

                                                    {/* Liste des utilisateurs */}
                                                    <div className="bg-gray-700 p-6 rounded-lg border border-gray-600">
                                                        <h4 className="text-white font-bold text-lg mb-4">📋 Liste des Utilisateurs</h4>
                                                        <div className="space-y-3">
                                                            {users.map((user) => {
                                                                const userStore = stores.find(s => s.id === user.storeId);
                                                                const userEntity = entities.find(e => e.id === user.entityId);
                                                                return (
                                                                <div key={user.id} className="bg-gray-800 p-4 rounded-lg border border-gray-600 flex items-center justify-between">
                                                                    <div className="flex-1">
                                                                        <div className="flex items-center gap-3">
                                                                            <span className="text-white font-bold">{user.fullName}</span>
                                                                            <span className={`text-xs px-2 py-1 rounded ${user.role === 'admin' ? 'bg-purple-600 text-white' : 'bg-blue-600 text-white'}`}>
                                                                                {user.role === 'admin' ? 'Administrateur' : 'Vendeur'}
                                                                            </span>
                                                                        </div>
                                                                        <div className="text-sm text-gray-400 mt-1">
                                                                            👤 {user.username} | 📧 {user.email}
                                                                        </div>
                                                                        {userEntity && (
                                                                            <div className="text-sm text-purple-400 mt-1">
                                                                                🏢 {userEntity.name}
                                                                            </div>
                                                                        )}
                                                                        {userStore && (
                                                                            <div className="text-sm text-blue-400 mt-1">
                                                                                🏪 {userStore.name}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                    <div className="flex gap-2">
                                                                        <button 
                                                                            onClick={() => {
                                                                                const newPassword = prompt(`Nouveau mot de passe pour ${user.username} :`);
                                                                                if (newPassword) {
                                                                                    setUsers(users.map(u => u.id === user.id ? {...u, password: newPassword} : u));
                                                                                    alert('Mot de passe modifié');
                                                                                }
                                                                            }}
                                                                            className="px-3 py-1 bg-yellow-600 hover:bg-yellow-700 text-white text-sm rounded transition"
                                                                        >
                                                                            🔑 MDP
                                                                        </button>
                                                                        {users.length > 1 && (
                                                                            <button 
                                                                                onClick={() => {
                                                                                    if (confirm(`Supprimer ${user.fullName} ?`)) {
                                                                                        setUsers(users.filter(u => u.id !== user.id));
                                                                                    }
                                                                                }}
                                                                                className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition"
                                                                            >
                                                                                🗑️
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>

                                                    {/* Gestion des permissions */}
                                                    <div className="bg-gray-700 p-6 rounded-lg border border-gray-600">
                                                        <h4 className="text-white font-bold text-lg mb-4">🔐 Permissions par Rôle</h4>
                                                        <div className="space-y-6">
                                                            {['admin', 'employee'].map((role) => (
                                                                <div key={role} className="bg-gray-800 p-4 rounded-lg border border-gray-600">
                                                                    <h5 className="text-white font-semibold mb-3">
                                                                        {role === 'admin' ? '👑 Administrateur' : '👨‍💼 Employé (Vendeur)'}
                                                                    </h5>
                                                                    <div className="grid grid-cols-1 gap-2">
                                                                        {Object.keys(permissions[role]).map((section) => (
                                                                            <div key={section} className="flex items-center justify-between bg-gray-900 p-3 rounded">
                                                                                <span className="text-gray-300 text-sm capitalize">{section}</span>
                                                                                <div className="flex gap-4">
                                                                                    <label className="flex items-center gap-2 text-sm">
                                                                                        <input
                                                                                            type="checkbox"
                                                                                            checked={permissions[role][section].view}
                                                                                            onChange={(e) => {
                                                                                                setPermissions({
                                                                                                    ...permissions,
                                                                                                    [role]: {
                                                                                                        ...permissions[role],
                                                                                                        [section]: {
                                                                                                            ...permissions[role][section],
                                                                                                            view: e.target.checked
                                                                                                        }
                                                                                                    }
                                                                                                });
                                                                                            }}
                                                                                            className="w-4 h-4"
                                                                                        />
                                                                                        <span className="text-blue-400">👁️ Lecture</span>
                                                                                    </label>
                                                                                    <label className="flex items-center gap-2 text-sm">
                                                                                        <input
                                                                                            type="checkbox"
                                                                                            checked={permissions[role][section].edit}
                                                                                            onChange={(e) => {
                                                                                                setPermissions({
                                                                                                    ...permissions,
                                                                                                    [role]: {
                                                                                                        ...permissions[role],
                                                                                                        [section]: {
                                                                                                            ...permissions[role][section],
                                                                                                            edit: e.target.checked
                                                                                                        }
                                                                                                    }
                                                                                                });
                                                                                            }}
                                                                                            className="w-4 h-4"
                                                                                        />
                                                                                        <span className="text-green-400">✏️ Édition</span>
                                                                                    </label>
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    )}

                                    {/* --- ONGLET ÉTIQUETTES (Impression) --- */}
                                    {backOfficeTab === 'labels' && (
                                        <div className="space-y-6">
                                            <div>
                                                <h2 className="text-3xl font-bold text-white mb-6">📌 Impression d'Étiquettes</h2>
                                                
                                                {/* Sélection de produits */}
                                                <div className="bg-gray-800 rounded-lg border border-gray-700 p-6 mb-6">
                                                    <h3 className="text-xl font-bold text-white mb-4">📦 Sélectionner les articles</h3>
                                                    
                                                    <div className="mb-4 flex gap-2">
                                                        <button 
                                                            onClick={() => setSelectedProductsForLabels(products)}
                                                            className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded transition"
                                                        >
                                                            ✓ Tous les articles ({products.length})
                                                        </button>
                                                        <button 
                                                            onClick={() => setSelectedProductsForLabels([])}
                                                            className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded transition"
                                                        >
                                                            ✗ Désélectionner tous
                                                        </button>
                                                        <div className="ml-auto text-white">
                                                            Sélectionnés: <span className="font-bold text-yellow-400">{selectedProductsForLabels.length}</span>
                                                        </div>
                                                    </div>

                                                    <div className="space-y-2 max-h-64 overflow-y-auto bg-gray-900 p-4 rounded-lg">
                                                        {products.map(product => (
                                                            <div key={product.id} className="flex items-center gap-3 p-2 bg-gray-800 rounded hover:bg-gray-700 transition">
                                                                <input 
                                                                    type="checkbox"
                                                                    checked={selectedProductsForLabels.some(p => p.id === product.id)}
                                                                    onChange={(e) => {
                                                                        if (e.target.checked) {
                                                                            setSelectedProductsForLabels([...selectedProductsForLabels, product]);
                                                                            // Initialiser la quantité à 1 si non définie
                                                                            if (!labelQuantities[product.id]) {
                                                                                setLabelQuantities({...labelQuantities, [product.id]: 1});
                                                                            }
                                                                        } else {
                                                                            setSelectedProductsForLabels(selectedProductsForLabels.filter(p => p.id !== product.id));
                                                                        }
                                                                    }}
                                                                    className="w-5 h-5 cursor-pointer"
                                                                />
                                                                <span className="flex-1 text-white">{product.name}</span>
                                                                <span className="text-yellow-400 font-bold">{product.price}€</span>
                                                                <span className="text-gray-500 text-xs">{product.barcode || 'N/A'}</span>
                                                                {selectedProductsForLabels.some(p => p.id === product.id) && (
                                                                    <div className="flex items-center gap-2 bg-gray-700 px-2 py-1 rounded">
                                                                        <label className="text-gray-300 text-xs">Qté :</label>
                                                                        <input 
                                                                            type="number"
                                                                            value={labelQuantities[product.id] || 1}
                                                                            onChange={(e) => {
                                                                                const qty = Math.max(1, parseInt(e.target.value) || 1);
                                                                                setLabelQuantities({...labelQuantities, [product.id]: qty});
                                                                            }}
                                                                            min="1"
                                                                            max="999"
                                                                            className="w-12 px-2 py-1 bg-gray-600 border border-gray-500 rounded text-white text-sm text-center focus:outline-none"
                                                                        />
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>

                                                {/* Options d'impression */}
                                                <div className="grid grid-cols-2 gap-6 mb-6">
                                                    <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                        <h3 className="text-lg font-bold text-white mb-4">⚙️ Options d'impression</h3>
                                                        
                                                        <div className="space-y-4">
                                                            <div>
                                                                <label className="text-gray-300 font-semibold mb-2 block">Format d'étiquette</label>
                                                                <select 
                                                                    value={labelFormat}
                                                                    onChange={(e) => {
                                                                        setLabelFormat(e.target.value);
                                                                        if (e.target.value === 'custom') {
                                                                            setShowCustomFormat(true);
                                                                        }
                                                                    }}
                                                                    className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:outline-none focus:border-blue-500"
                                                                >
                                                                    <option value="50x25">50x25mm (Petit)</option>
                                                                    <option value="100x150">100x150mm (Standard)</option>
                                                                    <option value="4x6">4x6" (Grand)</option>
                                                                    <option value="custom">🎨 Personnalisé</option>
                                                                </select>
                                                            </div>

                                                            {labelFormat === 'custom' && (
                                                                <div className="bg-purple-900/30 p-4 rounded border border-purple-600 space-y-3">
                                                                    <div>
                                                                        <label className="text-gray-300 font-semibold text-sm mb-2 block">Largeur (mm)</label>
                                                                        <input 
                                                                            type="number"
                                                                            value={customLabelWidth}
                                                                            onChange={(e) => setCustomLabelWidth(Math.max(10, parseInt(e.target.value) || 100))}
                                                                            min="10"
                                                                            max="300"
                                                                            className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:outline-none focus:border-purple-500"
                                                                        />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-gray-300 font-semibold text-sm mb-2 block">Hauteur (mm)</label>
                                                                        <input 
                                                                            type="number"
                                                                            value={customLabelHeight}
                                                                            onChange={(e) => setCustomLabelHeight(Math.max(10, parseInt(e.target.value) || 150))}
                                                                            min="10"
                                                                            max="300"
                                                                            className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:outline-none focus:border-purple-500"
                                                                        />
                                                                    </div>
                                                                    <div className="text-xs text-purple-300 bg-purple-900/50 p-2 rounded">
                                                                        Format actuel: {customLabelWidth}mm × {customLabelHeight}mm
                                                                    </div>
                                                                </div>
                                                            )}

                                                            <div className="border-t border-gray-700 pt-4">
                                                                <label className="text-gray-300 font-semibold mb-3 block">📋 Contenu de l'étiquette</label>
                                                                <div className="space-y-2">
                                                                    <label className="flex items-center gap-3 cursor-pointer hover:bg-gray-700/50 p-2 rounded transition">
                                                                        <input 
                                                                            type="checkbox"
                                                                            checked={labelShowPrice}
                                                                            onChange={(e) => setLabelShowPrice(e.target.checked)}
                                                                            className="w-4 h-4 cursor-pointer"
                                                                        />
                                                                        <span className="text-sm text-gray-300">💰 Prix</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-3 cursor-pointer hover:bg-gray-700/50 p-2 rounded transition">
                                                                        <input 
                                                                            type="checkbox"
                                                                            checked={labelShowBarcode}
                                                                            onChange={(e) => setLabelShowBarcode(e.target.checked)}
                                                                            className="w-4 h-4 cursor-pointer"
                                                                        />
                                                                        <span className="text-sm text-gray-300">📦 Code-barre</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-3 cursor-pointer hover:bg-gray-700/50 p-2 rounded transition">
                                                                        <input 
                                                                            type="checkbox"
                                                                            checked={labelShowProductId}
                                                                            onChange={(e) => setLabelShowProductId(e.target.checked)}
                                                                            className="w-4 h-4 cursor-pointer"
                                                                        />
                                                                        <span className="text-sm text-gray-300">🆔 Référence</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-3 cursor-pointer hover:bg-gray-700/50 p-2 rounded transition">
                                                                        <input 
                                                                            type="checkbox"
                                                                            checked={labelShowCategory}
                                                                            onChange={(e) => setLabelShowCategory(e.target.checked)}
                                                                            className="w-4 h-4 cursor-pointer"
                                                                        />
                                                                        <span className="text-sm text-gray-300">🏷️ Catégorie</span>
                                                                    </label>
                                                                </div>
                                                            </div>

                                                            <div className="bg-blue-900/30 p-3 rounded border border-blue-600">
                                                                <div className="text-sm text-blue-300">
                                                                    📊 Articles : <strong>{selectedProductsForLabels.length}</strong> | Étiquettes : <strong>{selectedProductsForLabels.reduce((sum, p) => sum + (labelQuantities[p.id] || 1), 0)}</strong>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                        <h3 className="text-lg font-bold text-white mb-4">📥 Actions</h3>
                                                        
                                                        <div className="space-y-3">
                                                            <button 
                                                                onClick={() => printLabelsDirectly(expandProductsByQuantity(selectedProductsForLabels, labelQuantities), labelFormat, {
                                                                    showPrice: labelShowPrice,
                                                                    showBarcode: labelShowBarcode,
                                                                    showProductId: labelShowProductId,
                                                                    showCategory: labelShowCategory
                                                                })}
                                                                className="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded transition flex items-center justify-center gap-2"
                                                            >
                                                                🖨️ Imprimer directement
                                                            </button>
                                                            <button 
                                                                onClick={() => printLabelsAsPDF(expandProductsByQuantity(selectedProductsForLabels, labelQuantities), labelFormat, {
                                                                    showPrice: labelShowPrice,
                                                                    showBarcode: labelShowBarcode,
                                                                    showProductId: labelShowProductId,
                                                                    showCategory: labelShowCategory
                                                                })}
                                                                className="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded transition flex items-center justify-center gap-2"
                                                            >
                                                                📄 Télécharger PDF
                                                            </button>
                                                            <button 
                                                                onClick={() => {
                                                                    const options = {
                                                                        showPrice: labelShowPrice,
                                                                        showBarcode: labelShowBarcode,
                                                                        showProductId: labelShowProductId,
                                                                        showCategory: labelShowCategory
                                                                    };
                                                                    const expandedProducts = expandProductsByQuantity(selectedProductsForLabels, labelQuantities);
                                                                    const element = document.createElement('div');
                                                                    element.style.padding = '20px';
                                                                    element.style.backgroundColor = 'white';
                                                                    element.innerHTML = expandedProducts.map(p => generateLabelHTML(p, labelFormat, options)).join('');
                                                                    
                                                                    expandedProducts.forEach(product => {
                                                                        setTimeout(() => {
                                                                            if (window.JsBarcode && labelShowBarcode) {
                                                                                window.JsBarcode(`#barcode-${product.id}`, product.barcode || product.id, {
                                                                                    format: 'CODE128',
                                                                                    width: 2,
                                                                                    height: 40,
                                                                                    displayValue: false
                                                                                });
                                                                            }
                                                                        }, 50);
                                                                    });
                                                                    
                                                                    setTimeout(() => {
                                                                        const printWindow = window.open('', '', 'height=600,width=800');
                                                                        printWindow.document.write(element.innerHTML);
                                                                        printWindow.print();
                                                                    }, 300);
                                                                }}
                                                                className="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded transition"
                                                            >
                                                                👁️ Aperçu
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Historique d'impression */}
                                                <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
                                                    <h3 className="text-lg font-bold text-white mb-4">📋 Historique d'impression</h3>
                                                    
                                                    {labelHistory.length === 0 ? (
                                                        <div className="text-center text-gray-400 py-8">
                                                            Aucune impression enregistrée
                                                        </div>
                                                    ) : (
                                                        <div className="space-y-2 max-h-64 overflow-y-auto">
                                                            {[...labelHistory].reverse().map(record => (
                                                                <div key={record.id} className="flex justify-between items-center p-3 bg-gray-700 rounded">
                                                                    <div>
                                                                        <div className="text-white font-semibold">
                                                                            {record.productCount} étiquette(s) - Format {record.format}
                                                                        </div>
                                                                        <div className="text-xs text-gray-400">
                                                                            👤 {record.user} | 🏪 {record.store}
                                                                        </div>
                                                                        <div className="text-xs text-gray-500">
                                                                            📅 {new Date(record.date).toLocaleString('fr-FR')}
                                                                        </div>
                                                                    </div>
                                                                    <button 
                                                                        onClick={() => {
                                                                            setLabelHistory(labelHistory.filter(r => r.id !== record.id));
                                                                        }}
                                                                        className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition"
                                                                    >
                                                                        ✕
                                                                    </button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* --- ONGLET RAPPORTS --- */}
                                    {backOfficeTab === 'reports' && (
                                        <div className="space-y-4">
                                            <h3 className="text-lg font-bold text-white">Rapports de Vente</h3>
                                            <div className="grid grid-cols-3 gap-4">
                                                <div className="bg-green-900/30 p-4 rounded-lg border border-green-700">
                                                    <div className="text-sm text-gray-400">Total Articles</div>
                                                    <div className="text-3xl font-bold text-green-400">{MOCK_PRODUCTS.length}</div>
                                                </div>
                                                <div className="bg-blue-900/30 p-4 rounded-lg border border-blue-700">
                                                    <div className="text-sm text-gray-400">Fournisseurs</div>
                                                    <div className="text-3xl font-bold text-blue-400">{suppliers.length}</div>
                                                </div>
                                                <div className="bg-purple-900/30 p-4 rounded-lg border border-purple-700">
                                                    <div className="text-sm text-gray-400">Clients</div>
                                                    <div className="text-3xl font-bold text-purple-400">{clients.length}</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Footer */}
                                <div className="p-4 bg-gray-900 border-t border-gray-700 flex justify-end">
                                    <button 
                                        onClick={() => setIsBackOfficeOpen(false)}
                                        className="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-semibold transition"
                                    >Fermer</button>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<POS />);
    </script>
</body>
</html>
